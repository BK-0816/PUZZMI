<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç§ã®æƒ…å ± - PUZZMI</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <script type="module" src="nav.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body.bg-cream { 
      background: var(--bg-cream); 
      background-repeat: no-repeat; 
      background-size: cover; 
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    /* ë°°ê²½ ì¥ì‹ ìš”ì†Œ */
    .decorative-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .decorative-element {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.25;
      animation: float 10s ease-in-out infinite;
    }
    
    .decorative-element:nth-child(1) {
      width: 250px;
      height: 250px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      top: 15%;
      left: -5%;
      animation-delay: 0s;
    }
    
    .decorative-element:nth-child(2) {
      width: 200px;
      height: 200px;
      background: linear-gradient(45deg, #f093fb, #f5576c);
      top: 50%;
      right: -8%;
      animation-delay: 3s;
    }
    
    .decorative-element:nth-child(3) {
      width: 180px;
      height: 180px;
      background: linear-gradient(45deg, #4facfe, #00f2fe);
      bottom: 20%;
      left: 10%;
      animation-delay: 6s;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-25px) rotate(120deg); }
      66% { transform: translateY(15px) rotate(240deg); }
    }
    
    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .profile-wrap { 
      max-width: 1000px; 
      margin: 40px auto; 
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }
    
    /* í˜ì´ì§€ í—¤ë” */
    .page-header {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 28px;
      padding: 40px;
      margin-bottom: 32px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
      text-align: center;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
      animation: shimmer 3s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .page-header h2 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 30%, #f093fb 70%, #f5576c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 16px 0;
      letter-spacing: -0.02em;
      position: relative;
    }
    
    .page-header h2::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #f093fb 100%);
      border-radius: 2px;
    }
    
    .page-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      line-height: 1.6;
      margin: 0;
      font-weight: 500;
    }
    
    /* ì„¹ì…˜ ì¹´ë“œ */
    .section-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.06), 0 6px 16px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .section-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 33%, #f093fb 66%, #f5576c 100%);
      opacity: 0.8;
    }
    
    .section-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 24px 60px rgba(0,0,0,0.1), 0 8px 24px rgba(0,0,0,0.06);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    .section-card:hover::before {
      opacity: 1;
      height: 4px;
    }
    
    /* ì„¹ì…˜ ì œëª© */
    .section-title {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 24px 0;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .section-title::before {
      content: '';
      width: 5px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
      border-radius: 3px;
      flex-shrink: 0;
    }
    
    /* í¼ ê·¸ë¦¬ë“œ */
    .form-grid {
      display: grid;
      gap: 24px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .form-row.single {
      grid-template-columns: 1fr;
    }
    
    .form-field {
      position: relative;
    }
    
    .form-label {
      display: block;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 0.95rem;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(8px);
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.5);
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.95) 100%);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), inset 0 2px 12px rgba(0,0,0,0.06);
      transform: translateY(-2px);
    }
    
    .form-textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.6;
    }
    
    .form-input::placeholder, .form-textarea::placeholder {
      color: rgba(102, 126, 234, 0.5);
      font-style: italic;
    }
    
    /* ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(240, 147, 251, 0.03) 100%);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      backdrop-filter: blur(8px);
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.6) 100%);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 8px;
      transition: all 0.3s ease;
      backdrop-filter: blur(6px);
    }
    
    .checkbox-item:hover {
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 6px;
      background: white;
      cursor: pointer;
      position: relative;
      appearance: none;
      transition: all 0.3s ease;
    }
    
    .checkbox-item input[type="checkbox"]:checked {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .checkbox-item input[type="checkbox"]:checked::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: 800;
      font-size: 12px;
    }
    
    .checkbox-label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
    }
    
    /* ë²„íŠ¼ */
    .btn {
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.95rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      color: white;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      color: var(--text-primary);
      border: 2px solid rgba(102, 126, 234, 0.2);
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 100%);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 8px 20px rgba(240, 147, 251, 0.3);
    }
    
    .btn-danger:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 12px 28px rgba(240, 147, 251, 0.4);
    }
    
    /* LINE ì—°ë™ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .btn-line {
      background: linear-gradient(135deg, #00C300 0%, #00B900 100%);
      color: white;
      box-shadow: 0 8px 20px rgba(0, 195, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-line:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 12px 28px rgba(0, 195, 0, 0.4);
    }
    
    .btn-line:disabled {
      opacity: 0.6;
      transform: none;
      cursor: not-allowed;
    }
    
    .line-connection-section {
      background: linear-gradient(135deg, rgba(0, 195, 0, 0.05) 0%, rgba(0, 185, 0, 0.03) 100%);
      border: 2px solid rgba(0, 195, 0, 0.2);
      border-radius: 16px;
      padding: 24px;
      backdrop-filter: blur(8px);
    }
    
    .line-status-connected {
      background: linear-gradient(135deg, #d1f2eb 0%, #a3e4d7 100%);
      color: #0e6b47;
      border-color: rgba(25, 135, 84, 0.3);
    }
    
    .line-status-disconnected {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border-color: rgba(255, 193, 7, 0.3);
    }
    
    /* ì•¡ì…˜ ê·¸ë£¹ */
    .action-group {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    /* ë©”ì‹œì§€ */
    .success {
      background: linear-gradient(135deg, #d1f2eb 0%, #a3e4d7 100%);
      color: #0e6b47;
      padding: 16px 20px;
      border-radius: 12px;
      border: 2px solid rgba(25, 135, 84, 0.3);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
      margin-top: 16px;
    }
    
    .error {
      background: linear-gradient(135deg, #fadbd8 0%, #f1948a 100%);
      color: #922b21;
      padding: 16px 20px;
      border-radius: 12px;
      border: 2px solid rgba(220, 53, 69, 0.3);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
      margin-top: 16px;
    }
    
    .help-text {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.03) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
      padding: 12px 16px;
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
      margin-top: 8px;
    }
    
    /* í”„ë¡œí•„ ì™„ì„±ë„ */
    .completion-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(240, 147, 251, 0.05) 100%);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 32px;
      text-align: center;
    }
    
    .completion-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    
    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(255,255,255,0.6);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 12px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: progress-shine 2s ease-in-out infinite;
    }
    
    @keyframes progress-shine {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .progress-text {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    /* ì•„ë°”íƒ€ ì—…ë¡œë“œ */
    .avatar-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .avatar-container {
      position: relative;
      width: 120px;
      height: 120px;
    }
    
    .avatar-image {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(255,255,255,0.8);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    
    .avatar-image:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(0,0,0,0.2);
    }
    
    .avatar-upload-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: 3px solid white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .avatar-upload-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    
    .avatar-upload-input {
      display: none;
    }
    
    /* ê³„ì • ìƒíƒœ */
    .account-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(240, 147, 251, 0.05) 100%);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      margin-bottom: 24px;
    }
    
    .status-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 700;
    }
    
    .status-active {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }
    
    .status-pending {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
      color: white;
    }
    
    .status-text {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      .profile-wrap {
        margin: 20px auto;
        padding: 0 16px;
      }
      
      .page-header {
        padding: 24px;
        border-radius: 20px;
      }
      
      .page-header h2 {
        font-size: 2rem;
      }
      
      .section-card {
        padding: 24px;
        border-radius: 20px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .action-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-cream">
  <!-- ë°°ê²½ ì¥ì‹ ìš”ì†Œ -->
  <div class="decorative-bg">
    <div class="decorative-element"></div>
    <div class="decorative-element"></div>
    <div class="decorative-element"></div>
  </div>

  <div id="app-nav"></div>
  
  <main class="profile-wrap">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <section class="page-header">
      <h2>ç§ã®æƒ…å ±</h2>
      <p class="page-subtitle">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ä¿®æ­£ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç®¡ç†ã—ã¦ãã ã•ã„</p>
    </section>

    <!-- í”„ë¡œí•„ ì™„ì„±ë„ -->
    <section class="completion-card">
      <div class="completion-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å®Œæˆåº¦</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">0% å®Œæˆ</div>
    </section>

    <!-- ê³„ì • ìƒíƒœ -->
    <section class="account-status" id="accountStatus">
      <div class="status-icon status-active">âœ“</div>
      <div class="status-text">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰åŠ¹åŒ–</div>
    </section>

    <!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
    <section class="section-card">
      <h3 class="section-title">ğŸ‘¤ åŸºæœ¬æƒ…å ±</h3>
      
      <form id="basicInfoForm" class="form-grid">
        <div class="form-row">
          <div class="form-field">
            <label class="form-label" for="fullName">åå‰</label>
            <input class="form-input" type="text" id="fullName" placeholder="Yuki Tanaka"/>
          </div>
          <div class="form-field">
            <label class="form-label" for="birthDate">ç”Ÿå¹´æœˆæ—¥</label>
            <input class="form-input" type="date" id="birthDate"/>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-field">
            <label class="form-label" for="gender">æ€§åˆ¥</label>
            <select class="form-select" id="gender">
              <option value="ì—¬ì„±">å¥³æ€§</option>
              <option value="ë‚¨ì„±">ç”·æ€§</option>
            </select>
          </div>
          <div class="form-field">
            <label class="form-label" for="phoneNumber">é›»è©±ç•ªå·</label>
            <input class="form-input" type="tel" id="phoneNumber" placeholder="080-0000-0000"/>
          </div>
        </div>
        
        <div class="action-group">
          <button class="btn btn-primary" type="submit">ğŸ’¾ åŸºæœ¬æƒ…å ±ä¿å­˜</button>
          <div id="basicInfoResult"></div>
        </div>
      </form>
    </section>

    <!-- ìƒì„¸ ì •ë³´ ì„¹ì…˜ -->
    <section class="section-card">
      <h3 class="section-title">ğŸŒ è©³ç´°æƒ…å ±</h3>
      <form id="detailInfoForm" class="form-grid">
        <div class="form-row">
          <div class="form-field">
            <label class="form-label" for="nationality">å›½ç±</label>
            <select class="form-select" id="nationality">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="í•œêµ­">ğŸ‡°ğŸ‡· éŸ“å›½</option>
              <option value="ì¼ë³¸">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
              <option value="ì¤‘êµ­">ğŸ‡¨ğŸ‡³ ä¸­å›½</option>
              <option value="ë¯¸êµ­">ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«</option>

            </select>
          </div>
          <div class="form-field">
            <label class="form-label" for="residence">í˜„ì¬ ê±°ì£¼ì§€</label>
            <input class="form-input" type="text" id="residence" placeholder="ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬"/>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-field">
            <label class="form-label" for="occupation">è·æ¥­</label>
            <input class="form-input" type="text" id="occupation" placeholder="ä¼šç¤¾å“¡"/>
          </div>
        </div>
        
        <div class="form-row single">
          <div class="form-field">
            <label class="form-label" for="selfIntroduction">è‡ªå·±ç´¹ä»‹</label>
            <textarea class="form-textarea" id="selfIntroduction" placeholder="ç°¡å˜ãªè‡ªå·±ç´¹ä»‹ã‚’ãŠæ›¸ããã ã•ã„..."></textarea>
          </div>
        </div>
        
        <div class="form-row single">
          <div class="form-field">
            <label class="form-label">ì‚¬ìš© ê°€ëŠ¥í•œ ì–¸ì–´</label>
            <div class="checkbox-group" id="languageGroup">
              <label class="checkbox-item">
                <input type="checkbox" value="í•œêµ­ì–´"/>
                <span class="checkbox-label">ğŸ‡°ğŸ‡· í•œêµ­ì–´</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="æ—¥æœ¬èª"/>
                <span class="checkbox-label">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="English"/>
                <span class="checkbox-label">ğŸ‡ºğŸ‡¸ English</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="ä¸­æ–‡"/>
                <span class="checkbox-label">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</span>
              </label>
            </div>
            <div class="help-text">ãƒ¡ã‚¤ãƒˆã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¯èƒ½ãªè¨€èªã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>
        </div>
        
        <div class="form-row single">
          <div class="form-field">
            <label class="form-label">é–¢å¿ƒäº‹</label>
            <div class="checkbox-group" id="interestsGroup">
              <label class="checkbox-item">
                <input type="checkbox" value="ë§›ì§‘ íƒë°©"/>
                <span class="checkbox-label">ğŸ½ï¸ ã‚°ãƒ«ãƒ¡æ¢è¨ª</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="ì¹´í˜ íˆ¬ì–´"/>
                <span class="checkbox-label">â˜• ã‚«ãƒ•ã‚§ãƒ„ã‚¢ãƒ¼</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="ì‡¼í•‘"/>
                <span class="checkbox-label">ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="ë¬¸í™” ì²´í—˜"/>
                <span class="checkbox-label">ğŸ­ æ–‡åŒ–ä½“é¨“</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="ì•¼ê²½ íˆ¬ì–´"/>
                <span class="checkbox-label">ğŸŒƒ å¤œæ™¯ãƒ„ã‚¢ãƒ¼</span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" value="K-POP"/>
                <span class="checkbox-label">ğŸµ K-POP</span>
              </label>
            </div>
            <div class="help-text">é–¢å¿ƒã®ã‚ã‚‹æ´»å‹•ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>
        </div>
        
        <div class="action-group">
          <button class="btn btn-primary" type="submit">ğŸš€ è©³ç´°æƒ…å ±ä¿å­˜</button>
          <div id="detailInfoResult"></div>
        </div>
      </form>
    </section>

    <!-- ê³„ì • ê´€ë¦¬ ì„¹ì…˜ -->
    <section class="section-card">
      <h3 class="section-title">ğŸ” ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</h3>
      
      <!-- LINE ì—°ë™ ê´€ë¦¬ -->
      <div class="line-connection-section" style="margin-bottom: 32px;">
        <h4 style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
          <i class="fab fa-line" style="color: #00C300;"></i>
          LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£å‹•

        </h4>

        <div id="lineConnectionStatus" class="help-text" style="margin-bottom: 16px;">
          é€£å‹•çŠ¶æ…‹ã‚’ç¢ºèªä¸­...
        </div>

        <div class="action-group" id="lineActions">
          <!-- ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
      </div>

      <!-- ì‹ ì›ì¸ì¦ ê´€ë¦¬ -->
      <div class="identity-verification-section" style="margin-bottom: 32px; padding: 24px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-radius: 16px; border: 2px solid rgba(102, 126, 234, 0.1);">
        <h4 style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-id-card" style="color: #667eea;"></i>
          æœ¬äººèªè¨¼
        </h4>

        <div id="identityVerificationStatus" class="help-text" style="margin-bottom: 16px;">
          èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...
        </div>

        <div class="action-group" id="identityVerificationActions">
          <!-- ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
      </div>
      
      <!-- ì´ë©”ì¼ ë³€ê²½ -->
      <form id="emailForm" class="form-grid">
        <div class="form-row single">
          <div class="form-field">
            <label class="form-label" for="currentEmail">ç¾åœ¨ã®Eãƒ¡ãƒ¼ãƒ«</label>
            <input class="form-input" type="email" id="currentEmail" readonly style="background: rgba(0,0,0,0.05); cursor: not-allowed;"/>
          </div>
        </div>
        
        <div class="action-group">
          <button class="btn btn-secondary" type="button" onclick="alert('ãƒ¡ãƒ¼ãƒ«ã®å¤‰æ›´ã¯ã€ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚')">
            ğŸ“§ Eãƒ¡ãƒ¼ãƒ«ã®å¤‰æ›´ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›
          </button>
        </div>
      </form>
      
      <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
      <form id="passwordForm" class="form-grid" style="margin-top: 32px;">
        <div class="form-row">
          <div class="form-field">
            <label class="form-label" for="newPassword">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input class="form-input" type="password" id="newPassword" minlength="8" placeholder="8æ–‡å­—ä»¥ä¸Šå…¥åŠ›"/>
          </div>
          <div class="form-field">
            <label class="form-label" for="confirmPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
            <input class="form-input" type="password" id="confirmPassword" minlength="8" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†å…¥åŠ›"/>
          </div>
        </div>
        
        <div class="action-group">
          <button class="btn btn-primary" type="submit">ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
          <div id="passwordResult"></div>
        </div>
      </form>
    </section>

    <!-- ê³„ì • ì‚­ì œ ì„¹ì…˜ -->
    <section class="section-card">
      <h3 class="section-title">âš ï¸ ä¼šå“¡è„±é€€</h3>
      <div class="help-text" style="margin-bottom: 20px;">
        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ°¸ä¹…ã«å‰Šé™¤ã•ã‚Œã€å›å¾©ã§ãã¾ã›ã‚“ã€‚
      </div>
      
      <div class="action-group">
        <button class="btn btn-danger" type="button" onclick="confirmAccountDeletion()">
          ğŸ—‘ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
        </button>
      </div>
    </section>
  </main>

<script type="module">
  import { supabase, SUPABASE_URL } from './nav.js';
  const EDGE_COMPLETE_URL = `${SUPABASE_URL}/functions/v1/line-auth/complete-auth`;
  
  (async () => {

    // ë¡œê·¸ì¸ ì²´í¬
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      const redir = encodeURIComponent('my_profile.html');
      location.replace(`auth_combo.html?redirect=${redir}`);
      throw new Error('login required');
    }

    // DOM ìš”ì†Œë“¤
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const accountStatus = document.getElementById('accountStatus');

    // í¼ ìš”ì†Œë“¤
    const fullNameEl = document.getElementById('fullName');
    const birthDateEl = document.getElementById('birthDate');
    const genderEl = document.getElementById('gender');
    const phoneNumberEl = document.getElementById('phoneNumber');
    const nationalityEl = document.getElementById('nationality');
    const residenceEl = document.getElementById('residence');
    const occupationEl = document.getElementById('occupation');
    const currentEmailEl = document.getElementById('currentEmail');

    // ê²°ê³¼ ë©”ì‹œì§€ ìš”ì†Œë“¤
    const basicInfoResult = document.getElementById('basicInfoResult');
    const detailInfoResult = document.getElementById('detailInfoResult');
    const passwordResult = document.getElementById('passwordResult');

    // í”„ë¡œí•„ ì™„ì„±ë„ ê³„ì‚°
    function calculateCompletion(profile) {
      const fields = [
        profile.full_name,
        profile.birth_date,
        profile.gender,
        profile.phone_number,
        profile.nationality,
        profile.residence,
        profile.occupation,
        profile.languages && profile.languages.length > 0,
        profile.interests && profile.interests.length > 0
      ];
      
      const completed = fields.filter(Boolean).length;
      return Math.round((completed / fields.length) * 100);
    }

    // LINE ì—°ë™ ìƒíƒœ í™•ì¸ ë° UI ì—…ë°ì´íŠ¸
    async function checkLineConnection() {
      const statusEl = document.getElementById('lineConnectionStatus');
      const actionsEl = document.getElementById('lineActions');
      
      try {
        const { data: lineAccount, error } = await supabase
          .from('user_line_accounts')
          .select('*')
          .eq('user_id', user.id)
          .maybeSingle();
        
        if (error) throw error;
        
        if (lineAccount && lineAccount.is_verified) {
          // ì—°ë™ë¨
          statusEl.className = 'help-text line-status-connected';
          statusEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-check-circle" style="color: #28a745;"></i>
              <strong>LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒé€£å‹•ã—ã¦ã„ã¾ã™</strong>
            </div>
            <div style="font-size: 0.9rem;">
              é€£å‹•ã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: ${lineAccount.line_display_name || 'ì‚¬ìš©ì'}<br>
              é€£å‹•æ—¥: ${lineAccount.connected_at ? new Date(lineAccount.connected_at).toLocaleDateString('ko-KR') : '-'}
            </div>
          `;
          
          actionsEl.innerHTML = `
            <button class="btn btn-danger" id="disconnectLineBtn">
              <i class="fab fa-line"></i>
              LINEé€£å‹•è§£é™¤
            </button>
          `;
          
          // ì—°ë™ í•´ì œ ì´ë²¤íŠ¸
          document.getElementById('disconnectLineBtn').addEventListener('click', disconnectLine);
          
        } else {
          // ì—°ë™ ì•ˆë¨
          statusEl.className = 'help-text line-status-disconnected';
          statusEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
              <strong>LINE ê³„ì •ì´ ì—°ë™ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</strong>
            </div>
            <div style="font-size: 0.9rem;">
              ì˜ˆì•½ í™•ì • ë° ê²°ì œ ì•ˆë‚´ë¥¼ ë°›ìœ¼ë ¤ë©´ LINE ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </div>
          `;
          
          actionsEl.innerHTML = `
            <button class="btn btn-line" id="connectLineBtn">
              <i class="fab fa-line"></i>
              LINE ê³„ì • ì—°ë™í•˜ê¸°
            </button>
          `;
          
          // ì—°ë™ ì´ë²¤íŠ¸
          document.getElementById('connectLineBtn').addEventListener('click', connectLine);
        }
        
      } catch (error) {
        console.error('LINE ì—°ë™ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
        statusEl.className = 'help-text error';
        statusEl.textContent = 'LINE ì—°ë™ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      }
    }

    // LINE ì—°ë™ í•¨ìˆ˜
    async function connectLine() {
      const btn = document.getElementById('connectLineBtn');
      const statusEl = document.getElementById('lineConnectionStatus');
      
      // ì‚¬ìš©ì í´ë¦­ê³¼ ë™ì‹œì— ì¦‰ì‹œ íŒì—… ì—´ê¸° (ë¸Œë¼ìš°ì € ì°¨ë‹¨ ë°©ì§€)
      const popup = window.open('about:blank', 'lineLogin', 'width=500,height=600,scrollbars=yes,resizable=yes');
      
      if (!popup) {
        showToast('âŒ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<div class="loading"></div> ì—°ë™ ì¤‘...';
      
      try {
        // ì‹¤ì œ LINE OAuth URL ìƒì„±
        console.log('ğŸ”— ì‹¤ì œ LINE OAuth URL ìƒì„± ì‹œì‘');
        
        // Edge Functionì„ í†µí•œ LINE URL ìƒì„±
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          throw new Error('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        }
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/line-auth/generate-url`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
            'Origin': window.location.origin,
            'Referer': window.location.href
          },
          body: JSON.stringify({ 
            requestOrigin: window.location.origin
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Edge Function í˜¸ì¶œ ì‹¤íŒ¨:', {
            status: response.status,
            error: errorText
          });
          throw new Error(`Edge Function í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'LINE URL ìƒì„± ì‹¤íŒ¨');
        }
        
        const lineUrl = result.loginUrl;
        console.log('âœ… ì‹¤ì œ LINE URL ìƒì„± ì„±ê³µ:', lineUrl);
        
        // íŒì—…ì„ ì‹¤ì œ LINE OAuth URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        popup.location.href = lineUrl;
        
        // íŒì—… ì™„ë£Œ ëŒ€ê¸°
        const checkAuth = setInterval(async () => {
          if (popup && popup.closed) {
            clearInterval(checkAuth);
            console.log('íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ì—°ë™ ìƒíƒœ í™•ì¸ ì¤‘...');
            // ì ì‹œ ëŒ€ê¸° í›„ ìƒíƒœ í™•ì¸
            setTimeout(async () => {
              await checkLineConnection();
              btn.disabled = false;
              btn.innerHTML = '<i class="fab fa-line"></i> LINE ê³„ì • ì—°ë™í•˜ê¸°';
            }, 1000);
          }
        }, 1000);
        
        // ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì½œë°±ì—ì„œ ì˜¤ëŠ” ë©”ì‹œì§€ ì²˜ë¦¬)
        const messageHandler = async (event) => {
          const data = event.data;
          if (!data || typeof data !== 'object') return;

          // ì‹œë®¬ë ˆì´ì…˜ ì„±ê³µ ì²˜ë¦¬
          if (data.type === 'LINE_AUTH_SUCCESS') {
            console.log('LINE ì—°ë™ ì„±ê³µ ë©”ì‹œì§€ ë°›ìŒ:', data);

            // Bot ì¹œêµ¬ ì¶”ê°€ ì•ˆë‚´ ëª¨ë‹¬ í‘œì‹œ
            if (data.addFriend) {
              showAddBotFriendModal();
            } else {
              showToast('âœ… LINE ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }

            await checkLineConnection();
            if (popup && !popup.closed) popup.close();
            window.removeEventListener('message', messageHandler);
            return;
          }
          
          if (data.type === 'LINE_AUTH_ERROR') {
            console.error('LINE ì—°ë™ ì‹¤íŒ¨ ë©”ì‹œì§€ ë°›ìŒ:', data);
            showToast('âŒ LINE ì—°ë™ ì‹¤íŒ¨: ' + data.error);
            if (popup && !popup.closed) popup.close();
            window.removeEventListener('message', messageHandler);
            return;
          }
        };
        
        window.addEventListener('message', messageHandler);
        
      } catch (error) {
        console.error('LINE ì—°ë™ ì˜¤ë¥˜:', error);
        if (popup && !popup.closed) {
          popup.close();
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="fab fa-line"></i> LINE ê³„ì • ì—°ë™í•˜ê¸°';
        showToast('âŒ LINE ì—°ë™ ì˜¤ë¥˜: ' + error.message);
      }
    }

    // LINE ì—°ë™ í•´ì œ í•¨ìˆ˜
    async function disconnectLine() {
      if (!confirm('ì •ë§ë¡œ LINE ì—°ë™ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì—°ë™ì„ í•´ì œí•˜ë©´ ì˜ˆì•½ ê´€ë ¨ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }
      
      const btn = document.getElementById('disconnectLineBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading"></div> í•´ì œ ì¤‘...';
      
      try {
        // LINE ê³„ì • ì •ë³´ ì‚­ì œ
        const { error: lineError } = await supabase
          .from('user_line_accounts')
          .delete()
          .eq('user_id', user.id);
        
        if (lineError) throw lineError;
        
        // ì¸ì¦ ìƒíƒœ ì‚­ì œ
        await supabase
          .from('user_verifications')
          .delete()
          .eq('user_id', user.id)
          .eq('verification_type', 'line');
        
        showToast('ğŸ’” LINE ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        await checkLineConnection(); // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
        
      } catch (error) {
        console.error('LINE ì—°ë™ í•´ì œ ì‹¤íŒ¨:', error);
        showToast('âŒ LINE ì—°ë™ í•´ì œ ì‹¤íŒ¨: ' + error.message);
        
        btn.disabled = false;
        btn.innerHTML = '<i class="fab fa-line"></i> LINE ì—°ë™ í•´ì œ';
      }
    }

    // í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ
    async function loadProfile() {
      try {
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        if (error) throw error;

        // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
        fullNameEl.value = profile.full_name || '';
        birthDateEl.value = profile.birth_date || '';
        genderEl.value = profile.gender || '';
        phoneNumberEl.value = profile.phone_number || '';
        nationalityEl.value = profile.nationality || '';
        residenceEl.value = profile.residence || '';
        occupationEl.value = profile.occupation || '';
        currentEmailEl.value = user.email || '';

        // ì–¸ì–´ ì²´í¬ë°•ìŠ¤
        const languages = Array.isArray(profile.languages) ? profile.languages : [];
        document.querySelectorAll('#languageGroup input[type="checkbox"]').forEach(cb => {
          cb.checked = languages.includes(cb.value);
        });

        // ê´€ì‹¬ì‚¬ ì²´í¬ë°•ìŠ¤
        const interests = Array.isArray(profile.interests) ? profile.interests : [];
        document.querySelectorAll('#interestsGroup input[type="checkbox"]').forEach(cb => {
          cb.checked = interests.includes(cb.value);
        });

        // í”„ë¡œí•„ ì™„ì„±ë„ ì—…ë°ì´íŠ¸
        const completion = calculateCompletion(profile);
        progressFill.style.width = completion + '%';
        progressText.textContent = completion + '% å®Œæˆ';

        // ê³„ì • ìƒíƒœ ì—…ë°ì´íŠ¸
        const statusIcon = accountStatus.querySelector('.status-icon');
        const statusText = accountStatus.querySelector('.status-text');
        
        if (profile.account_status === 'active') {
          statusIcon.className = 'status-icon status-active';
          statusIcon.textContent = 'âœ“';
          statusText.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰åŠ¹åŒ–';
        } else {
          statusIcon.className = 'status-icon status-pending';
          statusIcon.textContent = 'â³';
          statusText.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œè¨ä¸­';
        }

      } catch (error) {
        console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);
        basicInfoResult.innerHTML = `<div class="error">âŒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${error.message}</div>`;
      }
    }

    // ê¸°ë³¸ ì •ë³´ ì €ì¥
    document.getElementById('basicInfoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading"></div> è²¯è”µä¸­...';
      
      try {
        // ìƒë…„ì›”ì¼ì—ì„œ ë‚˜ì´ ê³„ì‚°
        let age = null;
        if (birthDateEl.value) {
          const today = new Date();
          const birthDate = new Date(birthDateEl.value);
          age = today.getFullYear() - birthDate.getFullYear();
          const monthDiff = today.getMonth() - birthDate.getMonth();
          if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
          }
        }

        const updateData = {
          id: user.id,
          full_name: fullNameEl.value.trim() || null,
          birth_date: birthDateEl.value || null,
          age: age,
          gender: genderEl.value || null,
          phone_number: phoneNumberEl.value.trim() || null,
          updated_at: new Date().toISOString()
        };

        const { error } = await supabase
          .from('profiles')
          .upsert(updateData, { onConflict: 'id' });

        if (error) throw error;

        basicInfoResult.innerHTML = '<div class="success">âœ… åŸºæœ¬æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼</div>';
        await loadProfile(); // ì™„ì„±ë„ ì—…ë°ì´íŠ¸

      } catch (error) {
        console.error('ê¸°ë³¸ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
        basicInfoResult.innerHTML = `<div class="error">âŒ è²¯è”µå¤±æ•—: ${error.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ğŸ’¾ åŸºæœ¬æƒ…å ±ä¿å­˜';
      }
    });

    // ìƒì„¸ ì •ë³´ ì €ì¥
    document.getElementById('detailInfoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading"></div> è²¯è”µä¸­...';
      
      try {
        // ì„ íƒëœ ì–¸ì–´ë“¤ ìˆ˜ì§‘
        const selectedLanguages = Array.from(document.querySelectorAll('#languageGroup input[type="checkbox"]:checked'))
          .map(cb => cb.value);

        // ì„ íƒëœ ê´€ì‹¬ì‚¬ë“¤ ìˆ˜ì§‘
        const selectedInterests = Array.from(document.querySelectorAll('#interestsGroup input[type="checkbox"]:checked'))
          .map(cb => cb.value);

        const updateData = {
          id: user.id,
          nationality: nationalityEl.value || null,
          residence: residenceEl.value.trim() || null,
          languages: selectedLanguages.length > 0 ? selectedLanguages : null,
          interests: selectedInterests.length > 0 ? selectedInterests : null,
          updated_at: new Date().toISOString()
        };

        const { error } = await supabase
          .from('profiles')
          .upsert(updateData, { onConflict: 'id' });

        if (error) throw error;

        detailInfoResult.innerHTML = '<div class="success">âœ… è©³ç´°æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼</div>';
        await loadProfile(); // ì™„ì„±ë„ ì—…ë°ì´íŠ¸

      } catch (error) {
        console.error('ìƒì„¸ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
        detailInfoResult.innerHTML = `<div class="error">âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ğŸš€ è©³ç´°æƒ…å ±ä¿å­˜';
      }
    });

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      
      if (newPassword !== confirmPassword) {
        passwordResult.innerHTML = '<div class="error">âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚</div>';
        return;
      }
      
      if (newPassword.length < 8) {
        passwordResult.innerHTML = '<div class="error">âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ 8 æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</div>';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading"></div> å¤‰æ›´ä¸­...';
      
      try {
        const { error } = await supabase.auth.updateUser({
          password: newPassword
        });

        if (error) throw error;

        passwordResult.innerHTML = '<div class="success">âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼</div>';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';

      } catch (error) {
        console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:', error);
        passwordResult.innerHTML = `<div class="error">âŒ å¤‰æ›´å¤±æ•—: ${error.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´';
      }
    });

    // ê³„ì • ì‚­ì œ í™•ì¸
    window.confirmAccountDeletion = function() {
      const confirmText = 'æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®ã‚¿ã‚¹ã‚¯ã¯å…ƒã«æˆ»ã™ã“ã¨ã¯ã§ããšã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ°¸ä¹…ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\nç¶šè¡Œã™ã‚‹ã«ã¯ã€"å‰Šé™¤"ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      const userInput = prompt(confirmText);
      
      if (userInput === 'å‰Šé™¤') {
        deleteAccount();
      } else if (userInput !== null) {
        alert('å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚');
      }
    };

    // ê³„ì • ì‚­ì œ ì‹¤í–‰ (ì£¼ì˜: í´ë¼ì´ì–¸íŠ¸ anon keyë¡œëŠ” admin API ë¶ˆê°€)
    async function deleteAccount() {
      try {
        // ì´ í˜¸ì¶œì€ anon í‚¤ë¡œëŠ” ì‹¤íŒ¨í•©ë‹ˆë‹¤. Edge Function(ì„œë¹„ìŠ¤ ë¡¤ í‚¤)ë¡œ ê°ì‹¸ì„œ ì„œë²„ì—ì„œ ìˆ˜í–‰í•˜ì„¸ìš”.
        const { error } = await supabase.auth.admin.deleteUser(user.id);
        if (error) throw error;
        alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚');
        location.href = 'index.html';
      } catch (error) {
        console.error('ê³„ì • ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å¤±æ•—: ' + error.message);
      }
    }

    // ì‹œë®¬ë ˆì´ì…˜ URL ìƒì„± í•¨ìˆ˜
    function generateSimulationUrl(userId) {
      const params = new URLSearchParams({
        simulation: 'true',
        userId: userId,
        timestamp: Date.now(),
        success: 'true'
      });
      
      return `${window.location.origin}/line_callback.html?${params.toString()}`;
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white; padding: 12px 24px; border-radius: 12px;
        z-index: 9999; font-weight: 600; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        animation: slideDown 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Bot ì¹œêµ¬ ì¶”ê°€ ì•ˆë‚´ ëª¨ë‹¬
    function showAddBotFriendModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); display: flex; align-items: center;
        justify-content: center; z-index: 10000; animation: fadeIn 0.3s;
      `;
      modal.innerHTML = `
        <div style="background: white; padding: 32px; border-radius: 20px; max-width: 480px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 3.5rem; margin-bottom: 16px;">ğŸ‰</div>
            <h3 style="font-size: 1.5rem; font-weight: 800; color: #333; margin-bottom: 8px;">LINEé€£å‹•å®Œäº†ï¼</h3>
            <p style="color: #666; font-size: 0.95rem; line-height: 1.6;">
              ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯<br>
              <strong style="color: #00C300;">PUZZMI Bot</strong>ã‚’å‹ã ã¡è¿½åŠ ã—ã¦ãã ã•ã„
            </p>
          </div>

          <div style="background: linear-gradient(135deg, #00C300 0%, #00B900 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
            <a href="https://line.me/R/ti/p/@652ldrjn" target="_blank"
               style="display: inline-block; background: white; color: #00C300; padding: 14px 28px; border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 1.05rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s;">
              <i class="fab fa-line"></i> PUZZMI Bot å‹ã ã¡è¿½åŠ 
            </a>
            <div style="margin-top: 12px; font-size: 0.85rem; color: white; opacity: 0.9;">
              ã¾ãŸã¯ IDæ¤œç´¢: <code style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-weight: 700;">@652ldrjn</code>
            </div>
          </div>

          <div style="background: #fff3cd; padding: 16px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
            <div style="font-size: 0.9rem; color: #856404; line-height: 1.7;">
              <strong style="display: block; margin-bottom: 8px;">ğŸ“± å‹ã ã¡è¿½åŠ å¾Œã«å—ã‘å–ã‚Œã‚‹é€šçŸ¥ï¼š</strong>
              â€¢ æœ¬äººèªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<br>
              â€¢ äºˆç´„ç¢ºå®šã®é€šçŸ¥<br>
              â€¢ ãŠæ”¯æ‰•ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            </div>
          </div>

          <button onclick="this.parentElement.parentElement.remove()"
                  style="width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; transition: all 0.3s;">
            é–‰ã˜ã‚‹
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    }

    // ì‹ ì›ì¸ì¦ ìƒíƒœ í™•ì¸
    async function checkIdentityVerification() {
      const statusEl = document.getElementById('identityVerificationStatus');
      const actionsEl = document.getElementById('identityVerificationActions');

      try {
        // í”„ë¡œí•„ ì¸ì¦ ìƒíƒœ í™•ì¸
        const { data: profile } = await supabase
          .from('profiles')
          .select('identity_verified, verification_level, age')
          .eq('id', user.id)
          .single();

        // ìµœì‹  ì¸ì¦ ìš”ì²­ í™•ì¸
        const { data: request } = await supabase
          .from('identity_verification_requests')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(1)
          .maybeSingle();

        actionsEl.innerHTML = '';

        // ì—¬ê¶Œ ì¸ì¦ ì‹œìŠ¤í…œ: request.status === 'approved'ì¼ ë•Œë§Œ ì¸ì¦ ì™„ë£Œë¡œ í‘œì‹œ
        if (request?.status === 'approved') {
          statusEl.innerHTML = `
            <div style="padding: 16px; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%); border-radius: 12px; border-left: 4px solid #28a745;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.5rem;"></i>
                <strong style="color: #28a745; font-size: 1.1rem;">èªè¨¼å®Œäº†</strong>
              </div>
              <div style="color: #666; font-size: 0.95rem;">
                æœ¬äººç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸã€‚äºˆç´„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚
              </div>
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(40, 167, 69, 0.2); font-size: 0.9rem; color: #666;">
                <strong>èªè¨¼æƒ…å ±:</strong><br>
                æ°å: ${request.verified_name}<br>
                ç”Ÿå¹´æœˆæ—¥: ${request.verified_birth_date}<br>
                å¹´é½¢: ${request.verified_age}æ­³<br>
                å›½ç±: ${request.verified_nationality}
              </div>
            </div>
          `;
        } else if (request) {
          if (request.status === 'pending') {
            statusEl.innerHTML = `
              <div style="padding: 16px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%); border-radius: 12px; border-left: 4px solid #ffc107;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <i class="fas fa-clock" style="color: #ffc107; font-size: 1.5rem;"></i>
                  <strong style="color: #ffc107; font-size: 1.1rem;">ãƒ‘ã‚¹ãƒãƒ¼ãƒˆå†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…ã¡</strong>
                </div>
                <div style="color: #666; font-size: 0.95rem; margin-bottom: 12px;">
                  LINEã§ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚
                </div>
              </div>
            `;
            actionsEl.innerHTML = `
              <button class="btn btn-secondary" onclick="showUploadLink('${request.verification_token}')" style="background: #6c757d;">
                <i class="fas fa-link"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯è¡¨ç¤º
              </button>
            `;
          } else if (request.status === 'passport_uploaded') {
            statusEl.innerHTML = `
              <div style="padding: 16px; background: linear-gradient(135deg, rgba(23, 162, 184, 0.1) 0%, rgba(23, 162, 184, 0.05) 100%); border-radius: 12px; border-left: 4px solid #17a2b8;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <i class="fas fa-hourglass-half" style="color: #17a2b8; font-size: 1.5rem;"></i>
                  <strong style="color: #17a2b8; font-size: 1.1rem;">ç®¡ç†è€…å¯©æŸ»ä¸­</strong>
                </div>
                <div style="color: #666; font-size: 0.95rem;">
                  ãƒ‘ã‚¹ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚ç®¡ç†è€…ã®ç¢ºèªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
                </div>
              </div>
            `;
          } else if (request.status === 'rejected') {
            statusEl.innerHTML = `
              <div style="padding: 16px; background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%); border-radius: 12px; border-left: 4px solid #dc3545;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <i class="fas fa-times-circle" style="color: #dc3545; font-size: 1.5rem;"></i>
                  <strong style="color: #dc3545; font-size: 1.1rem;">èªè¨¼æ‹’å¦</strong>
                </div>
                <div style="color: #666; font-size: 0.95rem; margin-bottom: 8px;">
                  ${request.rejected_reason || 'èªè¨¼è¦æ±‚ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚'}
                </div>
              </div>
            `;
            actionsEl.innerHTML = '';
          }
        } else {
          statusEl.innerHTML = `
            <div style="padding: 16px; background: white; border-radius: 12px; border: 2px dashed #ddd;">
              <div style="color: #666; font-size: 0.95rem; margin-bottom: 12px;">
                äºˆç´„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”åˆ©ç”¨ã„ãŸã ãã«ã¯ã€æœ¬äººèªè¨¼ãŒå¿…è¦ã§ã™ã€‚<br>
                <strong style="color: #667eea;">äºˆç´„ã‚’ç”³è«‹ã™ã‚‹ã¨ã€ç®¡ç†è€…ãŒLINEã§ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã™ã€‚</strong>
              </div>
            </div>
          `;
          actionsEl.innerHTML = '';
        }
      } catch (error) {
        console.error('ì‹ ì›ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
        statusEl.textContent = 'èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
      }
    }

    // ì‹ ì›ì¸ì¦ ìš”ì²­
    window.requestIdentityVerification = async function() {
      try {
        // LINE ì—°ë™ í™•ì¸
        const { data: lineAccount } = await supabase
          .from('user_line_accounts')
          .select('line_user_id')
          .eq('user_id', user.id)
          .eq('is_verified', true)
          .maybeSingle();

        if (!lineAccount) {
          showToast('âŒ LINEé€£å‹•ãŒå¿…è¦ã§ã™ã€‚å…ˆã«LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é€£å‹•ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (!confirm('æœ¬äººèªè¨¼ã‚’ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ\n\nLINEã§ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚')) {
          return;
        }

        const token = crypto.randomUUID();

        // ì¸ì¦ ìš”ì²­ ìƒì„±
        const { error } = await supabase
          .from('identity_verification_requests')
          .insert({
            user_id: user.id,
            status: 'pending',
            verification_token: token
          });

        if (error) throw error;

        // ê´€ë¦¬ìì—ê²Œ LINE ì•Œë¦¼ (Edge Function í˜¸ì¶œ)
        const uploadUrl = `${window.location.origin}/passport_upload_token.html?token=${token}`;

        const { data: { session } } = await supabase.auth.getSession();

        console.log('ğŸ“¤ LINE ë©”ì‹œì§€ ë°œì†¡ ìš”ì²­:', {
          userId: user.id,
          uploadUrl,
          token: session?.access_token?.substring(0, 20) + '...'
        });

        let lineResponse;
        try {
          lineResponse = await fetch(`${SUPABASE_URL}/functions/v1/send-line-notification`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({
              userId: user.id,
              type: 'identity_verification_request',
              uploadUrl: uploadUrl
            })
          });
        } catch (fetchError) {
          console.error('âŒ Fetch ì—ëŸ¬:', fetchError);
          throw new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“');
        }

        let lineResult;
        try {
          lineResult = await lineResponse.json();
        } catch (jsonError) {
          console.error('âŒ JSON íŒŒì‹± ì—ëŸ¬:', jsonError);
          throw new Error('ã‚µãƒ¼ãƒãƒ¼å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        console.log('ğŸ“¨ LINE ë©”ì‹œì§€ ë°œì†¡ ê²°ê³¼:', lineResult);

        if (!lineResponse.ok || !lineResult.success) {
          throw new Error(lineResult.error || 'LINE ë©”ì‹œì§€ ë°œì†¡ ì‹¤íŒ¨');
        }

        showToast('âœ… èªè¨¼ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼LINEã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚');
        await checkIdentityVerification();
      } catch (error) {
        console.error('ì‹ ì›ì¸ì¦ ìš”ì²­ ì‹¤íŒ¨:', error);
        showToast('âŒ èªè¨¼ç”³è«‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // ì—…ë¡œë“œ ë§í¬ í‘œì‹œ
    window.showUploadLink = function(token) {
      const uploadUrl = `${SUPABASE_URL}/passport-upload/${token}`;
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 10000;
      `;
      modal.innerHTML = `
        <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; width: 90%;">
          <h3 style="margin-bottom: 16px;">ğŸ“· ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯</h3>
          <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; word-break: break-all; margin-bottom: 16px; font-size: 0.9rem;">
            ${uploadUrl}
          </div>
          <div style="display: flex; gap: 12px;">
            <button onclick="navigator.clipboard.writeText('${uploadUrl}').then(() => alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'))"
                    style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
              <i class="fas fa-copy"></i> ã‚³ãƒ”ãƒ¼
            </button>
            <button onclick="window.open('${uploadUrl}', '_blank')"
                    style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
              <i class="fas fa-external-link-alt"></i> é–‹ã
            </button>
            <button onclick="this.parentElement.parentElement.parentElement.remove()"
                    style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
              é–‰ã˜ã‚‹
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    };

    // ì´ˆê¸° ë¡œë“œ
    await loadProfile();
    await checkLineConnection();
    await checkIdentityVerification();
  })();
</script>

</body>
</html>