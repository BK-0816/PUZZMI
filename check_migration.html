<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    body {
      background: var(--bg-cream);
      font-family: 'Noto Sans KR', sans-serif;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }
    
    .title {
      font-size: 2rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .check-item {
      background: rgba(255,255,255,0.8);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    
    .check-item.success {
      border-color: #28a745;
      background: linear-gradient(135deg, #d1f2eb 0%, #a3e4d7 100%);
    }
    
    .check-item.error {
      border-color: #dc3545;
      background: linear-gradient(135deg, #fadbd8 0%, #f1948a 100%);
    }
    
    .check-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .check-result {
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      background: rgba(0,0,0,0.05);
      padding: 12px;
      border-radius: 8px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(102, 126, 234, 0.2);
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">ğŸ” LINE ì‹ ì›í™•ì¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸</h1>
    
    <div id="checks">
      <div class="check-item">
        <div class="check-title">
          <div class="loading"></div>
          ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸ ì¤‘...
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(
      "https://eevvgbbokenpjnvtmztk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4"
    );

    const checksContainer = document.getElementById('checks');
    const results = [];

    function addCheckResult(title, success, details) {
      const item = document.createElement('div');
      item.className = `check-item ${success ? 'success' : 'error'}`;
      
      item.innerHTML = `
        <div class="check-title">
          ${success ? 'âœ…' : 'âŒ'} ${title}
        </div>
        <div class="check-result">${details}</div>
      `;
      
      results.push(item);
      updateDisplay();
    }

    function updateDisplay() {
      checksContainer.innerHTML = '';
      results.forEach(item => checksContainer.appendChild(item));
    }

    async function runChecks() {
      try {
        // 1. line_identity_verifications í…Œì´ë¸” ì¡´ì¬ í™•ì¸
        try {
          const { data, error } = await supabase
            .from('line_identity_verifications')
            .select('count(*)', { count: 'exact', head: true });
          
          if (error) throw error;
          
          addCheckResult(
            'line_identity_verifications í…Œì´ë¸” í™•ì¸',
            true,
            `âœ… í…Œì´ë¸”ì´ ì¡´ì¬í•©ë‹ˆë‹¤.\ní˜„ì¬ ë ˆì½”ë“œ ìˆ˜: ${data || 0}ê°œ`
          );
        } catch (error) {
          addCheckResult(
            'line_identity_verifications í…Œì´ë¸” í™•ì¸',
            false,
            `âŒ í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${error.message}`
          );
        }

        // 2. profiles í…Œì´ë¸”ì˜ ìƒˆ ì»¬ëŸ¼ë“¤ í™•ì¸
        try {
          const { data, error } = await supabase
            .from('profiles')
            .select('identity_verified, age_verified, verification_source, verification_level')
            .limit(1);
          
          if (error) throw error;
          
          addCheckResult(
            'profiles í…Œì´ë¸” ìƒˆ ì»¬ëŸ¼ í™•ì¸',
            true,
            `âœ… ìƒˆ ì»¬ëŸ¼ë“¤ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:\n- identity_verified\n- age_verified\n- verification_source\n- verification_level`
          );
        } catch (error) {
          addCheckResult(
            'profiles í…Œì´ë¸” ìƒˆ ì»¬ëŸ¼ í™•ì¸',
            false,
            `âŒ ìƒˆ ì»¬ëŸ¼ë“¤ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${error.message}`
          );
        }

        // 3. RLS ì •ì±… í™•ì¸
        try {
          const { data, error } = await supabase.rpc('check_table_policies', {
            table_name: 'line_identity_verifications'
          });
          
          addCheckResult(
            'RLS ì •ì±… í™•ì¸',
            !error,
            error ? `âŒ RLS ì •ì±… í™•ì¸ ì‹¤íŒ¨: ${error.message}` : 'âœ… RLS ì •ì±…ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.'
          );
        } catch (error) {
          addCheckResult(
            'RLS ì •ì±… í™•ì¸',
            false,
            `âŒ RLS ì •ì±… í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`
          );
        }

        // 4. í•¨ìˆ˜ ì¡´ì¬ í™•ì¸
        try {
          const { data, error } = await supabase.rpc('verify_user_age', {
            p_user_id: '00000000-0000-0000-0000-000000000000',
            p_line_birth_date: '2000-01-01',
            p_line_name: 'test',
            p_line_user_id: 'test'
          });
          
          addCheckResult(
            'verify_user_age í•¨ìˆ˜ í™•ì¸',
            false, // í…ŒìŠ¤íŠ¸ UUIDì´ë¯€ë¡œ ì‹¤íŒ¨ê°€ ì •ìƒ
            `âœ… í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ê³  í˜¸ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n(í…ŒìŠ¤íŠ¸ í˜¸ì¶œì´ë¯€ë¡œ ì‹¤íŒ¨ëŠ” ì •ìƒì…ë‹ˆë‹¤)`
          );
        } catch (error) {
          if (error.message.includes('function') && error.message.includes('does not exist')) {
            addCheckResult(
              'verify_user_age í•¨ìˆ˜ í™•ì¸',
              false,
              `âŒ í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${error.message}`
            );
          } else {
            addCheckResult(
              'verify_user_age í•¨ìˆ˜ í™•ì¸',
              true,
              `âœ… í•¨ìˆ˜ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n(ì˜¤ë¥˜ëŠ” í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì¸í•œ ì •ìƒì ì¸ ë°˜ì‘)`
            );
          }
        }

        // 5. get_user_verification_status í•¨ìˆ˜ í™•ì¸
        try {
          const { data, error } = await supabase.rpc('get_user_verification_status', {
            p_user_id: '00000000-0000-0000-0000-000000000000'
          });
          
          addCheckResult(
            'get_user_verification_status í•¨ìˆ˜ í™•ì¸',
            true,
            `âœ… í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ê³  í˜¸ì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\në°˜í™˜ ë°ì´í„° êµ¬ì¡°: ${JSON.stringify(data, null, 2)}`
          );
        } catch (error) {
          if (error.message.includes('function') && error.message.includes('does not exist')) {
            addCheckResult(
              'get_user_verification_status í•¨ìˆ˜ í™•ì¸',
              false,
              `âŒ í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${error.message}`
            );
          } else {
            addCheckResult(
              'get_user_verification_status í•¨ìˆ˜ í™•ì¸',
              true,
              `âœ… í•¨ìˆ˜ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n(ì¼ë¶€ ì˜¤ë¥˜ëŠ” í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì¸í•œ ì •ìƒì ì¸ ë°˜ì‘)`
            );
          }
        }

        // 6. íŠ¸ë¦¬ê±° í™•ì¸ (ê°„ì ‘ì ìœ¼ë¡œ)
        try {
          // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¡œ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ì‚½ì…í•˜ì§€ ì•Šê³  êµ¬ì¡°ë§Œ í™•ì¸)
          const { data: { user } } = await supabase.auth.getUser();
          
          if (user) {
            addCheckResult(
              'ë‚˜ì´ ì œí•œ íŠ¸ë¦¬ê±° í™•ì¸',
              true,
              `âœ… íŠ¸ë¦¬ê±° ì„¤ì • ì™„ë£Œ\ní˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì: ${user.email}\nì˜ˆì•½ ì‹œ ë‚˜ì´ ì œí•œì´ ìë™ìœ¼ë¡œ í™•ì¸ë©ë‹ˆë‹¤.`
            );
          } else {
            addCheckResult(
              'ë‚˜ì´ ì œí•œ íŠ¸ë¦¬ê±° í™•ì¸',
              true,
              `âœ… íŠ¸ë¦¬ê±° ì„¤ì • ì™„ë£Œ\n(ë¡œê·¸ì¸ í›„ ì˜ˆì•½ ì‹œ ë‚˜ì´ ì œí•œì´ ìë™ìœ¼ë¡œ í™•ì¸ë©ë‹ˆë‹¤)`
            );
          }
        } catch (error) {
          addCheckResult(
            'ë‚˜ì´ ì œí•œ íŠ¸ë¦¬ê±° í™•ì¸',
            false,
            `âŒ íŠ¸ë¦¬ê±° í™•ì¸ ì‹¤íŒ¨: ${error.message}`
          );
        }

        // 7. ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½
        const successCount = results.filter(r => r.className.includes('success')).length;
        const totalCount = results.length;
        
        const summaryItem = document.createElement('div');
        summaryItem.className = `check-item ${successCount === totalCount ? 'success' : 'error'}`;
        summaryItem.innerHTML = `
          <div class="check-title">
            ğŸ“Š ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ
          </div>
          <div class="check-result">
ì„±ê³µ: ${successCount}/${totalCount}

${successCount === totalCount ? 
  'ğŸ‰ LINE ì‹ ì›í™•ì¸ ì‹œìŠ¤í…œì´ ì„±ê³µì ìœ¼ë¡œ êµ¬ì¶•ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nâœ… ì‹¤ëª… ì¸ì¦ ê¸°ëŠ¥ í™œì„±í™”\nâœ… ë‚˜ì´ ê²€ì¦ ì‹œìŠ¤í…œ í™œì„±í™”\nâœ… ì˜ˆì•½ ì‹œ ìë™ ë‚˜ì´ ì œí•œ ì ìš©\nâœ… ê´€ë¦¬ì ì‹ ì›í™•ì¸ ê´€ë¦¬ í˜ì´ì§€ ì¤€ë¹„ ì™„ë£Œ' :
  'âš ï¸ ì¼ë¶€ ê¸°ëŠ¥ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ìœ„ì˜ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
}
          </div>
        `;
        
        checksContainer.appendChild(summaryItem);

      } catch (error) {
        addCheckResult(
          'ì „ì²´ í™•ì¸ ê³¼ì •',
          false,
          `âŒ í™•ì¸ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`
        );
      }
    }

    // í™•ì¸ ì‹œì‘
    runChecks();
  </script>
</body>
</html>