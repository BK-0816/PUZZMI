
<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PUZZMI 관리자</title>
<link rel="stylesheet" href="styles.css"/><link rel="stylesheet" href="pages.css"/><link rel="stylesheet" href="nav.css"/><link rel="stylesheet" href="pages-theme.css"/>
<script type="module" src="nav.js"></script>
<style>body.bg-cream{background:var(--bg-cream);background-repeat:no-repeat;background-size:cover}table{width:100%;border-collapse:collapse}th,td{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.06);text-align:left;vertical-align:top}th{font-size:12px;color:var(--text-secondary);font-weight:700;text-transform:uppercase;letter-spacing:.02em}.pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(0,0,0,.08);background:#fff}.conflict{color:#ef4444;font-weight:700}.ok{color:#16a34a;font-weight:700}.badge-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}</style>
</head><body class="bg-cream"><div id="app-nav"></div><main class="page stack-16">
<section class="card"><h2>예약 관리</h2>
<div class="stack-16"><div class="label">관리자 로그인(OTP)</div><div class="row"><input id="email" class="input" placeholder="admin@example.com"/><button id="sendOtp" class="btn btn-primary">로그인 메일 보내기</button></div></div></section>
<section class="card stack-16"><h3>운영 설정</h3><div class="row"><input id="slackWebhook" class="input" placeholder="Slack Webhook URL"/><input id="notifyWebhook" class="input" placeholder="일반 Webhook URL"/><button id="saveSettings" class="btn btn-secondary">저장</button><button id="testSlack" class="btn btn-secondary">Slack 테스트</button><button id="testNotify" class="btn btn-secondary">Webhook 테스트</button></div></section>
<section class="card"><div class="row" style="justify-content:space-between"><div class="row"><select id="statusFilter" class="select"><option value="pending">pending</option><option value="confirmed">confirmed</option><option value="completed">completed</option><option value="declined">declined</option><option value="cancelled">cancelled</option><option value="all">전체</option></select><input id="search" class="input" placeholder="이름/연락처/메이트 검색"/><button id="checkConflicts" class="btn btn-secondary">충돌 전체 점검</button></div><div class="row"><button id="exportCsv" class="btn btn-secondary">CSV</button><button id="refresh" class="btn btn-secondary">새로고침</button></div></div>
<div style="overflow:auto"><table><thead><tr><th>ID</th><th>상태</th><th>일시</th><th>고객</th><th>연락처</th><th>언어</th><th>메이트</th><th>요청</th><th>충돌</th><th>조치</th></tr></thead><tbody id="tbody"></tbody></table></div></section>
</main>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient("https://eevvgbbokenpjnvtmztk.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4");
const email=document.getElementById('email'), sendOtp=document.getElementById('sendOtp');
sendOtp.addEventListener('click', async()=>{const v=email.value.trim(); if(!v) return alert('이메일 입력'); const {error}=await supabase.auth.signInWithOtp({email:v, options:{emailRedirectTo:location.href}}); if(error) alert(error.message); else alert('메일을 보냈습니다.')});
let rows=[], mates=new Map();
async function ensureAdmin(){const {data:{user}}=await supabase.auth.getUser(); if(!user) return false; const {data}=await supabase.from('admin_users').select('user_id').eq('user_id', user.id).maybeSingle(); return !!data;}
async function loadMates(){const {data}=await supabase.from('mate_profiles').select('user_id, profiles(full_name)'); if(data) mates=new Map(data.map(r=>[r.user_id, r.profiles?.full_name||r.user_id]));}
function ts(row){const s=new Date(row.date+'T'+row.start_time); const e=new Date(s.getTime()+(row.duration_hours||0)*3600000); return {s,e};}
function overlap(a,b){const A=ts(a),B=ts(b); return A.s < B.e && B.s < A.e;}
function conflict(r){const st=['confirmed','completed']; if(!st.includes(r.status)) return false; return rows.some(o=>o.id!==r.id && o.mate_id===r.mate_id && st.includes(o.status) && overlap(r,o));}
function render(){const q=(document.getElementById('search').value||'').toLowerCase(); const st=document.getElementById('statusFilter').value;
const filtered=rows.filter(r=>(st==='all'||r.status===st)&&(((r.customer_name||'').toLowerCase().includes(q))||((r.customer_contact||'').toLowerCase().includes(q))||((mates.get(r.mate_id)||'').toLowerCase().includes(q))));
document.getElementById('tbody').innerHTML=filtered.map(r=>{const mate=mates.get(r.mate_id)||r.mate_id; const dt=`${r.date} ${r.start_time} (${r.duration_hours}h)`; const c=conflict(r);
return `<tr data-id="${r.id}"><td>${r.id}</td><td><span class="pill">${r.status}</span></td><td>${dt}</td><td>${r.customer_name}</td><td>${r.customer_contact}</td><td>${r.language||'-'}</td><td>${mate}</td><td style="max-width:320px">${(r.notes||'').replace(/</g,'&lt;')}</td><td>${c?'<span class=conflict><span class=badge-dot style=background:#ef4444></span>충돌</span>':'<span class=ok><span class=badge-dot style=background:#16a34a></span>정상</span>'}</td><td>${['confirmed','completed','declined','cancelled'].map(s=>`<button class="btn btn-secondary" data-act="set" data-status="${s}" data-id="${r.id}">${s}</button>`).join('')}</td></tr>`}).join('');
document.querySelectorAll('button[data-act="set"]').forEach(btn=>btn.onclick=async()=>{const id=btn.dataset.id, status=btn.dataset.status; if(['confirmed','completed'].includes(status)){const r=rows.find(x=>x.id===id); if(await hasConflict(r)){if(!confirm('동시간대 확정 건이 있습니다. 진행할까요?')) return;}} const {error}=await supabase.from('bookings').update({status}).eq('id', id); if(error) alert(error.message); if(status==='confirmed'){notify(rows.find(x=>x.id===id));}});}
async function load(){const {data}=await supabase.from('bookings').select('*').order('created_at', {ascending:false}).limit(300); rows=data||[]; render();}
const channel=supabase.channel('bookings:*').on('postgres_changes',{event:'*',schema:'public',table:'bookings'},p=>{const i=rows.findIndex(r=>r.id===p.new.id); if(i>=0) rows[i]=p.new; else rows.unshift(p.new); render();}).subscribe();
document.getElementById('statusFilter').onchange=render; document.getElementById('search').oninput=render; document.getElementById('refresh').onclick=()=>load();
async function hasConflict(r){if(!r) return false; const {data}=await supabase.from('bookings').select('*').eq('mate_id', r.mate_id).eq('date', r.date).in('status',['confirmed','completed']); return (data||[]).some(b=>b.id!==r.id && overlap(r,b));}
function save(key, val){localStorage.setItem(key, val||'');}
function read(key){return localStorage.getItem(key)||'';}
document.getElementById('saveSettings').onclick=()=>{save('puzzmi.slackWebhook', document.getElementById('slackWebhook').value.trim()); save('puzzmi.notifyWebhook', document.getElementById('notifyWebhook').value.trim()); alert('저장됨');};
document.getElementById('testSlack').onclick=async()=>{const u=read('puzzmi.slackWebhook'); if(!u) return alert('Slack URL 없음'); const res=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:':white_check_mark: 테스트 OK'})}); alert('응답 '+res.status);};
document.getElementById('testNotify').onclick=async()=>{const u=read('puzzmi.notifyWebhook'); if(!u) return alert('Webhook URL 없음'); const res=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'test',source:'puzzmi-admin',ts:Date.now()})}); alert('응답 '+res.status);};
function toCsvVal(v){const s=(v==null?'':String(v)).replaceAll('"','""'); return `"${s}"`;}
document.getElementById('exportCsv').onclick=()=>{const q=(document.getElementById('search').value||'').toLowerCase(); const st=document.getElementById('statusFilter').value; const filtered=rows.filter(r=>(st==='all'||r.status===st)&&(((r.customer_name||'').toLowerCase().includes(q))||((r.customer_contact||'').toLowerCase().includes(q))||((mates.get(r.mate_id)||'').toLowerCase().includes(q)))); const headers=['id','status','date','start_time','duration_hours','customer_name','customer_contact','language','mate_id','notes','created_at']; const lines=[headers.map(toCsvVal).join(',')].concat(filtered.map(r=>headers.map(h=>toCsvVal(r[h])).join(','))); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bookings_export.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),0);};
function bookingText(r){const m=mates.get(r.mate_id)||r.mate_id; return ['*PUZZMI 예약 확정*',`• 메이트: ${m}`,`• 일시: ${r.date} ${r.start_time} (${r.duration_hours}h)`,`• 고객: ${r.customer_name}`,`• 연락처: ${r.customer_contact}`, r.language?`• 언어: ${r.language}`:null, r.notes?`• 요청: ${r.notes}`:null, `• 예약ID: ${r.id}`].filter(Boolean).join('\n');}
async function notify(r){const s=localStorage.getItem('puzzmi.slackWebhook')||''; if(s){fetch(s,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:bookingText(r)})});} const n=localStorage.getItem('puzzmi.notifyWebhook')||''; if(n){fetch(n,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'booking_confirmed',source:'puzzmi-admin',data:r})});}}
await loadMates(); await load();
document.getElementById('slackWebhook').value=localStorage.getItem('puzzmi.slackWebhook')||''; document.getElementById('notifyWebhook').value=localStorage.getItem('puzzmi.notifyWebhook')||'';
</script></body></html>
