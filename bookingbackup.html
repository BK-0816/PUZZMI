
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUZZMI 예약하기</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <link rel="stylesheet" href="styles.css" />
<style>
  /* 메인 styles.css에 --bg-cream 변수가 이미 있으니 그대로 사용 가능 */
  body { background: var(--bg-cream); background-repeat:no-repeat; background-size:cover; }
</style>
  <main class="page stack-16">
    <a href="index.html#friends" class="btn btn-secondary">← 메이트 목록으로</a>

    <section class="card">
      <header class="media">
        <img id="mateAvatar" class="round" src="" alt="avatar"/>
        <div>
          <h2 id="mateName" style="margin:0 0 4px 0;">메이트</h2>
          <div class="muted" id="mateMeta"></div>
        </div>
      </header>

      <div class="spacer"></div>

      <form id="bookingForm" class="stack-16">
        <div class="row">
          <div class="field">
            <div class="label">예약 날짜</div>
            <input class="input" type="date" id="date" required/>
          </div>
          <div class="field">
            <div class="label">시작 시간</div>
            <input class="input" type="time" id="start_time" required/>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <div class="label">이용 시간(시간)</div>
            <select class="select" id="duration_hours" required>
              <option value="2">2시간</option>
              <option value="3">3시간</option>
              <option value="4">4시간</option>
              <option value="5">5시간</option>
              <option value="6">6시간</option>
              <option value="7">7시간</option>
              <option value="8">8시간</option>
            </select>
          </div>
          <div class="field">
            <div class="label">언어</div>
            <select class="select" id="language" required>
              <option value="ko">한국어</option>
              <option value="ja">日本語</option>
              <option value="en">English</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <div class="label">예약자 성함</div>
            <input class="input" type="text" id="customer_name" placeholder="예: Yuki Tanaka" required/>
          </div>
          <div class="field">
            <div class="label">연락처(이메일 또는 LINE)</div>
            <input class="input" type="text" id="customer_contact" placeholder="예: yuki@example.com / LINE ID" required/>
          </div>
        </div>
        <div class="row single">
          <div class="field">
            <div class="label">요청사항</div>
            <textarea class="textarea" id="notes" placeholder="가고 싶은 카페/음식, 선호 지역, 기타 요청"></textarea>
          </div>
        </div>
        <button class="btn btn-primary" type="submit" id="submitBtn">예약 신청하기</button>
        <div id="result" class="stack-16"></div>
      </form>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://eevvgbbokenpjnvtmztk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(location.search);
    const mateId = params.get('mate_id');

    const avatarEl = document.getElementById('mateAvatar');
    const nameEl = document.getElementById('mateName');
    const metaEl = document.getElementById('mateMeta');

    async function loadMate() {
      if (!mateId) return;
      const { data, error } = await supabase
        .from('mate_profiles')
        .select(`
          user_id, bio, hourly_rate, mbti, hobbies, rating,
          profiles!inner ( id, full_name, age, gender, languages, avatar_url )
        `)
        .eq('user_id', mateId)
        .single();

      if (error) {
        console.error(error);
        nameEl.textContent = '메이트 정보 로드 실패';
        return;
      }
      const p = data.profiles || {};
      avatarEl.src = p.avatar_url || (Array.isArray(data.photos) && data.photos[0]) || "https://picsum.photos/seed/puzzmi/140/140";
      nameEl.textContent = p.full_name || '이름 비공개';
      const age = p.age ? `${p.age}세` : '';
      const gender = p.gender || '';
      const mbti = data.mbti ? ` • MBTI ${data.mbti}` : '';
      metaEl.textContent = [age, gender].filter(Boolean).join(' • ') + mbti;
    }

    loadMate();

    const form = document.getElementById('bookingForm');
    const result = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;

      const date = document.getElementById('date').value;
      const start_time = document.getElementById('start_time').value;
      const duration_hours = parseInt(document.getElementById('duration_hours').value, 10);
      const language = document.getElementById('language').value;
      const customer_name = document.getElementById('customer_name').value.trim();
      const customer_contact = document.getElementById('customer_contact').value.trim();
      const notes = document.getElementById('notes').value.trim();

      const payload = {
        mate_id: mateId,
        customer_name,
        customer_contact,
        date, start_time, duration_hours,
        language,
        notes,
        status: 'pending'
      };

      const { data, error } = await supabase.from('bookings').insert(payload).select().single();
      if (error) {
        console.error(error);
        result.innerHTML = `<div class="error">예약 신청 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</div>`;
      } else {
        result.innerHTML = `<div class="success">예약 신청이 접수되었습니다! 관리자 확인 후 안내드릴게요. (신청번호: ${data.id})</div>`;
        form.reset();
      }
      submitBtn.disabled = false;
    });
  </script>
</body>
</html>
