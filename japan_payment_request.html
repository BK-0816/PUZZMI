<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãŠæ”¯æ‰•ã„ - PUZZMI</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body.bg-cream {
      background: var(--bg-cream);
      min-height: 100vh;
    }

    .payment-container {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
    }

    .payment-card {
      background: white;
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    }

    .payment-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .payment-header h1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 2rem;
    }

    .payment-icon {
      font-size: 2.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .payment-info {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin: 30px 0;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .info-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 1.2rem;
      color: #667eea;
      margin-top: 12px;
    }

    .info-label {
      color: #666;
    }

    .info-value {
      font-weight: 600;
      color: #333;
    }

    .customer-form {
      margin: 30px 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .payment-methods {
      margin: 30px 0;
    }

    .methods-title {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 16px;
      color: #333;
    }

    .method-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .method-item {
      padding: 16px;
      background: #f8f9fa;
      border-radius: 12px;
      text-align: center;
      font-size: 0.95rem;
      color: #666;
    }

    .method-icon {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .pay-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 30px;
    }

    .pay-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
    }

    .pay-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .notice-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      font-size: 0.9rem;
      color: #856404;
    }

    .notice-title {
      font-weight: 700;
      margin-bottom: 8px;
    }

    @media (max-width: 768px) {
      .payment-card {
        padding: 24px;
      }

      .method-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="bg-cream">
  <div class="payment-container">
    <a href="my_bookings.html" class="back-link">â† äºˆç´„ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</a>

    <div class="payment-card">
      <div class="payment-header">
        <h1>
          <span class="payment-icon">ğŸ’³</span>
          ãŠæ”¯æ‰•ã„
        </h1>
        <p style="color: #666;">å®‰å…¨ãªæ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã§ç°¡å˜ã«ãŠæ”¯æ‰•ã„ã„ãŸã ã‘ã¾ã™</p>
      </div>

      <div class="payment-info" id="paymentInfo">
        <div class="info-row">
          <span class="info-label">äºˆç´„ID</span>
          <span class="info-value" id="bookingIdDisplay">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">ã‚µãƒ¼ãƒ“ã‚¹</span>
          <span class="info-value">SeoulDays ãƒ¬ãƒ³ã‚¿ãƒ«å‹é”</span>
        </div>
        <div class="info-row">
          <span class="info-label">ãŠæ”¯æ‰•ã„é‡‘é¡</span>
          <span class="info-value" id="amountDisplay">Â¥0</span>
        </div>
      </div>

      <form id="customerForm" class="customer-form">
        <div class="form-group">
          <label class="form-label">ãŠåå‰ *</label>
          <input type="text" id="buyerName" class="form-input" placeholder="å±±ç”°å¤ªéƒ" required>
        </div>

        <div class="form-group">
          <label class="form-label">é›»è©±ç•ªå· *</label>
          <input type="tel" id="buyerTel" class="form-input" placeholder="09012345678" required>
        </div>

        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
          <input type="email" id="buyerEmail" class="form-input" placeholder="example@email.com" required>
        </div>
      </form>

      <div class="payment-methods">
        <div class="methods-title">ã”åˆ©ç”¨å¯èƒ½ãªãŠæ”¯æ‰•ã„æ–¹æ³•</div>
        <div class="method-grid">
          <div class="method-item">
            <div class="method-icon">ğŸ’³</div>
            <div>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</div>
          </div>
          <div class="method-item">
            <div class="method-icon">ğŸª</div>
            <div>ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆ</div>
          </div>
          <div class="method-item">
            <div class="method-icon">ğŸ“±</div>
            <div>PayPay</div>
          </div>
          <div class="method-item">
            <div class="method-icon">ğŸ’š</div>
            <div>LINE Pay</div>
          </div>
        </div>
      </div>

      <div class="notice-box">
        <div class="notice-title">â„¹ï¸ ã”æ³¨æ„</div>
        <div>æ±ºæ¸ˆãŒå®Œäº†ã™ã‚‹ã¨äºˆç´„ãŒç¢ºå®šã•ã‚Œã¾ã™ã€‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</div>
      </div>

      <button id="payBtn" class="pay-btn" onclick="initiatePayment()">
        ãŠæ”¯æ‰•ã„ã«é€²ã‚€
      </button>
    </div>
  </div>

  <form name="payform" id="payform" method="post" style="display: none;">
    <input type="hidden" name="cbtType" id="cbtType" value="JPPG">
    <input type="hidden" name="mid" id="mid" value="CBTTEST001">
    <input type="hidden" name="timestamp" id="timestamp">
    <input type="hidden" name="orderId" id="orderId">
    <input type="hidden" name="goodName" id="goodName" value="SeoulDays ãƒ¬ãƒ³ã‚¿ãƒ«å‹é”ã‚µãƒ¼ãƒ“ã‚¹">
    <input type="hidden" name="amount" id="amount">
    <input type="hidden" name="buyerName" id="hiddenBuyerName">
    <input type="hidden" name="buyerTel" id="hiddenBuyerTel">
    <input type="hidden" name="buyerEmail" id="hiddenBuyerEmail">
    <input type="hidden" name="returnUrl" id="returnUrl">
    <input type="hidden" name="hashData" id="hashData">
    <input type="hidden" name="extraData" id="extraData">
  </form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://eevvgbbokenpjnvtmztk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const APIKEY = "2wU7xOZd8gewsDyP";
    const MID = "puzzmi01jp";

    let bookingId = null;
    let totalAmount = 0;

    async function initializePage() {
      const urlParams = new URLSearchParams(window.location.search);
      bookingId = urlParams.get('booking_id');
      totalAmount = parseFloat(urlParams.get('amount')) || 0;

      if (!bookingId || !totalAmount) {
        alert('äºˆç´„æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        window.location.href = 'my_bookings.html';
        return;
      }

      document.getElementById('bookingIdDisplay').textContent = `#${bookingId}`;
      document.getElementById('amountDisplay').textContent = `Â¥${totalAmount.toLocaleString()}`;

      const timestamp = Math.floor(Date.now() / 1000);
      const orderId = `${MID}_${timestamp}`;

      document.getElementById('timestamp').value = timestamp;
      document.getElementById('orderId').value = orderId;
      document.getElementById('amount').value = totalAmount;

      const supabaseUrl = supabaseClient.supabaseUrl;
      document.getElementById('returnUrl').value = `${supabaseUrl}/functions/v1/japan-payment-return`;

      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) {
        const { data: profile } = await supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .maybeSingle();

        if (profile) {
          document.getElementById('buyerName').value = profile.full_name || '';
          document.getElementById('buyerEmail').value = user.email || '';
        }
      }
    }

    function generateHash(apikey, mid, timestamp, amount, orderId) {
      const data = apikey + mid + timestamp + amount + orderId;
      return CryptoJS.SHA512(data).toString();
    }

    function generateExtraData() {
      const currentUrl = window.location.origin;
      return {
        "paymentUI": {
          "language": "ja",
          "logoUrl": "",
          "colorTheme": ""
        },
        "payment": {
          "paymethod": ["CARD", "CVS", "PAYpay", "LINEpay"],
          "isMobile": "true",
          "card": {
            "payType": ["one", "installments"],
            "installMonth": [3, 5, 6, 10, 12]
          },
          "cvs": {
            "notiUrl": `${currentUrl}/supabase/functions/v1/japan-payment-notification`,
            "contactInfo": "SeoulDays Support",
            "contactTelNum": "080-1234-5678",
            "contactHours": "09:00-18:00",
            "paymentTermDay": 5
          },
          "linepay": {
            "productImageUrl": `${currentUrl}/PUZZMI.png`
          }
        }
      };
    }

    async function initiatePayment() {
      const form = document.getElementById('customerForm');
      const payBtn = document.getElementById('payBtn');

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      payBtn.disabled = true;
      payBtn.innerHTML = '<span class="loading"></span> å‡¦ç†ä¸­...';

      const buyerName = document.getElementById('buyerName').value;
      const buyerTel = document.getElementById('buyerTel').value;
      const buyerEmail = document.getElementById('buyerEmail').value;

      document.getElementById('hiddenBuyerName').value = buyerName;
      document.getElementById('hiddenBuyerTel').value = buyerTel;
      document.getElementById('hiddenBuyerEmail').value = buyerEmail;

      const mid = document.getElementById('mid').value;
      const timestamp = document.getElementById('timestamp').value;
      const orderId = document.getElementById('orderId').value;
      const amount = document.getElementById('amount').value;

      const hashData = generateHash(APIKEY, mid, timestamp, amount, orderId);
      document.getElementById('hashData').value = hashData;

      const extraData = generateExtraData();
      document.getElementById('extraData').value = JSON.stringify(extraData);

      const { data: { user } } = await supabaseClient.auth.getUser();

      try {
        const { data, error } = await supabaseClient
          .from('japan_payment_requests')
          .insert({
            user_id: user?.id,
            booking_id: bookingId ? parseInt(bookingId) : null,
            mid: mid,
            order_id: orderId,
            amount: parseFloat(amount),
            good_name: 'SeoulDays ãƒ¬ãƒ³ã‚¿ãƒ«å‹é”ã‚µãƒ¼ãƒ“ã‚¹',
            buyer_name: buyerName,
            buyer_tel: buyerTel,
            buyer_email: buyerEmail,
            hash_data: hashData,
            timestamp: parseInt(timestamp),
            status: 'pending'
          })
          .select();

        if (error) {
          console.error('Error saving payment request:', error);
          alert('æ±ºæ¸ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          payBtn.disabled = false;
          payBtn.innerHTML = 'ãŠæ”¯æ‰•ã„ã«é€²ã‚€';
          return;
        }

        const payform = document.getElementById('payform');
        payform.action = "https://cbt.inicis.com/cbtauth";
        payform.target = "_self";
        payform.submit();

      } catch (err) {
        console.error('Error:', err);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        payBtn.disabled = false;
        payBtn.innerHTML = 'ãŠæ”¯æ‰•ã„ã«é€²ã‚€';
      }
    }

    window.onload = initializePage;
  </script>
</body>
</html>