<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUZZMI - ë©”ì´íŠ¸ ê´€ë¦¬ (ê´€ë¦¬ì)</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <script type="module" src="nav.js"></script>
  <style>
    body.bg-cream { 
      background: var(--bg-cream); 
      background-repeat: no-repeat; 
      background-size: cover; 
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    /* ë°°ê²½ ì¥ì‹ ìš”ì†Œ */
    .decorative-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .decorative-element {
      position: absolute;
      border-radius: 50%;
      filter: blur(70px);
      opacity: 0.25;
      animation: float 12s ease-in-out infinite;
    }
    
    .decorative-element:nth-child(1) {
      width: 280px;
      height: 280px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      top: 8%;
      left: -6%;
      animation-delay: 0s;
    }
    
    .decorative-element:nth-child(2) {
      width: 240px;
      height: 240px;
      background: linear-gradient(45deg, #f093fb, #f5576c);
      top: 45%;
      right: -8%;
      animation-delay: 4s;
    }
    
    .decorative-element:nth-child(3) {
      width: 200px;
      height: 200px;
      background: linear-gradient(45deg, #4facfe, #00f2fe);
      bottom: 12%;
      left: 12%;
      animation-delay: 8s;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); }
      25% { transform: translateY(-25px) rotate(90deg) scale(1.05); }
      50% { transform: translateY(-10px) rotate(180deg) scale(0.95); }
      75% { transform: translateY(-20px) rotate(270deg) scale(1.02); }
    }
    
    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .admin-wrap { 
      max-width: 1200px; 
      margin: 32px auto; 
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }
    
    /* í˜ì´ì§€ í—¤ë” */
    .page-header {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 28px;
      padding: 40px;
      margin-bottom: 32px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
      text-align: center;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 20%, #f093fb 40%, #f5576c 60%, #4facfe 80%, #00f2fe 100%);
      animation: shimmer 4s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 1; transform: translateX(0); }
      50% { opacity: 0.8; transform: translateX(8px); }
    }
    
    .page-header h2 {
      font-size: 2.8rem;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 16px 0;
      letter-spacing: -0.03em;
      position: relative;
    }
    
    .page-header h2::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #f093fb 50%, #4facfe 100%);
      border-radius: 2px;
    }
    
    .page-subtitle {
      font-size: 1.2rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0;
      font-weight: 500;
    }
    
    /* ê´€ë¦¬ì íˆ´ë°” */
    .admin-toolbar {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.06), 0 6px 16px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
    }
    
    .admin-toolbar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 33%, #f093fb 66%, #f5576c 100%);
      opacity: 0.8;
    }
    
    .toolbar-row {
      display: grid;
      grid-template-columns: 2fr 2fr 1fr;
      gap: 24px;
      align-items: center;
      margin-bottom: 24px;
    }
    
    /* ê²€ìƒ‰ ê·¸ë£¹ */
    .search-group {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .search-input {
      width: 100%;
      padding: 16px 50px 16px 20px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(8px);
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .search-input:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.5);
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.95) 100%);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), inset 0 2px 12px rgba(0,0,0,0.06);
      transform: translateY(-2px);
    }
    
    .search-input::placeholder {
      color: rgba(102, 126, 234, 0.5);
      font-style: italic;
    }
    
    .search-clear {
      position: absolute;
      right: 16px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      font-size: 16px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-clear:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      transform: scale(1.1);
    }
    
    /* í•„í„° ê·¸ë£¹ */
    .filter-group {
      display: flex;
      gap: 16px;
    }
    
    .filter-select {
      padding: 14px 18px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(8px);
      cursor: pointer;
      min-width: 160px;
      color: var(--text-primary);
    }
    
    .filter-select:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.5);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }
    
    .filter-select:hover {
      border-color: rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 100%);
    }
    
    /* ì•¡ì…˜ ê·¸ë£¹ */
    .action-group {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: flex-end;
    }
    
    .refresh-btn {
      width: 48px;
      height: 48px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(8px);
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
    }
    
    .refresh-btn:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: rotate(180deg) scale(1.1);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      border-color: transparent;
    }
    
    .result-count {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%);
      color: #667eea;
      padding: 12px 20px;
      border-radius: 16px;
      font-size: 1rem;
      font-weight: 700;
      border: 2px solid rgba(102, 126, 234, 0.2);
      white-space: nowrap;
      backdrop-filter: blur(8px);
    }
    
    /* í€µ í•„í„° */
    .quick-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .quick-filter {
      padding: 10px 20px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 600;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      position: relative;
      overflow: hidden;
    }
    
    .quick-filter::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s ease;
    }
    
    .quick-filter:hover::before {
      left: 100%;
    }
    
    .quick-filter:hover {
      border-color: rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .quick-filter.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px) scale(1.05);
    }
    
    /* ë©”ì´íŠ¸ ê·¸ë¦¬ë“œ */
    .mates-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
      gap: 20px; 
      margin-bottom: 40px;
    }
    
    /* ë©”ì´íŠ¸ ì¹´ë“œ */
    .mate-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    
    .mate-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 40%, #f093fb 80%, #f5576c 100%);
      opacity: 0.6;
    }
    
    .mate-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 20px 48px rgba(0,0,0,0.12), 0 8px 20px rgba(0,0,0,0.08);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    .mate-card:hover::before {
      opacity: 1;
      height: 4px;
    }
    
    .mate-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.05) 100%);
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 16px 40px rgba(102, 126, 234, 0.2);
    }
    
    .mate-card.selected::before {
      opacity: 1;
      height: 5px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    
    /* ë©”ì´íŠ¸ í—¤ë” */
    .mate-header {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .mate-avatar {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.6);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .mate-card:hover .mate-avatar {
      transform: scale(1.05);
      box-shadow: 0 12px 28px rgba(0,0,0,0.15);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    .mate-info {
      flex: 1;
    }
    
    .mate-name {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 8px 0;
      letter-spacing: -0.01em;
    }
    
    .mate-meta {
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 12px;
    }
    
    .mate-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* ê²€ì¦ ë°°ì§€ */
    .verify-badge {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .verify-badge.verified {
      background: linear-gradient(135deg, #d1e7dd 0%, #a3e4d7 100%);
      color: #0f5132;
      border-color: rgba(25, 135, 84, 0.3);
      box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
    }
    
    .verify-badge.unverified {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border-color: rgba(255, 193, 7, 0.3);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
    }
    
    .rating-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* í†µê³„ */
    .mate-stats {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 16px 0;
    }
    
    .stat-pill {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      backdrop-filter: blur(6px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    /* ì•¡ì…˜ ë²„íŠ¼ */
    .mate-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      color: var(--text-primary);
      border: 2px solid rgba(102, 126, 234, 0.2);
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 100%);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      border-color: rgba(102, 126, 234, 0.4);
    }
    
    .btn-verify {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
    }
    
    .btn-verify:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(240, 147, 251, 0.4);
    }
    
    /* ì˜ˆì•½ í…Œì´ë¸” ì„¹ì…˜ */
    .bookings-section {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.06), 0 6px 16px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
    }
    
    .bookings-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 33%, #f093fb 66%, #f5576c 100%);
      opacity: 0.8;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .section-title {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .section-title::before {
      content: '';
      width: 4px;
      height: 28px;
      background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .export-btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .export-btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(79, 172, 254, 0.4);
    }
    
    /* í…Œì´ë¸” */
    .table-container {
      background: rgba(255,255,255,0.8);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      border: 1px solid rgba(255,255,255,0.6);
    }
    
    .table { 
      width: 100%; 
      border-collapse: collapse; 
      background: transparent;
    }
    
    .table th {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%);
      color: var(--text-primary);
      padding: 16px 12px;
      font-weight: 800;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      text-align: center;
    }
    
    .table td {
      padding: 14px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      font-size: 0.9rem;
      font-weight: 500;
      vertical-align: middle;
      text-align: center;
    }
    
    .table tr:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(240, 147, 251, 0.02) 100%);
    }
    
    .table .amount {
      font-weight: 700;
      color: var(--primary-color);
    }
    
    /* ìƒíƒœ ë°°ì§€ (í…Œì´ë¸”ìš©) */
    .table-status-badge {
      padding: 6px 12px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 2px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      min-width: 80px;
      justify-content: center;
    }
    
    .table-status-pending {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border-color: rgba(255, 193, 7, 0.3);
    }
    
    .table-status-confirmed {
      background: linear-gradient(135deg, #d1e7dd 0%, #a3e4d7 100%);
      color: #0f5132;
      border-color: rgba(25, 135, 84, 0.3);
    }
    
    .table-status-completed {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .table-status-declined {
      background: linear-gradient(135deg, #f8d7da 0%, #f1948a 100%);
      color: #721c24;
      border-color: rgba(220, 53, 69, 0.3);
    }
    
    .table-status-cancelled {
      background: linear-gradient(135deg, #e2e3e5 0%, #ced4da 100%);
      color: #495057;
      border-color: rgba(108, 117, 125, 0.3);
    }
    
    /* ìƒíƒœ í‘œì‹œ */
    .muted { 
      color: var(--text-secondary); 
      font-style: italic;
      text-align: center;
      padding: 40px 20px;
    }
    
    .error { 
      color: #dc3545; 
      background: linear-gradient(135deg, #f8d7da 0%, #f1948a 100%);
      padding: 16px 20px;
      border-radius: 12px;
      border: 2px solid rgba(220, 53, 69, 0.3);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
    }
    
    .success { 
      color: #198754; 
      background: linear-gradient(135deg, #d1f2eb 0%, #a3e4d7 100%);
      padding: 16px 20px;
      border-radius: 12px;
      border: 2px solid rgba(25, 135, 84, 0.3);
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
    }
    
    /* ë¡œë”© ìƒíƒœ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(102, 126, 234, 0.2);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
    .toast {
      position: fixed;
      left: 50%;
      top: 20px;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      z-index: 9999;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 1024px) {
      .admin-wrap {
        padding: 0 16px;
        margin: 24px auto;
      }
      
      .page-header {
        padding: 28px;
        border-radius: 20px;
      }
      
      .page-header h2 {
        font-size: 2.2rem;
      }
      
      .mates-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
      }
      
      .admin-toolbar {
        padding: 24px;
        border-radius: 20px;
      }
      
      .toolbar-row {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .filter-group {
        flex-direction: column;
        gap: 12px;
      }
      
      .action-group {
        justify-content: center;
      }
    }
    
    @media (max-width: 768px) {
      .page-header h2 {
        font-size: 1.8rem;
      }
      
      .mates-grid {
        grid-template-columns: 1fr;
      }
      
      .mate-card {
        padding: 20px;
      }
      
      .mate-header {
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
      
      .mate-actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .quick-filters {
        justify-content: center;
      }
      
      .section-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .table-container {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body class="bg-cream">
  <!-- ë°°ê²½ ì¥ì‹ ìš”ì†Œ -->
  <div class="decorative-bg">
    <div class="decorative-element"></div>
    <div class="decorative-element"></div>
    <div class="decorative-element"></div>
  </div>

  <div id="app-nav"></div>
  
  <main class="admin-wrap">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <section class="page-header">
      <h2>ğŸ› ï¸ ë©”ì´íŠ¸ ê´€ë¦¬</h2>
      <p class="page-subtitle">ë©”ì´íŠ¸ì˜ í”„ë¡œí•„, ê²€ì¦ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê³  ì‹¤ì ì„ í™•ì¸í•˜ì„¸ìš”</p>
      <div id="adminGuard" class="error" style="display:none; margin-top: 16px;"></div>
    </section>

    <!-- ê´€ë¦¬ì íˆ´ë°” -->
    <section class="admin-toolbar">
      <div class="toolbar-row">
        <div class="search-group">
          <input class="search-input" id="searchInput" type="text" placeholder="ğŸ” ì´ë¦„, íƒœê·¸, ì§€ì—­ìœ¼ë¡œ ê²€ìƒ‰..."/>
          <button class="search-clear" id="clearSearch" title="ê²€ìƒ‰ ì´ˆê¸°í™”">âœ•</button>
        </div>
        
        <div class="filter-group">
          <select class="filter-select" id="filterVerified">
            <option value="">ğŸ” ê²€ì¦ ìƒíƒœ: ì „ì²´</option>
            <option value="true">âœ… ê²€ì¦ë¨ë§Œ</option>
            <option value="false">â³ ë¯¸ê²€ì¦ë§Œ</option>
          </select>
          
          <select class="filter-select" id="sortBy">
            <option value="rating_desc">â­ í‰ì  ë†’ì€ìˆœ</option>
            <option value="rating_asc">â­ í‰ì  ë‚®ì€ìˆœ</option>
            <option value="bookings_desc">ğŸ“Š ì˜ˆì•½ ë§ì€ìˆœ</option>
            <option value="name_asc">ğŸ“ ì´ë¦„ìˆœ</option>
          </select>
        </div>
        
        <div class="action-group">
          <button class="refresh-btn" id="refreshBtn" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
          <span class="result-count" id="resultCount">ì´ 0ëª…</span>
        </div>
      </div>
      
      <div class="quick-filters">
        <button class="quick-filter active" data-filter="all">ğŸ‘¥ ì „ì²´</button>
        <button class="quick-filter" data-filter="verified">âœ… ê²€ì¦ë¨</button>
        <button class="quick-filter" data-filter="unverified">â³ ë¯¸ê²€ì¦</button>
        <button class="quick-filter" data-filter="high-rating">â­ ê³ í‰ì </button>
        <button class="quick-filter" data-filter="active">ğŸ”¥ í™œë°œí•¨</button>
      </div>
    </section>

    <!-- ë©”ì´íŠ¸ ê·¸ë¦¬ë“œ -->
    <section>
      <div id="mates" class="mates-grid"></div>
    </section>

    <!-- ì˜ˆì•½ ëª©ë¡ ì„¹ì…˜ -->
    <section class="bookings-section">
      <div class="section-header">
        <h3 class="section-title">ğŸ“‹ ì„ íƒí•œ ë©”ì´íŠ¸ì˜ ì˜ˆì•½ ëª©ë¡</h3>
        <button class="export-btn" id="btnExport">
          <span>ğŸ“Š</span>
          CSV ë‚´ë³´ë‚´ê¸°
        </button>
      </div>
      
      <div id="bookingsError" class="error" style="display: none;"></div>
      <div id="selMateLabel" class="muted" style="margin-bottom: 16px;"></div>
      
      <div class="table-container">
        <table class="table" id="bookingsTable" aria-label="ì˜ˆì•½ ëª©ë¡">
          <thead>
            <tr>
              <th>ğŸ“‹ ì˜ˆì•½ID</th>
              <th>ğŸ“… ì‹œì‘</th>
              <th>â° ì¢…ë£Œ</th>
              <th>ğŸ“Š ìƒíƒœ</th>
              <th>ğŸ‘¤ ê³ ê°</th>
              <th>ğŸ’° ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody id="bookingsBody">
            <tr><td colspan="6" class="muted">ë©”ì´íŠ¸ ì¹´ë“œë¥¼ ì„ íƒí•˜ë©´ ì˜ˆì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const SUPABASE_URL = "https://eevvgbbokenpjnvtmztk.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM ìš”ì†Œë“¤
  const adminGuard = document.getElementById('adminGuard');
  const matesEl = document.getElementById('mates');
  const bookingsBody = document.getElementById('bookingsBody');
  const bookingsError = document.getElementById('bookingsError');
  const selMateLabel = document.getElementById('selMateLabel');
  const resultCount = document.getElementById('resultCount');

  const searchInput = document.getElementById('searchInput');
  const clearSearch = document.getElementById('clearSearch');
  const filterVerified = document.getElementById('filterVerified');
  const sortBy = document.getElementById('sortBy');
  const refreshBtn = document.getElementById('refreshBtn');
  const btnExport = document.getElementById('btnExport');
  const quickFilters = document.querySelectorAll('.quick-filter');

  // 1) ì ‘ê·¼ ì œì–´: ê´€ë¦¬ìë§Œ
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    adminGuard.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦";
    adminGuard.style.display = 'block';
    const redir = encodeURIComponent(location.pathname.replace(/^\//, '') + location.search);
    setTimeout(() => location.replace('auth_combo.html?redirect=' + redir), 800);
    throw new Error('login required');
  }
  
  const { data: isAdminRow } = await supabase.from('admin_users').select('user_id').eq('user_id', user.id).maybeSingle();
  if (!isAdminRow) {
    adminGuard.textContent = "ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    adminGuard.style.display = 'block';
    throw new Error('admin required');
  }

  // 2) ìƒíƒœ ë³€ìˆ˜
  let allMates = [];
  let filteredMates = [];
  let allBookings = [];
  let selectedMateId = null;

  // 3) ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
  const yenFmt = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 });
  
  function formatDateTime(dateStr, timeStr) {
    try {
      if (!dateStr || !timeStr) return 'ë‚ ì§œ ë¯¸ì •';
      
      const dateObj = new Date(dateStr);
      const dateFormatted = dateObj.toLocaleDateString('ko-KR', { 
        month: 'short', 
        day: 'numeric',
        weekday: 'short'
      });
      
      // ì‹œê°„ í¬ë§·íŒ… (24ì‹œê°„ â†’ 12ì‹œê°„)
      const [hour, minute] = timeStr.split(':');
      const hourNum = parseInt(hour, 10);
      const period = hourNum >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
      const displayHour = hourNum === 0 ? 12 : hourNum > 12 ? hourNum - 12 : hourNum;
      const timeFormatted = `${period} ${displayHour}:${minute}`;
      
      return `${dateFormatted} ${timeFormatted}`;
    } catch (e) {
      return `${dateStr} ${timeStr}`;
    }
  }
  
  function calculateEndTime(dateStr, timeStr, durationHours) {
    try {
      if (!dateStr || !timeStr || !durationHours) return 'ì¢…ë£Œì‹œê°„ ë¯¸ì •';
      
      const startDateTime = new Date(`${dateStr}T${timeStr}`);
      const endDateTime = new Date(startDateTime.getTime() + (durationHours * 60 * 60 * 1000));
      
      const [hour, minute] = endDateTime.toTimeString().split(':');
      const hourNum = parseInt(hour, 10);
      const period = hourNum >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
      const displayHour = hourNum === 0 ? 12 : hourNum > 12 ? hourNum - 12 : hourNum;
      
      return `${period} ${displayHour}:${minute}`;
    } catch (e) {
      return 'ê³„ì‚° ì˜¤ë¥˜';
    }
  }
  
  function amountText(booking) {
    const val = booking.price_total ?? booking.total_price ?? booking.amount ?? null;
    const cur = (booking.currency || 'JPY').toUpperCase();
    if (val == null) return '-';
    try {
      if (cur === 'JPY') return yenFmt.format(val);
      return new Intl.NumberFormat(undefined, { style: 'currency', currency: cur }).format(val);
    } catch {
      return String(val);
    }
  }

  function keyToUrl(key) {
    if (!key) return 'https://picsum.photos/seed/puzzmi/200/200';
    if (/^https?:\/\//i.test(key)) return key;
    const pure = key.startsWith('mates/') ? key.replace(/^mates\//, '') : key;
    return supabase.storage.from('mates').getPublicUrl(pure).data.publicUrl;
  }

  function toast(message) {
    const toastEl = document.createElement('div');
    toastEl.className = 'toast';
    toastEl.textContent = message;
    document.body.appendChild(toastEl);
    setTimeout(() => toastEl.remove(), 3000);
  }

  // 4) ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
  async function loadMatesAndBookings() {
    matesEl.innerHTML = '<div class="muted" style="padding: 40px; text-align: center;"><div class="loading" style="margin: 0 auto 16px;"></div>ë©”ì´íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

    try {
      // ë©”ì´íŠ¸ ë°ì´í„° ë¡œë“œ
      let mpQuery = supabase
        .from('mate_profiles')
        .select(`
          user_id, is_verified, rating, tags, areas, bio, photos, primary_photo,
          profiles ( id, full_name, age, gender, languages, avatar_url )
        `)
        .order('rating', { ascending: false })
        .limit(200);

      const { data: matesData, error: matesErr } = await mpQuery;
      if (matesErr) throw matesErr;

      allMates = matesData || [];

      // ì˜ˆì•½ ë°ì´í„° ë¡œë“œ
      const mateIds = allMates.map(m => m.user_id);
      if (mateIds.length > 0) {
        const { data: bookingsData, error: bookingsErr } = await supabase
          .from('bookings')
          .select('*')
          .in('mate_id', mateIds)
          .limit(2000);
        
        if (bookingsErr) {
          console.warn('ì˜ˆì•½ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', bookingsErr);
          allBookings = [];
        } else {
          allBookings = bookingsData || [];
        }
      } else {
        allBookings = [];
      }

      applyFilters();
    } catch (error) {
      console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      matesEl.innerHTML = `<div class="error">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
    }
  }

  function applyFilters() {
    const searchTerm = (searchInput?.value || '').trim().toLowerCase();
    const verifiedFilter = filterVerified?.value || '';
    const sortOption = sortBy?.value || 'rating_desc';

    // ê²€ì¦ ìƒíƒœ í•„í„°ë§
    filteredMates = allMates.filter(mate => {
      if (verifiedFilter === 'true') return mate.is_verified === true;
      if (verifiedFilter === 'false') return mate.is_verified !== true;
      return true;
    });

    // ê²€ìƒ‰ì–´ í•„í„°ë§
    if (searchTerm) {
      filteredMates = filteredMates.filter(mate => {
        const name = (mate.profiles?.full_name || '').toLowerCase();
        const tags = (Array.isArray(mate.tags) ? mate.tags.join(' ') : '').toLowerCase();
        const areas = (Array.isArray(mate.areas) ? mate.areas.join(' ') : '').toLowerCase();
        return name.includes(searchTerm) || tags.includes(searchTerm) || areas.includes(searchTerm);
      });
    }

    // ì •ë ¬
    filteredMates.sort((a, b) => {
      const aBookings = allBookings.filter(bk => bk.mate_id === a.user_id);
      const bBookings = allBookings.filter(bk => bk.mate_id === b.user_id);
      
      switch (sortOption) {
        case 'rating_desc':
          return (b.rating || 0) - (a.rating || 0);
        case 'rating_asc':
          return (a.rating || 0) - (b.rating || 0);
        case 'bookings_desc':
          return bBookings.length - aBookings.length;
        case 'name_asc':
          const aName = a.profiles?.full_name || '';
          const bName = b.profiles?.full_name || '';
          return aName.localeCompare(bName);
        default:
          return (b.rating || 0) - (a.rating || 0);
      }
    });

    renderMates();
  }

  function renderMates() {
    resultCount.textContent = `ì´ ${filteredMates.length}ëª…`;
    
    if (!filteredMates.length) {
      matesEl.innerHTML = '<div class="muted" style="padding: 40px;">ğŸ” ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ë©”ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    matesEl.innerHTML = filteredMates.map(mate => {
      const p = mate.profiles || {};
      const coverPhoto = mate.primary_photo || 
                        (Array.isArray(mate.photos) && mate.photos[0]) || 
                        p.avatar_url;
      const img = keyToUrl(coverPhoto);
      const name = p.full_name || '(ì´ë¦„ì—†ìŒ)';
      const age = p.age ? `${p.age}ì„¸` : '';
      const gender = p.gender || '';
      const langs = Array.isArray(p.languages) ? p.languages.join(', ') : '';
      const rating = mate.rating ?? 0;

      const mateBookings = allBookings.filter(b => b.mate_id === mate.user_id);
      const total = mateBookings.length;
      const upcoming = mateBookings.filter(b => {
        if (!b.date || !b.start_time) return false;
        const startTime = new Date(`${b.date}T${b.start_time}`);
        return startTime.getTime() >= Date.now();
      }).length;
      
      const byStatus = mateBookings.reduce((acc, b) => {
        const status = b.status || 'unknown';
        acc[status] = (acc[status] || 0) + 1;
        return acc;
      }, {});

      return `
        <div class="mate-card" data-mate="${mate.user_id}">
          <div class="mate-header">
            <img class="mate-avatar" src="${img}" alt="avatar"/>
            <div class="mate-info">
              <div class="mate-name">${name}</div>
              <div class="mate-meta">${[age, gender, langs].filter(Boolean).join(' â€¢ ') || 'ì •ë³´ ë¯¸ê¸°ì¬'}</div>
              <div class="mate-badges">
                <span class="verify-badge ${mate.is_verified ? 'verified' : 'unverified'}">
                  ${mate.is_verified ? 'âœ… ê²€ì¦ë¨' : 'â³ ë¯¸ê²€ì¦'}
                </span>
                <span class="rating-badge">
                  <span>â­</span>
                  <span>${rating.toFixed(1)}</span>
                </span>
              </div>
            </div>
          </div>
          
          <div class="mate-stats">
            <span class="stat-pill">ğŸ“Š ì´ì˜ˆì•½ ${total}</span>
            <span class="stat-pill">ğŸ“… ì˜ˆì • ${upcoming}</span>
            ${Object.entries(byStatus).map(([status, count]) => 
              `<span class="stat-pill">${getStatusEmoji(status)} ${getStatusText(status)} ${count}</span>`
            ).join('')}
          </div>
          
          <div class="mate-actions">
            <a class="btn btn-secondary" href="mate_like.html?mate_id=${mate.user_id}" target="_blank">
              <span>ğŸ‘ï¸</span> í”„ë¡œí•„ ë³´ê¸°
            </a>
            <button class="btn btn-primary" data-action="show-bookings" data-id="${mate.user_id}">
              <span>ğŸ“‹</span> ì˜ˆì•½ ë³´ê¸°
            </button>
            <button class="btn btn-verify" data-action="toggle-verify" data-id="${mate.user_id}">
              <span>${mate.is_verified ? 'âŒ' : 'âœ…'}</span>
              ${mate.is_verified ? 'ê²€ì¦ í•´ì œ' : 'ê²€ì¦ ì²˜ë¦¬'}
            </button>
          </div>
        </div>
      `;
    }).join('');

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    matesEl.querySelectorAll('[data-action="show-bookings"]').forEach(btn => {
      btn.addEventListener('click', () => {
        // ì´ì „ ì„ íƒ í•´ì œ
        document.querySelectorAll('.mate-card.selected').forEach(card => {
          card.classList.remove('selected');
        });
        
        // í˜„ì¬ ì¹´ë“œ ì„ íƒ
        const card = btn.closest('.mate-card');
        card.classList.add('selected');
        
        showBookings(btn.getAttribute('data-id'));
      });
    });

    matesEl.querySelectorAll('[data-action="toggle-verify"]').forEach(btn => {
      btn.addEventListener('click', () => toggleVerify(btn.getAttribute('data-id')));
    });
  }

  function getStatusEmoji(status) {
    switch (status) {
      case 'pending': return 'â³';
      case 'confirmed': return 'âœ…';
      case 'completed': return 'ğŸ‰';
      case 'declined': return 'âŒ';
      case 'cancelled': return 'ğŸš«';
      default: return 'â“';
    }
  }
  
  function getStatusText(status) {
    switch (status) {
      case 'pending': return 'ëŒ€ê¸°ì¤‘';
      case 'confirmed': return 'ì˜ˆì•½ í™•ì •';
      case 'completed': return 'ì§„í–‰ ì™„ë£Œ';
      case 'cancelled': return 'ì˜ˆì•½ ì·¨ì†Œ';
      default: return status || 'ë¯¸ì •';
    }
  }
  
  function getStatusClass(status) {
    switch (status) {
      case 'pending': return 'table-status-pending';
      case 'confirmed': return 'table-status-confirmed';
      case 'completed': return 'table-status-completed';
      case 'cancelled': return 'table-status-declined';
      default: return 'table-status-pending';
    }
  }

  async function toggleVerify(mateId) {
    const mate = allMates.find(x => x.user_id === mateId);
    if (!mate) return;
    
    const newStatus = !mate.is_verified;
    const confirmMsg = newStatus ? 
      'ì´ ë©”ì´íŠ¸ë¥¼ ê²€ì¦ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 
      'ì´ ë©”ì´íŠ¸ì˜ ê²€ì¦ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
    
    if (!confirm(confirmMsg)) return;

    try {
      const { error } = await supabase
        .from('mate_profiles')
        .update({ is_verified: newStatus })
        .eq('user_id', mateId);
      
      if (error) throw error;
      
      mate.is_verified = newStatus;
      toast(newStatus ? 'âœ… ê²€ì¦ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'âŒ ê²€ì¦ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
      applyFilters();
    } catch (error) {
      console.error('ê²€ì¦ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
      toast('âŒ ê²€ì¦ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
    }
  }

  async function showBookings(mateId) {
    selectedMateId = mateId;
    const mate = allMates.find(m => m.user_id === mateId);
    const mateName = mate?.profiles?.full_name || mateId;
    selMateLabel.textContent = `${mateName}ë‹˜ì˜ ì˜ˆì•½ ëª©ë¡`;
    selMateLabel.style.display = 'block';

    bookingsError.style.display = 'none';
    const rows = allBookings.filter(b => b.mate_id === mateId);

    if (!rows.length) {
      bookingsBody.innerHTML = `<tr><td colspan="6" class="muted">ğŸ“­ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    // ê³ ê° ì •ë³´ ë¡œë“œ
    const customerIds = [...new Set(rows.map(b => b.customer_id).filter(Boolean))];
    let profileMap = {};
    if (customerIds.length) {
      const { data: profs, error: perr } = await supabase
        .from('profiles')
        .select('id, full_name, email');
      if (!perr && profs) {
        profileMap = Object.fromEntries(profs.map(p => [p.id, (p.full_name || p.email || p.id)]));
      }
    }

    // ì˜ˆì•½ ëª©ë¡ ë Œë”ë§
    bookingsBody.innerHTML = rows
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .map(booking => {
        const startFormatted = formatDateTime(booking.date, booking.start_time);
        const endFormatted = calculateEndTime(booking.date, booking.start_time, booking.duration_hours);
        const customer = profileMap[booking.customer_id] || booking.customer_name || 'ê³ ê°';
        const statusText = getStatusText(booking.status);
        const statusClass = getStatusClass(booking.status);
        
        return `
          <tr>
            <td>#${booking.id || ''}</td>
            <td>${startFormatted}</td>
            <td>${endFormatted}</td>
            <td><span class="table-status-badge ${statusClass}">${statusText}</span></td>
            <td>${customer}</td>
            <td class="amount">${amountText(booking)}</td>
          </tr>
        `;
      }).join('');
  }

  // 5) ê²€ìƒ‰ ë° í•„í„° ì´ë²¤íŠ¸
  let searchTimeout;
  searchInput?.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 300);
  });

  clearSearch?.addEventListener('click', () => {
    searchInput.value = '';
    applyFilters();
  });

  filterVerified?.addEventListener('change', applyFilters);
  sortBy?.addEventListener('change', applyFilters);

  refreshBtn?.addEventListener('click', async () => {
    refreshBtn.style.transform = 'rotate(360deg)';
    await loadMatesAndBookings();
    setTimeout(() => {
      refreshBtn.style.transform = '';
    }, 300);
  });

  // í€µ í•„í„°
  quickFilters.forEach(btn => {
    btn.addEventListener('click', () => {
      quickFilters.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      const filter = btn.getAttribute('data-filter');
      
      switch (filter) {
        case 'all':
          filteredMates = [...allMates];
          break;
        case 'verified':
          filteredMates = allMates.filter(mate => mate.is_verified === true);
          break;
        case 'unverified':
          filteredMates = allMates.filter(mate => mate.is_verified !== true);
          break;
        case 'high-rating':
          filteredMates = allMates.filter(mate => (mate.rating || 0) >= 4.0);
          break;
        case 'active':
          const activeIds = new Set();
          const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
          allBookings.forEach(booking => {
            if (new Date(booking.created_at) >= thirtyDaysAgo) {
              activeIds.add(booking.mate_id);
            }
          });
          filteredMates = allMates.filter(mate => activeIds.has(mate.user_id));
          break;
        default:
          filteredMates = [...allMates];
      }
      
      // ê¸°ì¡´ ê²€ìƒ‰ì–´ì™€ í•„í„° ë‹¤ì‹œ ì ìš©
      const searchTerm = (searchInput?.value || '').trim().toLowerCase();
      const verifiedFilter = filterVerified?.value || '';
      
      if (verifiedFilter) {
        filteredMates = filteredMates.filter(mate => {
          if (verifiedFilter === 'true') return mate.is_verified === true;
          if (verifiedFilter === 'false') return mate.is_verified !== true;
          return true;
        });
      }
      
      if (searchTerm) {
        filteredMates = filteredMates.filter(mate => {
          const name = (mate.profiles?.full_name || '').toLowerCase();
          const tags = (Array.isArray(mate.tags) ? mate.tags.join(' ') : '').toLowerCase();
          const areas = (Array.isArray(mate.areas) ? mate.areas.join(' ') : '').toLowerCase();
          return name.includes(searchTerm) || tags.includes(searchTerm) || areas.includes(searchTerm);
        });
      }
      
      renderMates();
    });
  });

  // CSV ë‚´ë³´ë‚´ê¸°
  btnExport?.addEventListener('click', () => {
    if (!selectedMateId) {
      toast('âŒ ë¨¼ì € ë©”ì´íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const rows = allBookings.filter(b => b.mate_id === selectedMateId);
    if (!rows.length) {
      toast('âŒ ë‚´ë³´ë‚¼ ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const headers = ['ì˜ˆì•½ID', 'ì‹œì‘ì¼ì‹œ', 'ì¢…ë£Œì‹œê°„', 'ìƒíƒœ', 'ê³ ê°ëª…', 'ì—°ë½ì²˜', 'ì–¸ì–´', 'ìš”ì²­ì‚¬í•­', 'ìƒì„±ì¼'];
    const csvData = [
      headers.join(','),
      ...rows.map(row => {
        const values = [
          row.id || '',
          formatDateTime(row.date, row.start_time),
          calculateEndTime(row.date, row.start_time, row.duration_hours),
          row.status || '',
          row.customer_name || '',
          row.customer_contact || '',
          row.language || '',
          (row.notes || '').replace(/"/g, '""'),
          new Date(row.created_at).toLocaleString('ko-KR')
        ];
        return values.map(v => `"${v}"`).join(',');
      })
    ].join('\n');

    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mate_${selectedMateId}_bookings.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    toast('ğŸ“Š CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
  });

  // ì´ˆê¸° ë¡œë“œ
  await loadMatesAndBookings();
</script>
</body>
</html>