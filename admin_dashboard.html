<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUZZMI ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body { background: #f5f7fa; min-height: 100vh; }

    /* í—¤ë” */
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .admin-header h1 {
      max-width: 1400px;
      margin: 0 auto;
      font-size: 2rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
    .tab-nav {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .tab-nav-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: 0;
      padding: 0 20px;
      overflow-x: auto;
    }
    .tab-button {
      padding: 20px 32px;
      border: none;
      background: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab-button:hover {
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }
    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    /* ì»¨í…ì¸  ì˜ì—­ */
    .tab-content {
      display: none;
      max-width: 1400px;
      margin: 32px auto;
      padding: 0 20px;
    }
    .tab-content.active {
      display: block;
    }

    /* ì¹´ë“œ */
    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    .card h2 {
      margin: 0 0 24px 0;
      font-size: 1.5rem;
      font-weight: 800;
      color: #333;
    }

    /* í…Œì´ë¸” */
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th {
      background: #f8f9fa;
      padding: 16px 12px;
      text-align: left;
      font-weight: 700;
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      border-bottom: 2px solid #e9ecef;
    }
    td {
      padding: 16px 12px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }
    tr:hover {
      background: #f8f9fa;
    }

    /* ë²„íŠ¼ */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }

    /* ë°°ì§€ */
    .badge {
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }
    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-confirmed { background: #d1e7dd; color: #0f5132; }
    .badge-completed { background: #cfe2ff; color: #084298; }
    .badge-cancelled { background: #f8d7da; color: #721c24; }

    /* íˆ´ë°” */
    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .toolbar input, .toolbar select {
      padding: 10px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .toolbar input:focus, .toolbar select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* ë¡œë”© */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .loading i {
      font-size: 2rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .admin-header h1 {
        font-size: 1.5rem;
      }
      .tab-button {
        padding: 16px 20px;
        font-size: 0.9rem;
      }
      .card {
        padding: 20px;
      }
      table {
        font-size: 0.85rem;
      }
      th, td {
        padding: 12px 8px;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="admin-header">
    <h1>
      <i class="fas fa-crown"></i>
      PUZZMI ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
    </h1>
  </header>

  <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="tab-nav">
    <div class="tab-nav-inner">
      <button class="tab-button active" data-tab="bookings">
        <i class="fas fa-calendar-check"></i> ì˜ˆì•½ ê´€ë¦¬
      </button>
      <button class="tab-button" data-tab="mates">
        <i class="fas fa-users"></i> ë©”ì´íŠ¸ ê´€ë¦¬
      </button>
      <button class="tab-button" data-tab="identity">
        <i class="fas fa-id-card"></i> ë³¸ì¸ì¸ì¦ ê´€ë¦¬
      </button>
      <button class="tab-button" data-tab="payments">
        <i class="fas fa-credit-card"></i> ê²°ì œ ê´€ë¦¬
      </button>
    </div>
  </nav>

  <!-- ì˜ˆì•½ ê´€ë¦¬ íƒ­ -->
  <div class="tab-content active" id="tab-bookings">
    <div class="card">
      <h2>ì˜ˆì•½ ê´€ë¦¬</h2>

      <div class="toolbar">
        <select id="statusFilter">
          <option value="pending">ëŒ€ê¸°ì¤‘</option>
          <option value="confirmed">í™•ì •</option>
          <option value="completed">ì™„ë£Œ</option>
          <option value="declined">ê±°ì ˆ</option>
          <option value="cancelled">ì·¨ì†Œ</option>
          <option value="all">ì „ì²´</option>
        </select>
        <input id="searchBooking" placeholder="ê³ ê°ëª…, ì—°ë½ì²˜ ê²€ìƒ‰..." style="flex: 1; max-width: 400px;"/>
        <button class="btn btn-primary" id="refreshBookings">
          <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ìƒíƒœ</th>
              <th>ì¼ì‹œ</th>
              <th>ê³ ê°</th>
              <th>ì—°ë½ì²˜</th>
              <th>ë©”ì´íŠ¸</th>
              <th>LINE</th>
              <th>ì¡°ì¹˜</th>
            </tr>
          </thead>
          <tbody id="bookingsTableBody">
            <tr><td colspan="8" class="loading"><i class="fas fa-spinner"></i> ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ë©”ì´íŠ¸ ê´€ë¦¬ íƒ­ -->
  <div class="tab-content" id="tab-mates">
    <div class="card">
      <h2>ë©”ì´íŠ¸ ê´€ë¦¬</h2>

      <div class="toolbar">
        <select id="verifyFilter">
          <option value="">ê²€ì¦ ìƒíƒœ: ì „ì²´</option>
          <option value="true">ê²€ì¦ë¨ë§Œ</option>
          <option value="false">ë¯¸ê²€ì¦ë§Œ</option>
        </select>
        <input id="searchMate" placeholder="ì´ë¦„, íƒœê·¸ ê²€ìƒ‰..." style="flex: 1; max-width: 400px;"/>
        <button class="btn btn-primary" id="refreshMates">
          <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <div id="matesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        <div class="loading"><i class="fas fa-spinner"></i> ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- ë³¸ì¸ì¸ì¦ ê´€ë¦¬ íƒ­ -->
  <div class="tab-content" id="tab-identity">
    <div class="card">
      <h2>ë³¸ì¸ì¸ì¦ ê´€ë¦¬</h2>

      <div class="toolbar">
        <select id="identityFilter">
          <option value="all">ì „ì²´</option>
          <option value="pending">ëŒ€ê¸°ì¤‘</option>
          <option value="passport_uploaded">ì‹¬ì‚¬ ëŒ€ê¸°</option>
          <option value="approved">ìŠ¹ì¸ë¨</option>
          <option value="rejected">ê±°ë¶€ë¨</option>
        </select>
        <button class="btn btn-primary" id="refreshIdentity">
          <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <div id="identityRequests">
        <div class="loading"><i class="fas fa-spinner"></i> ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- ê²°ì œ ê´€ë¦¬ íƒ­ -->
  <div class="tab-content" id="tab-payments">
    <div class="card">
      <h2>ê²°ì œ ê´€ë¦¬</h2>

      <div class="toolbar">
        <select id="paymentFilter">
          <option value="all">ì „ì²´</option>
          <option value="pending">ëŒ€ê¸°ì¤‘</option>
          <option value="sent">ë°œì†¡ë¨</option>
          <option value="paid">ê²°ì œ ì™„ë£Œ</option>
          <option value="failed">ì‹¤íŒ¨</option>
          <option value="cancelled">ì·¨ì†Œ</option>
        </select>
        <button class="btn btn-primary" id="refreshPayments">
          <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ì˜ˆì•½ ID</th>
              <th>ê³ ê°</th>
              <th>ê¸ˆì•¡</th>
              <th>ìƒíƒœ</th>
              <th>ìƒì„±ì¼</th>
            </tr>
          </thead>
          <tbody id="paymentsTableBody">
            <tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i> ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://eevvgbbokenpjnvtmztk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      location.replace('auth_combo.html?redirect=admin_dashboard.html');
    }

    const { data: profile } = await supabase
      .from('profiles')
      .select('is_admin')
      .eq('id', user.id)
      .maybeSingle();

    if (!profile?.is_admin) {
      alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      location.replace('index.html');
    }

    // íƒ­ ì „í™˜
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;

        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');

        // íƒ­ ì „í™˜ ì‹œ ë°ì´í„° ë¡œë“œ
        if (tabName === 'bookings') loadBookings();
        else if (tabName === 'mates') loadMates();
        else if (tabName === 'identity') loadIdentity();
        else if (tabName === 'payments') loadPayments();
      });
    });

    // ========== ì˜ˆì•½ ê´€ë¦¬ ==========
    let allBookings = [];
    let matesMap = new Map();
    let lineAccountsMap = new Map();

    async function loadBookings() {
      const tbody = document.getElementById('bookingsTableBody');
      tbody.innerHTML = '<tr><td colspan="8" class="loading"><i class="fas fa-spinner"></i> ë¡œë”© ì¤‘...</td></tr>';

      try {
        // ë©”ì´íŠ¸ ì •ë³´ ë¡œë“œ
        const { data: mates } = await supabase
          .from('mate_profiles')
          .select('user_id, profiles(full_name)');
        if (mates) {
          matesMap = new Map(mates.map(m => [m.user_id, m.profiles?.full_name || m.user_id]));
        }

        // LINE ê³„ì • ì •ë³´ ë¡œë“œ
        const { data: lineAccounts } = await supabase
          .from('user_line_accounts')
          .select('user_id, line_display_name');
        if (lineAccounts) {
          lineAccountsMap = new Map(lineAccounts.map(l => [l.user_id, l.line_display_name]));
        }

        // ì˜ˆì•½ ì •ë³´ ë¡œë“œ
        const { data: bookings, error } = await supabase
          .from('bookings')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(200);

        if (error) throw error;
        allBookings = bookings || [];
        renderBookings();
      } catch (error) {
        console.error('ì˜ˆì•½ ë¡œë“œ ì‹¤íŒ¨:', error);
        tbody.innerHTML = `<tr><td colspan="8" style="color: red; text-align: center; padding: 40px;">âŒ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</td></tr>`;
      }
    }

    function renderBookings() {
      const tbody = document.getElementById('bookingsTableBody');
      const statusFilter = document.getElementById('statusFilter').value;
      const search = document.getElementById('searchBooking').value.toLowerCase();

      let filtered = allBookings.filter(b => {
        if (statusFilter !== 'all' && b.status !== statusFilter) return false;
        if (search && !b.customer_name?.toLowerCase().includes(search) && !b.customer_contact?.toLowerCase().includes(search)) return false;
        return true;
      });

      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(b => {
        const mateName = matesMap.get(b.mate_id) || b.mate_id;
        const lineName = lineAccountsMap.get(b.customer_id);
        const lineStatus = lineName ? `<span style="color: #28a745;">âœ“ ${lineName}</span>` : '<span style="color: #999;">ë¯¸ì—°ë™</span>';

        return `
          <tr>
            <td>#${b.id}</td>
            <td><span class="badge badge-${b.status}">${b.status}</span></td>
            <td>${b.date} ${b.start_time}</td>
            <td>${b.customer_name}</td>
            <td>${b.customer_contact}</td>
            <td>${mateName}</td>
            <td>${lineStatus}</td>
            <td>
              ${lineName ? `
                <button class="btn btn-success" onclick="sendPassportRequest('${b.id}')" style="font-size: 0.8rem; padding: 6px 12px;">
                  ğŸ›‚ ì—¬ê¶Œ
                </button>
                <button class="btn btn-success" onclick="sendPaymentRequest('${b.id}')" style="font-size: 0.8rem; padding: 6px 12px;">
                  ğŸ’³ ê²°ì œ
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    window.sendPassportRequest = async function(bookingId) {
      if (!confirm('ì—¬ê¶Œ ì¸ì¦ ë§í¬ë¥¼ LINEìœ¼ë¡œ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const booking = allBookings.find(b => b.id == bookingId);
      if (!booking) return alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      try {
        const passportUrl = `${location.origin}/passport_verification.html?booking_id=${bookingId}`;
        const { data: { session } } = await supabase.auth.getSession();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-line-notification`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            userId: booking.customer_id,
            bookingId: bookingId,
            type: 'passport_verification',
            passportVerificationUrl: passportUrl
          })
        });

        const result = await response.json();
        if (result.success) {
          alert('âœ“ LINE ë©”ì‹œì§€ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
          alert('ë°œì†¡ ì‹¤íŒ¨: ' + result.error);
        }
      } catch (error) {
        alert('ë°œì†¡ ì‹¤íŒ¨: ' + error.message);
      }
    };

    window.sendPaymentRequest = async function(bookingId) {
      const amount = prompt('ê²°ì œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì›):', '40000');
      if (!amount) return;

      const booking = allBookings.find(b => b.id == bookingId);
      if (!booking) return alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      try {
        const oid = `PUZZMI_${bookingId}_${Date.now()}`;
        const token = crypto.randomUUID();

        const { data: payment } = await supabase
          .from('kg_inicis_payments')
          .insert({
            booking_id: bookingId,
            user_id: booking.customer_id,
            mate_id: booking.mate_id,
            amount: parseInt(amount),
            currency: 'KRW',
            payment_status: 'pending',
            oid: oid,
            payment_token: token,
            buyer_name: booking.customer_name,
            buyer_tel: booking.customer_contact,
            good_name: 'ë Œíƒˆì¹œêµ¬ ì„œë¹„ìŠ¤'
          })
          .select()
          .single();

        const paymentUrl = `${SUPABASE_URL}/functions/v1/inicis-payment-page/${token}`;
        const { data: { session } } = await supabase.auth.getSession();

        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-line-notification`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            userId: booking.customer_id,
            bookingId: bookingId,
            type: 'payment_request',
            paymentUrl: paymentUrl,
            amount: parseInt(amount)
          })
        });

        const result = await response.json();
        if (result.success) {
          alert(`âœ“ ê²°ì œ ìš”ì²­ì´ LINEìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nê¸ˆì•¡: ${parseInt(amount).toLocaleString()}ì›`);
        } else {
          alert('ë°œì†¡ ì‹¤íŒ¨: ' + result.error);
        }
      } catch (error) {
        alert('ë°œì†¡ ì‹¤íŒ¨: ' + error.message);
      }
    };

    document.getElementById('statusFilter').addEventListener('change', renderBookings);
    document.getElementById('searchBooking').addEventListener('input', renderBookings);
    document.getElementById('refreshBookings').addEventListener('click', loadBookings);

    // ========== ë©”ì´íŠ¸ ê´€ë¦¬ ==========
    async function loadMates() {
      const grid = document.getElementById('matesGrid');
      grid.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> ë¡œë”© ì¤‘...</div>';

      try {
        const { data: mates, error } = await supabase
          .from('mate_profiles')
          .select('user_id, is_verified, rating, profiles(full_name, avatar_url)')
          .order('rating', { ascending: false })
          .limit(100);

        if (error) throw error;

        if (!mates || !mates.length) {
          grid.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">ë©”ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        grid.innerHTML = mates.map(mate => `
          <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px;">
              <img src="${mate.profiles?.avatar_url || 'https://picsum.photos/80'}"
                   style="width: 80px; height: 80px; border-radius: 12px; object-fit: cover;" />
              <div>
                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;">${mate.profiles?.full_name || 'ì´ë¦„ì—†ìŒ'}</div>
                <div style="color: #666; font-size: 0.9rem;">â­ ${(mate.rating || 0).toFixed(1)}</div>
                <span class="badge ${mate.is_verified ? 'badge-confirmed' : 'badge-pending'}">
                  ${mate.is_verified ? 'âœ… ê²€ì¦ë¨' : 'â³ ë¯¸ê²€ì¦'}
                </span>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <a href="mate_like.html?mate_id=${mate.user_id}" target="_blank" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; font-size: 0.85rem;">
                í”„ë¡œí•„ ë³´ê¸°
              </a>
              <button class="btn btn-primary" onclick="toggleVerify('${mate.user_id}', ${mate.is_verified})" style="flex: 1; font-size: 0.85rem;">
                ${mate.is_verified ? 'ê²€ì¦ í•´ì œ' : 'ê²€ì¦ ì²˜ë¦¬'}
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        grid.innerHTML = `<div style="color: red; text-align: center; padding: 40px;">âŒ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
      }
    }

    window.toggleVerify = async function(mateId, currentStatus) {
      const newStatus = !currentStatus;
      if (!confirm(newStatus ? 'ê²€ì¦ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ê²€ì¦ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const { error } = await supabase
          .from('mate_profiles')
          .update({ is_verified: newStatus })
          .eq('user_id', mateId);

        if (error) throw error;
        alert(newStatus ? 'âœ… ê²€ì¦ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'âŒ ê²€ì¦ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
        loadMates();
      } catch (error) {
        alert('ì‹¤íŒ¨: ' + error.message);
      }
    };

    document.getElementById('refreshMates').addEventListener('click', loadMates);

    // ========== ë³¸ì¸ì¸ì¦ ê´€ë¦¬ ==========
    async function loadIdentity() {
      const container = document.getElementById('identityRequests');
      container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> ë¡œë”© ì¤‘...</div>';

      try {
        const filter = document.getElementById('identityFilter').value;
        let query = supabase
          .from('identity_verification_requests')
          .select('*')
          .order('created_at', { ascending: false });

        if (filter !== 'all') {
          query = query.eq('status', filter);
        }

        const { data: requests, error } = await query;

        if (error) throw error;

        // í”„ë¡œí•„ ì •ë³´ ë³„ë„ë¡œ ê°€ì ¸ì˜¤ê¸°
        if (requests && requests.length > 0) {
          const userIds = requests.map(r => r.user_id);
          const { data: profiles } = await supabase
            .from('profiles')
            .select('id, full_name, email, phone_number, birth_date')
            .in('id', userIds);

          // í”„ë¡œí•„ ì •ë³´ë¥¼ requestsì— ë³‘í•©
          requests.forEach(req => {
            req.profiles = profiles?.find(p => p.id === req.user_id);
          });
        }
        if (error) throw error;

        if (!requests || !requests.length) {
          container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        container.innerHTML = requests.map(req => {
          const statusLabels = {
            pending: 'ëŒ€ê¸°ì¤‘',
            passport_uploaded: 'ì‹¬ì‚¬ ëŒ€ê¸°',
            approved: 'ìŠ¹ì¸ë¨',
            rejected: 'ê±°ë¶€ë¨'
          };

          return `
            <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                <div>
                  <div style="font-weight: 700; font-size: 1.1rem;">${req.profiles?.full_name || 'Unknown'}</div>
                  <div style="color: #666; font-size: 0.9rem;">
                    <i class="fas fa-envelope"></i> ${req.profiles?.email || 'N/A'}<br>
                    <i class="fas fa-phone"></i> ${req.profiles?.phone_number || 'N/A'}<br>
                    <i class="fas fa-birthday-cake"></i> ${req.profiles?.birth_date || 'N/A'}
                  </div>
                </div>
                <span class="badge badge-${req.status}">${statusLabels[req.status] || req.status}</span>
              </div>

              ${req.passport_image_url ? `
                <img src="${req.passport_image_url}"
                     style="max-width: 400px; width: 100%; border-radius: 8px; margin: 12px 0; cursor: pointer;"
                     onclick="window.open('${req.passport_image_url}', '_blank')" />
              ` : '<div style="padding: 40px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666;">ì—¬ê¶Œ ë¯¸ì—…ë¡œë“œ</div>'}

              ${req.status === 'passport_uploaded' ? `
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                  <form id="approveForm_${req.id}">
                    <div style="margin-bottom: 12px;">
                      <label style="display: block; font-weight: 600; margin-bottom: 4px;">ì´ë¦„ (ì—¬ê¶Œ ê¸°ì¬)</label>
                      <input type="text" name="verified_name" required style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                      <label style="display: block; font-weight: 600; margin-bottom: 4px;">ìƒë…„ì›”ì¼</label>
                      <input type="date" name="verified_birth_date" required style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                      <label style="display: block; font-weight: 600; margin-bottom: 4px;">êµ­ì </label>
                      <input type="text" name="verified_nationality" value="ì¼ë³¸" required style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                      <label style="display: block; font-weight: 600; margin-bottom: 4px;">ê´€ë¦¬ì ë©”ëª¨</label>
                      <textarea name="admin_notes" rows="2" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 8px;">
                      <button type="button" class="btn btn-success" onclick="approveIdentity('${req.id}')" style="flex: 1;">
                        <i class="fas fa-check"></i> ìŠ¹ì¸
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="rejectIdentity('${req.id}')" style="flex: 1;">
                        <i class="fas fa-times"></i> ê±°ë¶€
                      </button>
                    </div>
                  </form>
                </div>
              ` : ''}

              ${req.status === 'approved' ? `
                <div style="background: #d4edda; padding: 16px; border-radius: 8px; margin-top: 12px;">
                  <strong>ìŠ¹ì¸ ì •ë³´:</strong><br>
                  ì´ë¦„: ${req.verified_name}<br>
                  ìƒë…„ì›”ì¼: ${req.verified_birth_date}<br>
                  ë‚˜ì´: ${req.verified_age}ì„¸<br>
                  êµ­ì : ${req.verified_nationality}<br>
                  ${req.admin_notes ? `ë©”ëª¨: ${req.admin_notes}` : ''}
                </div>
              ` : ''}

              ${req.status === 'rejected' ? `
                <div style="background: #f8d7da; padding: 16px; border-radius: 8px; margin-top: 12px;">
                  <strong>ê±°ë¶€ ì´ìœ :</strong><br>
                  ${req.rejected_reason || 'ì—†ìŒ'}
                </div>
              ` : ''}

              <div style="font-size: 0.85rem; color: #999; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                ìƒì„±ì¼: ${new Date(req.created_at).toLocaleString('ko-KR')}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        container.innerHTML = `<div style="color: red; text-align: center; padding: 40px;">âŒ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
      }
    }

    window.approveIdentity = async function(requestId) {
      const form = document.getElementById(`approveForm_${requestId}`);
      const formData = new FormData(form);

      const verified_name = formData.get('verified_name');
      const verified_birth_date = formData.get('verified_birth_date');
      const verified_nationality = formData.get('verified_nationality');
      const admin_notes = formData.get('admin_notes');

      if (!verified_name || !verified_birth_date) {
        alert('í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ë‚˜ì´ ê³„ì‚°
      const birthDate = new Date(verified_birth_date);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }

      if (!confirm(`${verified_name}ë‹˜ì˜ ë³¸ì¸ì¸ì¦ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        // 1. ìš”ì²­ ì—…ë°ì´íŠ¸
        const { error: reqError } = await supabase
          .from('identity_verification_requests')
          .update({
            status: 'approved',
            verified_name,
            verified_birth_date,
            verified_age: age,
            verified_nationality,
            admin_notes,
            approved_by: user.id,
            approved_at: new Date().toISOString()
          })
          .eq('id', requestId);

        if (reqError) throw reqError;

        // 2. í”„ë¡œí•„ ì—…ë°ì´íŠ¸
        const { data: request } = await supabase
          .from('identity_verification_requests')
          .select('user_id')
          .eq('id', requestId)
          .single();

        const { error: profileError } = await supabase
          .from('profiles')
          .update({
            full_name: verified_name,
            birth_date: verified_birth_date,
            age: age,
            nationality: verified_nationality,
            identity_verified: true,
            age_verified: true,
            verification_source: 'passport',
            verification_level: 'premium'
          })
          .eq('id', request.user_id);

        if (profileError) throw profileError;

        // 3. ì˜ˆì•½ ì •ë³´ ì¡°íšŒ (ê²°ì œ ë§í¬ ì „ì†¡ìš©)
        const { data: bookings } = await supabase
          .from('bookings')
          .select('*')
          .eq('customer_id', request.user_id)
          .eq('status', 'pending')
          .order('created_at', { ascending: false });

        // 4. ìŠ¹ì¸ ì™„ë£Œ ì•Œë¦¼ + ê²°ì œ ë§í¬ ìë™ ì „ì†¡
        if (bookings && bookings.length > 0) {
          const booking = bookings[0];
          const amount = prompt('ê²°ì œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì›):', '40000');

          if (amount) {
            try {
              const oid = `PUZZMI_${booking.id}_${Date.now()}`;
              const token = crypto.randomUUID();

              const { data: payment } = await supabase
                .from('kg_inicis_payments')
                .insert({
                  booking_id: booking.id,
                  user_id: booking.customer_id,
                  mate_id: booking.mate_id,
                  amount: parseInt(amount),
                  currency: 'KRW',
                  payment_status: 'pending',
                  oid: oid,
                  payment_token: token,
                  buyer_name: booking.customer_name,
                  buyer_tel: booking.customer_contact,
                  buyer_email: (await supabase.from('profiles').select('email').eq('id', booking.customer_id).single()).data?.email,
                  good_name: 'ë Œíƒˆì¹œêµ¬ ì„œë¹„ìŠ¤'
                })
                .select()
                .single();

              const paymentUrl = `${SUPABASE_URL}/functions/v1/inicis-payment-page/${token}`;
              const { data: { session } } = await supabase.auth.getSession();

              const response = await fetch(`${SUPABASE_URL}/functions/v1/send-line-notification`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({
                  userId: booking.customer_id,
                  bookingId: booking.id,
                  type: 'payment_request',
                  paymentUrl: paymentUrl,
                  amount: parseInt(amount)
                })
              });

              const result = await response.json();
              if (result.success) {
                alert(`âœ… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nê²°ì œ ë§í¬ê°€ LINEìœ¼ë¡œ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nê¸ˆì•¡: ${parseInt(amount).toLocaleString()}ì›`);
              } else {
                alert(`âœ… ìŠ¹ì¸ì€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nâš ï¸ ê²°ì œ ë§í¬ ë°œì†¡ ì‹¤íŒ¨: ${result.error}`);
              }
            } catch (paymentError) {
              console.error('ê²°ì œ ë§í¬ ì „ì†¡ ì˜¤ë¥˜:', paymentError);
              alert(`âœ… ìŠ¹ì¸ì€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nâš ï¸ ê²°ì œ ë§í¬ ë°œì†¡ ì‹¤íŒ¨: ${paymentError.message}`);
            }
          } else {
            alert('âœ… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ê²°ì œ ë§í¬ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì „ì†¡í•´ì£¼ì„¸ìš”)');
          }
        } else {
          alert('âœ… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        loadIdentity();
      } catch (error) {
        console.error('ìŠ¹ì¸ ì˜¤ë¥˜:', error);
        alert('âŒ ì˜¤ë¥˜: ' + error.message);
      }
    };

    window.rejectIdentity = async function(requestId) {
      const reason = prompt('ê±°ë¶€ ì´ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!reason) return;

      try {
        const { error } = await supabase
          .from('identity_verification_requests')
          .update({
            status: 'rejected',
            rejected_reason: reason,
            approved_by: user.id
          })
          .eq('id', requestId);

        if (error) throw error;

        alert('âœ… ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadIdentity();
      } catch (error) {
        console.error('ê±°ë¶€ ì˜¤ë¥˜:', error);
        alert('âŒ ì˜¤ë¥˜: ' + error.message);
      }
    };

    document.getElementById('identityFilter').addEventListener('change', loadIdentity);
    document.getElementById('refreshIdentity').addEventListener('click', loadIdentity);

    // ========== ê²°ì œ ê´€ë¦¬ ==========
    async function loadPayments() {
      const tbody = document.getElementById('paymentsTableBody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i> ë¡œë”© ì¤‘...</td></tr>';

      try {
        const { data: payments, error } = await supabase
          .from('kg_inicis_payments')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        if (!payments || !payments.length) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          return;
        }

        tbody.innerHTML = payments.map(p => `
          <tr>
            <td>#${p.id}</td>
            <td>#${p.booking_id}</td>
            <td>${p.buyer_name}</td>
            <td style="font-weight: 700;">â‚©${(p.amount || 0).toLocaleString()}</td>
            <td><span class="badge badge-${p.payment_status}">${p.payment_status}</span></td>
            <td>${new Date(p.created_at).toLocaleDateString('ko-KR')}</td>
          </tr>
        `).join('');
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="6" style="color: red; text-align: center; padding: 40px;">âŒ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</td></tr>`;
      }
    }

    document.getElementById('refreshPayments').addEventListener('click', loadPayments);

    // ì´ˆê¸° ë¡œë“œ
    loadBookings();
  </script>
</body>
</html>
