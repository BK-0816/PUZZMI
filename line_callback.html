<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LINE 연동 처리 중...</title>
  <style>
    body {
      background: #faf7f2;
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; margin: 0; font-family: 'Noto Sans KR', sans-serif;
    }
    .callback-container { background: #fff; border-radius: 20px; padding: 40px 28px; width: 92%; max-width: 520px; box-shadow: 0 18px 50px rgba(0,0,0,.08); text-align: center; }
    .loading-icon { font-size: 3rem; margin-bottom: 18px; }
    .title { font-size: 1.4rem; font-weight: 800; margin-bottom: 10px; }
    .desc { color: #555; line-height: 1.6; }
    .error { background: #fde2e0; color: #8a1c15; border: 1px solid #f3b1ab; padding: 12px; border-radius: 12px; margin-top: 16px; font-size: .95rem; }
    .success { background: #def7f0; color: #0a6147; border: 1px solid #a5e3d2; padding: 12px; border-radius: 12px; margin-top: 16px; font-size: .95rem; }
  </style>
</head>
<body>
  <div class="callback-container">
    <div class="loading-icon">💬</div>
    <div class="title">LINE 연동 처리 중...</div>
    <div class="desc">잠시만 기다려주세요. LINE 계정 연동을 완료하고 있습니다.</div>
    <div id="status" style="margin-top:12px;"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ====== 환경 ======
    const SUPABASE_URL = 'https://eevvgbbokenpjnvtmztk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4';
    const EDGE_COMPLETE_URL = `${SUPABASE_URL}/functions/v1/line-auth/complete-auth`;

    function isSameOriginWithOpener() {
      try {
        if (!window.opener) return false;
        return window.opener.location.origin === window.location.origin;
      } catch {
        return false; // cross-origin인 경우 예외
      }
    }

    async function processLineCallback() {
      const statusEl = document.getElementById('status');

      // 1) URL 파라미터 파싱
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      const errorDescription = urlParams.get('error_description');

      if (error) {
        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_ERROR', error: errorDescription || error }, '*');
        }
        statusEl.innerHTML = `<div class="error">❌ ${errorDescription || error}</div>`;
        setTimeout(()=> window.close(), 900);
        return;
      }

      if (!code) {
        statusEl.innerHTML = `<div class="error">❌ Authorization code가 없습니다.</div>`;
        setTimeout(()=> window.close(), 900);
        return;
      }

      // 2) cross-origin이면 → 메인창으로 code/state 전달 후 종료 (권장 경로)
      const sameOrigin = isSameOriginWithOpener();
      if (!sameOrigin && window.opener) {
        window.opener.postMessage({ type: 'LINE_AUTH_CODE', code, state }, '*');
        statusEl.innerHTML = `<div class="success">🔁 메인 창으로 인증 코드를 전달했습니다.</div>`;
        setTimeout(()=> window.close(), 500);
        return;
      }

      // 3) same-origin이면 → 팝업 내에서 처리(옵션)
      let supabase;
      try {
        if (sameOrigin && window.opener && window.opener.supabase) {
          supabase = window.opener.supabase;
        } else {
          supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
      } catch (e) {
        // 예외 발생 시 릴레이로 폴백
        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_CODE', code, state }, '*');
          statusEl.innerHTML = `<div class="success">🔁 메인 창으로 인증 코드를 전달했습니다.</div>`;
          setTimeout(()=> window.close(), 500);
          return;
        }
        statusEl.innerHTML = `<div class="error">❌ 인증 시스템 초기화 실패</div>`;
        return;
      }

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error('로그인 세션이 없습니다.');

        // 시뮬레이션 모드 체크
        const urlParams = new URLSearchParams(window.location.search);
        const isSimulation = urlParams.get('simulation') === 'true';
        
        if (isSimulation) {
          // 시뮬레이션 모드: 가짜 LINE 데이터로 연동 처리
          const userId = urlParams.get('userId');
          const mockLineData = {
            line_user_id: 'U' + Math.random().toString(36).substr(2, 9),
            line_display_name: '시뮬레이션 사용자',
            line_picture_url: 'https://picsum.photos/200/200',
            is_verified: true,
            access_token: 'mock_access_token',
            connected_at: new Date().toISOString()
          };
          
          // LINE 계정 정보 저장
          const { error: lineError } = await supabase
            .from('user_line_accounts')
            .upsert({
              user_id: userId,
              ...mockLineData
            }, { onConflict: 'user_id' });
          
          if (lineError) throw lineError;
          
          // 신원확인 정보 저장
          const { error: verificationError } = await supabase
        
        if (!userId) {
          statusEl.innerHTML = `<div class="error">❌ 사용자 ID가 없습니다.</div>`;
          setTimeout(()=> window.close(), 1200);
          return;
        }
        
            .from('line_identity_verifications')
            .upsert({
              user_id: userId,
              line_user_id: mockLineData.line_user_id,
              verified_name: mockLineData.line_display_name,
              verified_age: 25, // 시뮬레이션 나이
              verification_level: 'basic',
              verified_at: new Date().toISOString(),
              expires_at: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
        console.log('시뮬레이션 데이터 저장 시작:', { userId, mockLineData });
        
              verification_data: {
                simulation: true,
                line_display_name: mockLineData.line_display_name,
                verification_method: 'simulation'
              }
            }, { onConflict: 'user_id' });
          
          if (verificationError) throw verificationError;
        if (lineError) {
          console.error('LINE 계정 저장 실패:', lineError);
          throw lineError;
        }
        
        console.log('LINE 계정 정보 저장 성공');
          // 프로필 인증 상태 업데이트
          await supabase
            .from('profiles')
            .update({
              identity_verified: true,
              verification_source: 'line',
              verification_level: 'basic',
              updated_at: new Date().toISOString()
            })
            .eq('id', userId);
          
          if (window.opener) {
            window.opener.postMessage({ type: 'LINE_AUTH_SUCCESS', message: '시뮬레이션 연동 완료' }, '*');
          }
          statusEl.innerHTML = `<div class="success">✅ 시뮬레이션 연동 성공! 잠시 후 창이 닫힙니다.</div>`;
          setTimeout(()=> window.close(), 600);
          return;
        }
        
        if (verificationError) {
          console.error('신원확인 정보 저장 실패:', verificationError);
          throw verificationError;
        }
        
        console.log('신원확인 정보 저장 성공');
        const resp = await fetch(EDGE_COMPLETE_URL, {
          method: 'POST',
        const { error: profileError } = await supabase
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
          },
            age_verified: true,
          body: JSON.stringify({ code, state })
        });
        if (!resp.ok) throw new Error(await resp.text());
        const result = await resp.json();
        if (!result.success) throw new Error(result.error || 'LINE 인증 처리 실패');

        if (profileError) {
          console.error('프로필 업데이트 실패:', profileError);
          throw profileError;
        }
        
        console.log('프로필 인증 상태 업데이트 성공');
        
        // 사용자 인증 상태 저장
        const { error: userVerificationError } = await supabase
          .from('user_verifications')
          .upsert({
            user_id: userId,
            verification_type: 'line',
            is_verified: true,
            verified_at: new Date().toISOString(),
            verification_data: {
              simulation: true,
              line_user_id: mockLineData.line_user_id,
              display_name: mockLineData.line_display_name
            }
          }, { onConflict: 'user_id,verification_type' });
        
        if (userVerificationError) {
          console.warn('사용자 인증 상태 저장 실패 (무시):', userVerificationError);
        }
        
        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_SUCCESS', message: result.message || '연동 완료' }, '*');
        }
        statusEl.innerHTML = `<div class="success">✅ 연동 성공! 잠시 후 창이 닫힙니다.</div>`;
        setTimeout(()=> window.close(), 600);
      } catch (e) {
        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_ERROR', error: String(e.message || e) }, '*');
        }
        statusEl.innerHTML = `<div class="error">❌ ${String(e.message || e)}</div>`;
        setTimeout(()=> window.close(), 1200);
      }
    }

    (async () => { await processLineCallback(); })();
  </script>
</body>
</html>
