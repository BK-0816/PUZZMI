<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LINE ì—°ë™ ì²˜ë¦¬ ì¤‘...</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    body {
      background: var(--bg-cream);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .callback-container {
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 24px;
      padding: 60px 40px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 90%;
    }
    .loading-icon { font-size: 4rem; margin-bottom: 24px; animation: spin 2s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; }
    .loading-subtext { color: var(--text-secondary); font-size: 1rem; line-height: 1.6; }
    .error-container {
      background: linear-gradient(135deg, #fadbd8 0%, #f1948a 100%);
      color: #922b21; padding: 20px; border-radius: 16px;
      border: 2px solid rgba(220, 53, 69, 0.3); margin-top: 20px;
    }
    .success-container {
      background: linear-gradient(135deg, #d1f2eb 0%, #a3e4d7 100%);
      color: #0e6b47; padding: 20px; border-radius: 16px;
      border: 2px solid rgba(25, 135, 84, 0.3); margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="callback-container">
    <div class="loading-icon">ğŸ’¬</div>
    <div class="loading-text">LINE ì—°ë™ ì²˜ë¦¬ ì¤‘...</div>
    <div class="loading-subtext">
      ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.<br>
      LINE ê³„ì • ì—°ë™ì„ ì™„ë£Œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
    </div>
    <div id="status"></div>
  </div>

  <script type="module">
    // ë¶€ëª¨ ì°½ì—ì„œ ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (â€» asyncë¡œ ìˆ˜ì •)
    async function getSessionFromParent() {
      if (window.opener && window.opener.supabase) {
        return window.opener.supabase;
      }
      // ë¶€ëª¨ ì°½ì´ ì—†ê±°ë‚˜ supabase ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ëŠ” ê²½ìš° ìƒˆë¡œ ìƒì„±
      const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
      return createClient(
        "https://eevvgbbokenpjnvtmztk.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFlvXnEwQPZah1mQzwiyG2Y4"
      );
    }

    async function processLineCallback() {
      const statusEl = document.getElementById('status');

      try {
        // ë¶€ëª¨ ì°½ì—ì„œ ì„¸ì…˜ ê³µìœ  ì‹œë„
        let supabase;
        try {
          if (window.opener && window.opener.supabase) {
            console.log('âœ… ë¶€ëª¨ ì°½ì—ì„œ Supabase ì¸ìŠ¤í„´ìŠ¤ ê³µìœ ');
            supabase = window.opener.supabase;
          } else {
            console.log('âš ï¸ ë¶€ëª¨ ì°½ ì„¸ì…˜ ì—†ìŒ, ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±');
            const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
            supabase = createClient(
              "https://eevvgbbokenpjnvtmztk.supabase.co",
              "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFlvXnEwQPZah1mQzwiyG2Y4"
            );
          }
        } catch (e) {
          console.error('Supabase ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨:', e);
          throw new Error('ì¸ì¦ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨');
        }

        const urlParams = new URLSearchParams(window.location.search);

        console.log('=== LINE ì½œë°± URL ë¶„ì„ ===');
        console.log('ì „ì²´ URL:', window.location.href);

        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');
        const simulation = urlParams.get('simulation');
        const success = urlParams.get('success');

        console.log('ì½œë°± íŒŒë¼ë¯¸í„°:', { code, state, error, errorDescription, simulation, success });

        // ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì²´í¬
        if (simulation === 'true' && success === 'true') {
          console.log('ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ê°ì§€');
          const { data: { user } } = await supabase.auth.getUser();
          if (user) {
            await handleSimulationCallback(user.id, supabase);
            return;
          } else {
            throw new Error('ì‹œë®¬ë ˆì´ì…˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          }
        }

        // LINE ì±„ë„ ê°œë°œ ìƒíƒœ ì—ëŸ¬ ì²´í¬
        if (error) {
          if (error === 'access_denied' ||
              errorDescription?.includes('developer role') ||
              errorDescription?.includes('redirect_uri')) {
            console.warn('LINE ì±„ë„ì´ ê°œë°œ ìƒíƒœì…ë‹ˆë‹¤. ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
              await handleSimulationCallback(user.id, supabase);
              return;
            } else {
              throw new Error('ì‹œë®¬ë ˆì´ì…˜ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }
          } else {
            const errorMsg = errorDescription ? `${error}: ${errorDescription}` : error;
            throw new Error(`LINE ë¡œê·¸ì¸ ì˜¤ë¥˜: ${errorMsg}`);
          }
        }

        // ì •ìƒì ì¸ codeê°€ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
        if (!code) {
          throw new Error('Authorization codeê°€ ì—†ìŠµë‹ˆë‹¤. LINE ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }

        // Edge Functionì„ í†µí•œ ì™„ì „í•œ ì¸ì¦ ì²˜ë¦¬
        try {
          await processLineAuthWithEdgeFunction(code, state, supabase);
        } catch (apiError) {
          console.error('Edge Function ì‹¤íŒ¨:', apiError);
          const { data: { user } } = await supabase.auth.getUser();
          if (user) {
            console.warn('ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜');
            await handleSimulationCallback(user.id, supabase);
          } else {
            throw new Error('ì¸ì¦ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          }
        }

      } catch (error) {
        console.error('LINE ì½œë°± ì²˜ë¦¬ ì‹¤íŒ¨:', error);

        statusEl.innerHTML = `
          <div class="error-container">
            <h3>âŒ LINE ì—°ë™ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜</h3>
            <p>${error.message}</p>
            <div style="font-size: 0.9rem; margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
              <strong>í•´ê²° ë°©ë²•:</strong><br>
              â€¢ LINE ì±„ë„ì´ ê°œë°œ ìƒíƒœì¸ ê²½ìš°: ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ìë™ ì „í™˜ë©ë‹ˆë‹¤<br>
              â€¢ ë‹¤ë¥¸ ì˜¤ë¥˜ì¸ ê²½ìš°: í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”
            </div>
            <button onclick="window.close()" style="margin-top: 12px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ì°½ ë‹«ê¸°
            </button>
          </div>
        `;

        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_ERROR', error: error.message }, '*');
        }
        setTimeout(() => window.close(), 5000);
      }
    }

    // Edge Functionì„ í†µí•œ ì™„ì „í•œ LINE ì¸ì¦ ì²˜ë¦¬
    async function processLineAuthWithEdgeFunction(code, state, supabase) {
      console.log('ğŸ” Edge Functionì„ í†µí•œ ì™„ì „í•œ LINE ì¸ì¦ ì²˜ë¦¬ ì‹œì‘');

      const { data: { session} } = await supabase.auth.getSession();
      if (!session) {
        throw new Error('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');
      }

      console.log('âœ… ì½œë°±ì—ì„œ ì„¸ì…˜ í™•ì¸ë¨:', session.user.id);

      const response = await fetch(`https://eevvgbbokenpjnvtmztk.supabase.co/functions/v1/line-auth/complete-auth`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({ code, state })
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Edge Function ì‹¤íŒ¨:', errorText);
        throw new Error(`LINE ì¸ì¦ ì²˜ë¦¬ ì‹¤íŒ¨: ${response.status} - ${errorText}`);
      }

      const result = await response.json();
      if (!result.success) {
        throw new Error(result.error || 'LINE ì¸ì¦ ì²˜ë¦¬ ì‹¤íŒ¨');
      }

      console.log('âœ… Edge Functionìœ¼ë¡œ LINE ì¸ì¦ ì™„ë£Œ!');
      await handleSuccess(result.message || 'LINE ê³„ì • ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ì‹œë®¬ë ˆì´ì…˜ ì²˜ë¦¬
    async function handleSimulationCallback(userId, supabase) {
      console.log('ğŸ­ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì²˜ë¦¬');
      console.log('âœ… ì‹œë®¬ë ˆì´ì…˜ ì‚¬ìš©ì ID:', userId);

      const statusEl = document.getElementById('status');
      statusEl.innerHTML = `
        <div class="success-container">
          <h3>ğŸ”„ ê°œë°œ ì±„ë„ ì‹œë®¬ë ˆì´ì…˜</h3>
          <p>LINE ì±„ë„ì´ ê°œë°œ ìƒíƒœì´ë¯€ë¡œ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ì—°ë™ì„ ì™„ë£Œí•©ë‹ˆë‹¤...</p>
        </div>
      `;

      const mockProfile = {
        userId: 'U' + Math.random().toString(36).substr(2, 9),
        displayName: 'PUZZMI ì‚¬ìš©ì',
        pictureUrl: 'https://picsum.photos/200/200'
      };

      const mockTokenData = {
        access_token: 'mock_access_token_' + Date.now(),
        token_type: 'Bearer',
        expires_in: 2592000,
        refresh_token: 'mock_refresh_token_' + Date.now()
      };

      const lineAccountData = {
        user_id: userId,
        line_user_id: mockProfile.userId,
        line_display_name: mockProfile.displayName,
        line_picture_url: mockProfile.pictureUrl,
        is_verified: true,
        access_token: mockTokenData.access_token,
        refresh_token: mockTokenData.refresh_token || null,
        token_expires_at: mockTokenData.expires_in
          ? new Date(Date.now() + mockTokenData.expires_in * 1000).toISOString()
          : null
      };

      const { error } = await supabase.from('user_line_accounts')
        .upsert(lineAccountData, { onConflict: 'user_id' });

      if (error) {
        console.error('LINE ê³„ì • ì €ì¥ ì‹¤íŒ¨:', error);
        throw new Error(`LINE ê³„ì • ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
      }

      await supabase.from('user_verifications')
        .upsert({
          user_id: userId,
          verification_type: 'line',
          is_verified: true,
          verified_at: new Date().toISOString(),
          verification_data: {
            line_user_id: mockProfile.userId,
            display_name: mockProfile.displayName
          }
        }, { onConflict: 'user_id,verification_type' });

      await handleSuccess('LINE ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ)');
    }

    // ì„±ê³µ ì²˜ë¦¬
    async function handleSuccess(message) {
      const statusEl = document.getElementById('status');
      statusEl.innerHTML = `
        <div class="success-container">
          <h3>âœ… ì—°ë™ ì„±ê³µ!</h3>
          <p>${message}</p>
          <p style="font-size: 0.9rem; margin-top: 12px;">ì ì‹œ í›„ ì°½ì´ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤...</p>
        </div>
      `;

      if (window.opener) {
        window.opener.postMessage({ type: 'LINE_AUTH_SUCCESS', message }, '*');
      }

      setTimeout(() => { window.close(); }, 2000);
    }

    // ì½œë°± ì²˜ë¦¬ ì‹œì‘
    (async () => {
      await processLineCallback();
    })();
  </script>
</body>
</html>