<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LINE ì—°ë™ ì²˜ë¦¬ ì¤‘...</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    body {
      background: var(--bg-cream);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      font-family: 'Noto Sans KR', sans-serif;
    }
    
    .callback-container {
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 24px;
      padding: 60px 40px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 90%;
    }
    
    .loading-icon {
      font-size: 4rem;
      margin-bottom: 24px;
      animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    
    .loading-subtext {
      color: var(--text-secondary);
      font-size: 1rem;
      line-height: 1.6;
    }
    
    .error-container {
      background: linear-gradient(135deg, #fadbd8 0%, #f1948a 100%);
      color: #922b21;
      padding: 20px;
      border-radius: 16px;
      border: 2px solid rgba(220, 53, 69, 0.3);
      margin-top: 20px;
    }
    
    .success-container {
      background: linear-gradient(135deg, #d1f2eb 0%, #a3e4d7 100%);
      color: #0e6b47;
      padding: 20px;
      border-radius: 16px;
      border: 2px solid rgba(25, 135, 84, 0.3);
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="callback-container">
    <div class="loading-icon">ğŸ’¬</div>
    <div class="loading-text">LINE ì—°ë™ ì²˜ë¦¬ ì¤‘...</div>
    <div class="loading-subtext">
      ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.<br>
      LINE ê³„ì • ì—°ë™ì„ ì™„ë£Œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
    </div>
    <div id="status"></div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(
      "https://eevvgbbokenpjnvtmztk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4"
    );

    async function processLineCallback() {
      const statusEl = document.getElementById('status');
      
      try {
        const urlParams = new URLSearchParams(window.location.search);
        
        // URL íŒŒë¼ë¯¸í„° ì „ì²´ ë¡œê¹…
        const allParams = {};
        for (const [key, value] of urlParams.entries()) {
          allParams[key] = value;
        }
        
        console.log('=== LINE ì½œë°± URL ë¶„ì„ ===');
        console.log('ì „ì²´ URL:', window.location.href);
        console.log('ëª¨ë“  íŒŒë¼ë¯¸í„°:', allParams);
        console.log('íŒŒë¼ë¯¸í„° ê°œìˆ˜:', urlParams.size);
        
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');
        const simulation = urlParams.get('simulation');
        
        console.log('ì½œë°± íŒŒë¼ë¯¸í„°:', { 
          code, 
          state, 
          error, 
          errorDescription,
          simulation,
          hasCode: !!code,
          hasState: !!state,
          hasError: !!error
        });
        
        // ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì²´í¬ (URLì— simulation=trueê°€ ìˆëŠ” ê²½ìš°)
        if (simulation === 'true') {
          console.log('ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ê°ì§€');
          const userId = urlParams.get('userId');
          if (userId) {
            await handleSimulationCallback(userId);
            return;
          }
        }
        
        // LINE ì±„ë„ ê°œë°œ ìƒíƒœ ì—ëŸ¬ ì²´í¬
        if (error) {
          if (error === 'access_denied' || errorDescription?.includes('developer role')) {
            console.warn('LINE ì±„ë„ì´ ê°œë°œ ìƒíƒœì…ë‹ˆë‹¤. ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
            
            // stateì—ì„œ userId ì¶”ì¶œ
            let userId = null;
            if (state) {
              try {
                const stateData = JSON.parse(atob(state));
                userId = stateData.userId;
              } catch (e) {
                console.error('State íŒŒì‹± ì‹¤íŒ¨:', e);
              }
            }
            
            if (userId) {
              await handleSimulationCallback(userId);
              return;
            } else {
              throw new Error('LINE ì±„ë„ì´ ê°œë°œ ìƒíƒœì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
            }
          } else {
            const errorMsg = errorDescription ? `${error}: ${errorDescription}` : error;
            throw new Error(`LINE ë¡œê·¸ì¸ ì˜¤ë¥˜: ${errorMsg}`);
          }
        }
        
        // ì •ìƒì ì¸ codeê°€ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
        if (!code) {
          console.warn('Authorization codeê°€ ì—†ìŠµë‹ˆë‹¤. ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
          
          // stateì—ì„œ userId ì¶”ì¶œ ì‹œë„
          let userId = null;
          if (state) {
            try {
              const stateData = JSON.parse(atob(state));
              userId = stateData.userId;
            } catch (e) {
              console.error('State íŒŒì‹± ì‹¤íŒ¨:', e);
            }
          }
          
          if (userId) {
            await handleSimulationCallback(userId);
            return;
          } else {
            throw new Error('í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤. LINE ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        }
        
        // state íŒŒì‹±
        let stateData;
        try {
          stateData = JSON.parse(atob(state));
          console.log('State ë°ì´í„°:', stateData);
        } catch (e) {
          throw new Error('ì˜ëª»ëœ state íŒŒë¼ë¯¸í„°ì…ë‹ˆë‹¤');
        }
        
        const userId = stateData.userId;
        if (!userId) {
          throw new Error('ì‚¬ìš©ì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // Edge Functionì„ í†µí•œ í† í° êµí™˜ ì‹œë„
        try {
          await processLineAuthWithEdgeFunction(code, userId);
        } catch (apiError) {
          console.warn('Edge Function ì‹¤íŒ¨, ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ì „í™˜:', apiError);
          await handleSimulationCallback(userId);
        }
        
      } catch (error) {
        console.error('LINE ì½œë°± ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        
        statusEl.innerHTML = `
          <div class="error-container">
            <h3>âŒ LINE ì—°ë™ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜</h3>
            <p>${error.message}</p>
            <div style="font-size: 0.9rem; margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
              <strong>í•´ê²° ë°©ë²•:</strong><br>
              â€¢ LINE ì±„ë„ì´ ê°œë°œ ìƒíƒœì¸ ê²½ìš°: ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ìë™ ì „í™˜ë©ë‹ˆë‹¤<br>
              â€¢ ë‹¤ë¥¸ ì˜¤ë¥˜ì¸ ê²½ìš°: í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”
            </div>
            <button onclick="window.close()" style="margin-top: 12px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
              ì°½ ë‹«ê¸°
            </button>
          </div>
        `;
        
        // ë¶€ëª¨ ì°½ì— ì—ëŸ¬ ì „ë‹¬
        if (window.opener) {
          window.opener.postMessage({
            type: 'LINE_AUTH_ERROR',
            error: error.message
          }, '*');
        }
        
        // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì°½ ë‹«ê¸°
        setTimeout(() => window.close(), 5000);
      }
    }
    
    // Edge Functionì„ í†µí•œ LINE API ì²˜ë¦¬
    async function processLineAuthWithEdgeFunction(code, userId) {
      console.log('Edge Functionì„ í†µí•œ LINE API ì²˜ë¦¬ ì‹œì‘');
      
      // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ JWT í† í° ê°€ì ¸ì˜¤ê¸°
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        throw new Error('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
      }
      
      const authHeaders = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session.access_token}`,
      };
      
      // í† í° êµí™˜
      const tokenResponse = await fetch(`https://eevvgbbokenpjnvtmztk.supabase.co/functions/v1/line-auth/exchange-token`, {
        method: 'POST',
        headers: authHeaders,
        body: JSON.stringify({ 
          code,
          state: urlParams.get('state')
        })
      });
      
      if (!tokenResponse.ok) {
        const errorText = await tokenResponse.text();
        throw new Error(`í† í° êµí™˜ ì‹¤íŒ¨: ${tokenResponse.status} - ${errorText}`);
      }
      
      const tokenResult = await tokenResponse.json();
      if (!tokenResult.success) {
        throw new Error(tokenResult.error || 'í† í° êµí™˜ ì‹¤íŒ¨');
      }
      
      // í”„ë¡œí•„ ì •ë³´ ì¡°íšŒ
      const profileResponse = await fetch(`https://eevvgbbokenpjnvtmztk.supabase.co/functions/v1/line-auth/get-profile`, {
        method: 'POST',
        headers: authHeaders,
        body: JSON.stringify({ accessToken: tokenResult.tokenData.access_token })
      });
      
      if (!profileResponse.ok) {
        const errorText = await profileResponse.text();
        throw new Error(`í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: ${profileResponse.status} - ${errorText}`);
      }
      
      const profileResult = await profileResponse.json();
      if (!profileResult.success) {
        throw new Error(profileResult.error || 'í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨');
      }
      
      // ì„œë²„ì—ì„œ ì•ˆì „í•˜ê²Œ LINE ê³„ì • ì •ë³´ ì €ì¥
      const saveResponse = await fetch(`https://eevvgbbokenpjnvtmztk.supabase.co/functions/v1/line-auth/save-account`, {
        method: 'POST',
        headers: authHeaders,
        body: JSON.stringify({ 
          profile: profileResult.profile,
          tokenData: tokenResult.tokenData
        })
      });
      
      const saveResult = await saveResponse.json();
      if (!saveResult.success) throw new Error(saveResult.error || 'LINE ê³„ì • ì €ì¥ ì‹¤íŒ¨');
      
      // ì„±ê³µ ì²˜ë¦¬
      await handleSuccess('LINE ê³„ì • ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
    
    // ì‹œë®¬ë ˆì´ì…˜ ì²˜ë¦¬
    async function handleSimulationCallback(userId) {
      console.log('ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì²˜ë¦¬, userId:', userId);
      
      // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì í™•ì¸
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        throw new Error('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
      }
      
      // ì‹¤ì œ ì¸ì¦ëœ ì‚¬ìš©ì ID ì‚¬ìš©
      userId = user.id;
      
      if (!userId) {
        throw new Error('ì‚¬ìš©ì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
      
      // ìƒíƒœ ì—…ë°ì´íŠ¸
      const statusEl = document.getElementById('status');
      statusEl.innerHTML = `
        <div class="success-container">
          <h3>ğŸ”„ ê°œë°œ ì±„ë„ ì‹œë®¬ë ˆì´ì…˜</h3>
          <p>LINE ì±„ë„ì´ ê°œë°œ ìƒíƒœì´ë¯€ë¡œ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ì—°ë™ì„ ì™„ë£Œí•©ë‹ˆë‹¤...</p>
          <div style="font-size: 0.9rem; margin-top: 12px; padding: 12px; background: rgba(255,193,7,0.2); border-radius: 8px;">
            <strong>ì°¸ê³ :</strong> ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” LINE ì±„ë„ì„ Published ìƒíƒœë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
          </div>
        </div>
      `;
      
      // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„±
      const mockProfile = {
        userId: 'U' + Math.random().toString(36).substr(2, 9),
        displayName: 'PUZZMI í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
        pictureUrl: 'https://picsum.photos/200/200'
      };
      
      const mockTokenData = {
        access_token: 'mock_access_token_' + Date.now(),
        token_type: 'Bearer',
        expires_in: 2592000,
        refresh_token: 'mock_refresh_token_' + Date.now()
      };
      
      console.log('ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„±:', { mockProfile, mockTokenData });
      
      // LINE ê³„ì • ì •ë³´ ì €ì¥
      const lineAccountData = {
        user_id: userId, // ì¸ì¦ëœ ì‚¬ìš©ì ID ì‚¬ìš©
        line_user_id: mockProfile.userId,
        line_display_name: mockProfile.displayName,
        line_picture_url: mockProfile.pictureUrl,
        is_verified: true,
        access_token: mockTokenData.access_token,
        refresh_token: mockTokenData.refresh_token || null,
        token_expires_at: mockTokenData.expires_in ? 
          new Date(Date.now() + mockTokenData.expires_in * 1000).toISOString() : null
      };
      
      console.log('ì €ì¥í•  LINE ê³„ì • ë°ì´í„°:', lineAccountData);
      
      const { error } = await supabase
        .from('user_line_accounts')
        .upsert(lineAccountData, { onConflict: 'user_id' });
      
      if (error) {
        console.error('LINE ê³„ì • ì €ì¥ ì‹¤íŒ¨:', error);
        throw new Error(`LINE ê³„ì • ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
      }
      
      // ì¸ì¦ ìƒíƒœë„ ì €ì¥
      await supabase
        .from('user_verifications')
        .upsert({
          user_id: userId,
          verification_type: 'line',
          is_verified: true,
          verified_at: new Date().toISOString(),
          verification_data: {
            line_user_id: mockProfile.userId,
            display_name: mockProfile.displayName
          }
        }, { onConflict: 'user_id,verification_type' });
      
      // ì„±ê³µ ì²˜ë¦¬
      await handleSuccess('LINE ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n(ê°œë°œ ì±„ë„ - ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ)');
    }
    
    // LINE ê³„ì • ì •ë³´ ì €ì¥
    async function saveLineAccount(userId, profile, tokenData) {
      // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (Edge Functionì—ì„œ ì²˜ë¦¬)
      console.warn('saveLineAccount í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Edge Functionì„ ì‚¬ìš©í•˜ì„¸ìš”.');
      return;
    }
    
    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° (ì•ˆì „í•œ ë°©ë²•)
    async function getCurrentUserId() {
      const { data: { user } } = await supabase.auth.getUser();
      return user?.id || null;
    }
      
      const lineAccountData = {
        user_id: userId, // stateì—ì„œ ë°›ì€ userId ì§ì ‘ ì‚¬ìš©
        line_user_id: profile.userId,
        line_display_name: profile.displayName,
        line_picture_url: profile.pictureUrl,
        is_verified: true,
        access_token: tokenData.access_token,
        refresh_token: tokenData.refresh_token || null,
        token_expires_at: tokenData.expires_in ? 
          new Date(Date.now() + tokenData.expires_in * 1000).toISOString() : null
      };
      
      console.log('ì €ì¥í•  LINE ê³„ì • ë°ì´í„°:', lineAccountData);
      
      const { error } = await supabase
        .from('user_line_accounts')
        .upsert(lineAccountData, { onConflict: 'user_id' });
      
      if (error) {
        console.error('LINE ê³„ì • ì €ì¥ ì‹¤íŒ¨:', error);
        console.error('ì €ì¥ ì‹œë„í•œ ë°ì´í„°:', lineAccountData);
        console.error('ì‚¬ìš©ì ID:', userId);
        throw new Error(`LINE ê³„ì • ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
      }
      
      console.log('LINE ê³„ì • ì €ì¥ ì„±ê³µ!');
      
      // ì¸ì¦ ìƒíƒœë„ ì €ì¥
      const { error: verificationError } = await supabase
        .from('user_verifications')
        .upsert({
          user_id: userId, // stateì—ì„œ ë°›ì€ userId ì§ì ‘ ì‚¬ìš©
          verification_type: 'line',
          is_verified: true,
          verified_at: new Date().toISOString(),
          verification_data: {
            line_user_id: profile.userId,
            display_name: profile.displayName
          }
        }, { onConflict: 'user_id,verification_type' });
      
      if (verificationError) {
        console.warn('ì¸ì¦ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨ (ë¬´ì‹œë¨):', verificationError);
      } else {
        console.log('ì¸ì¦ ìƒíƒœ ì €ì¥ ì„±ê³µ!');
      }
    }
    
    // ì„±ê³µ ì²˜ë¦¬
    async function handleSuccess(message) {
      const statusEl = document.getElementById('status');
      
      statusEl.innerHTML = `
        <div class="success-container">
          <h3>âœ… ì—°ë™ ì„±ê³µ!</h3>
          <p>${message}</p>
          <p style="font-size: 0.9rem; margin-top: 12px;">ì ì‹œ í›„ ì°½ì´ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤...</p>
        </div>
      `;
      
      // ë¶€ëª¨ ì°½ì— ì„±ê³µ ë©”ì‹œì§€ ì „ë‹¬
      if (window.opener) {
        window.opener.postMessage({
          type: 'LINE_AUTH_SUCCESS',
          message: message
        }, '*');
      }
      
      // 2ì´ˆ í›„ ì°½ ë‹«ê¸°
      setTimeout(() => {
        window.close();
      }, 2000);
    }
    
    // ì½œë°± ì²˜ë¦¬ ì‹œì‘
    processLineCallback();
  </script>
</body>
</html>