<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LINE ì—°ë™ ì²˜ë¦¬ ì¤‘...</title>
  <style>
    :root { --bg: #faf7f2; --text: #333; }
    body {
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; margin: 0; font-family: 'Noto Sans KR', system-ui, sans-serif;
    }
    .callback-container {
      background: #fff; border-radius: 20px; padding: 40px 28px;
      width: 92%; max-width: 520px; box-shadow: 0 18px 50px rgba(0,0,0,.08); text-align: center;
    }
    .loading-icon { font-size: 3rem; margin-bottom: 18px; }
    .title { font-size: 1.4rem; font-weight: 800; margin-bottom: 10px; color: var(--text); }
    .desc { color: #555; line-height: 1.6; }
    .error, .success {
      padding: 12px; border-radius: 12px; margin-top: 16px; font-size: .95rem; text-align: left;
    }
    .error { background: #fde2e0; color: #8a1c15; border: 1px solid #f3b1ab; }
    .success { background: #def7f0; color: #0a6147; border: 1px solid #a5e3d2; }
  </style>
</head>
<body>
  <div class="callback-container">
    <div class="loading-icon">ğŸ’¬</div>
    <div class="title">LINE ì—°ë™ ì²˜ë¦¬ ì¤‘...</div>
    <div class="desc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. LINE ê³„ì • ì—°ë™ì„ ì™„ë£Œí•˜ê³  ìˆìŠµë‹ˆë‹¤.</div>
    <div id="status" style="margin-top:12px;"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ===== í™˜ê²½ =====
    const SUPABASE_URL = 'https://eevvgbbokenpjnvtmztk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4';
    const EDGE_COMPLETE_URL = `${SUPABASE_URL}/functions/v1/line-auth/complete-auth`;

    function isSameOriginWithOpener() {
      try {
        if (!window.opener) return false;
        return window.opener.location.origin === window.location.origin;
      } catch (e) {
        return false; // cross-origin ì´ë©´ ì ‘ê·¼ ë¶ˆê°€ â†’ false
      }
    }

    async function processLineCallback() {
      const statusEl = document.getElementById('status');

      // 1) URL íŒŒë¼ë¯¸í„°
      const urlParams = new URLSearchParams(window.location.search);
      const code  = urlParams.get('code');
      const state = urlParams.get('state');
      const err   = urlParams.get('error');
      const errDesc = urlParams.get('error_description');

      if (err) {
        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_ERROR', error: errDesc || err }, '*');
        }
        statusEl.innerHTML = `<div class="error">âŒ ${errDesc || err}</div>`;
        setTimeout(() => window.close(), 900);
        return;
      }

      if (!code) {
        statusEl.innerHTML = `<div class="error">âŒ Authorization codeê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        setTimeout(() => window.close(), 900);
        return;
      }

      // 2) cross-origin ì´ë©´ ë©”ì¸ ì°½ìœ¼ë¡œ code/state ë¦´ë ˆì´ í›„ ì¢…ë£Œ (ê¶Œì¥ ê²½ë¡œ)
      const sameOrigin = isSameOriginWithOpener();
      if (!sameOrigin && window.opener) {
        window.opener.postMessage({ type: 'LINE_AUTH_CODE', code, state }, '*');
        statusEl.innerHTML = `<div class="success">ğŸ” ë©”ì¸ ì°½ìœ¼ë¡œ ì¸ì¦ ì½”ë“œë¥¼ ì „ë‹¬í–ˆìŠµë‹ˆë‹¤.</div>`;
        setTimeout(() => window.close(), 500);
        return;
      }

      // 3) same-origin ì´ë©´ íŒì—…ì—ì„œ ì§ì ‘ ì²˜ë¦¬ (ì˜µì…˜)
      let supabase;
      try {
        if (sameOrigin && window.opener && window.opener.supabase) {
          supabase = window.opener.supabase;
        } else {
          supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
      } catch (e) {
        // ì˜ˆì™¸ ì‹œ ë¦´ë ˆì´ë¡œ í´ë°±
        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_CODE', code, state }, '*');
          statusEl.innerHTML = `<div class="success">ğŸ” ë©”ì¸ ì°½ìœ¼ë¡œ ì¸ì¦ ì½”ë“œë¥¼ ì „ë‹¬í–ˆìŠµë‹ˆë‹¤.</div>`;
          setTimeout(() => window.close(), 500);
          return;
        }
        statusEl.innerHTML = `<div class="error">âŒ ì¸ì¦ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨</div>`;
        return;
      }

      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');

        const resp = await fetch(EDGE_COMPLETE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({ code, state })
        });
        if (!resp.ok) throw new Error(await resp.text());
        const result = await resp.json();
        if (!result.success) throw new Error(result.error || 'LINE ì¸ì¦ ì²˜ë¦¬ ì‹¤íŒ¨');

        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_SUCCESS', message: result.message || 'ì—°ë™ ì™„ë£Œ', addFriend: true }, '*');
        }
        statusEl.innerHTML = `
          <div class="success">
            <strong>âœ… LINE ì—°ë™ ì„±ê³µ!</strong><br>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(10,97,71,0.2);">
              ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë ¤ë©´ PUZZMI Botì„ ì¹œêµ¬ ì¶”ê°€í•´ì£¼ì„¸ìš”!
            </div>
          </div>
        `;
        setTimeout(() => window.close(), 2000);
      } catch (e) {
        if (window.opener) {
          window.opener.postMessage({ type: 'LINE_AUTH_ERROR', error: String(e && e.message ? e.message : e) }, '*');
        }
        statusEl.innerHTML = `<div class="error">âŒ ${String(e && e.message ? e.message : e)}</div>`;
        setTimeout(() => window.close(), 1200);
      }
    }

    (async () => { await processLineCallback(); })();
  </script>
</body>
</html>
