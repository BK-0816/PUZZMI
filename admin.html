
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUZZMI ê´€ë¦¬ì - ì˜ˆì•½ ê´€ë¦¬</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body.bg-cream { background: var(--bg-cream); background-repeat:no-repeat; background-size:cover; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid rgba(0,0,0,.06); text-align:left; vertical-align: top; }
    th { font-size: 12px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: .02em; }
    tr:hover { background: #fff; }
    .pill { padding: 4px 8px; border-radius: 999px; font-size: 12px; border:1px solid rgba(0,0,0,.08); background:#fff; }
    .actions .btn { padding: 8px 10px; font-size: 13px; border-radius: 10px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .toolbar .select, .toolbar .input { height: 40px; }
    .muted-sm { color: var(--text-secondary); font-size: 12px; }
  </style>
</head>
<body class="bg-cream">
  <main class="page stack-16">
    <header class="card">
      <h2 style="margin:0 0 6px;">ì˜ˆì•½ ê´€ë¦¬</h2>
      <div class="muted">ìƒˆ ì˜ˆì•½ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë“¤ì–´ì˜µë‹ˆë‹¤. ìƒíƒœë¥¼ í™•ì¸/ë³€ê²½í•˜ì„¸ìš”.</div>
      <div id="authBox" class="stack-16" style="margin-top:12px;">
        <div class="label">ê´€ë¦¬ì ë¡œê·¸ì¸ (ì´ë©”ì¼ OTP)</div>
        <div class="toolbar">
          <input id="email" class="input" type="email" placeholder="admin@example.com" style="max-width:320px"/>
          <button id="sendOtp" class="btn btn-primary" type="button">ë¡œê·¸ì¸ ë©”ì¼ ë³´ë‚´ê¸°</button>
          <span class="muted-sm">ë©”ì¼ì˜ ë§í¬ë¥¼ í´ë¦­í•´ ëŒì•„ì˜¤ë©´ ëª©ë¡ì´ ë³´ì…ë‹ˆë‹¤.</span>
        </div>
      </div>
    </header>

    <section class="card">
      <div class="toolbar" style="justify-content: space-between;">
        <div class="toolbar">
          <select id="statusFilter" class="select">
            <option value="pending">ëŒ€ê¸°ì¤‘(pending)</option>
            <option value="confirmed">í™•ì •(confirmed)</option>
            <option value="completed">ì™„ë£Œ(completed)</option>
            <option value="declined">ê±°ì ˆ(declined)</option>
            <option value="cancelled">ì·¨ì†Œ(cancelled)</option>
            <option value="all">ì „ì²´</option>
          </select>
          <input id="search" class="input" placeholder="ì´ë¦„/ì—°ë½ì²˜/ë©”ì´íŠ¸ ì´ë¦„ ê²€ìƒ‰"/>
        </div>
        <div class="toolbar">
          <button id="refresh" class="btn btn-secondary" type="button">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="muted-sm">* ìƒíƒœ ë³€ê²½ì€ ê´€ë¦¬ì ê¶Œí•œì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ê¶Œí•œì´ ì—†ë‹¤ë©´ Supabaseì—ì„œ admin_usersì— ë³¸ì¸ IDë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div>

      <div class="spacer"></div>
      <div style="overflow:auto;">
        <table id="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>ìƒíƒœ</th>
              <th>ì¼ì‹œ</th>
              <th>ê³ ê°</th>
              <th>ì—°ë½ì²˜</th>
              <th>ì–¸ì–´</th>
              <th>ë©”ì´íŠ¸</th>
              <th>ìš”ì²­ì‚¬í•­</th>
              <th>LINE ì—°ë™</th>
              <th>ì¡°ì¹˜</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://eevvgbbokenpjnvtmztk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const email = document.getElementById('email');
    const sendOtp = document.getElementById('sendOtp');

    sendOtp.addEventListener('click', async () => {
      const v = email.value.trim();
      if (!v) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      const { error } = await supabase.auth.signInWithOtp({ email: v, options: { emailRedirectTo: window.location.href } });
      if (error) alert('ì „ì†¡ ì‹¤íŒ¨: ' + error.message); else alert('ë¡œê·¸ì¸ ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
    });

    const tbody = document.getElementById('tbody');
    const statusFilter = document.getElementById('statusFilter');
    const refresh = document.getElementById('refresh');
    const search = document.getElementById('search');

    let rows = [];
    let matesMap = new Map();
    let lineAccountsMap = new Map();

    async function ensureAdmin() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return false;
      // must exist in admin_users
      const { data, error } = await supabase.from('admin_users').select('user_id').eq('user_id', user.id).maybeSingle();
      if (error) { console.error(error); return false; }
      return !!data;
    }

    async function loadMatesMap() {
      const { data, error } = await supabase
        .from('mate_profiles')
        .select('user_id, profiles(full_name)');
      if (!error && data) {
        matesMap = new Map(data.map(r => [r.user_id, (r.profiles && r.profiles.full_name) || r.user_id]));
      }
    }

    async function loadLineAccountsMap() {
      const { data, error } = await supabase
        .from('user_line_accounts')
        .select('user_id, line_user_id, line_display_name');
      if (!error && data) {
        lineAccountsMap = new Map(data.map(r => [r.user_id, r]));
      }
    }

    function render() {
      const q = (search.value || '').toLowerCase();
      const st = statusFilter.value;
      const filtered = rows.filter(r => 
        (st === 'all' || r.status === st) &&
        (
          (r.customer_name || '').toLowerCase().includes(q) ||
          (r.customer_contact || '').toLowerCase().includes(q) ||
          (matesMap.get(r.mate_id) || '').toLowerCase().includes(q)
        )
      );

      tbody.innerHTML = filtered.map(r => {
        const mateName = matesMap.get(r.mate_id) || r.mate_id;
        const dt = `${r.date} ${r.start_time}`;
        const lineAccount = r.customer_id ? lineAccountsMap.get(r.customer_id) : null;
        const lineStatus = lineAccount
          ? `<span style="color: #28a745;">âœ“ ${lineAccount.line_display_name}</span>`
          : '<span style="color: #999;">ë¯¸ì—°ë™</span>';

        return `
          <tr>
            <td>${r.id}</td>
            <td><span class="pill">${r.status}</span></td>
            <td>${dt}</td>
            <td>${r.customer_name}</td>
            <td>${r.customer_contact}</td>
            <td>${r.language || '-'}</td>
            <td>${mateName}</td>
            <td style="max-width:320px">${(r.notes||'').replace(/</g,'&lt;')}</td>
            <td>${lineStatus}</td>
            <td class="actions">
              ${lineAccount ? `
                <button class="btn btn-success" data-id="${r.id}" data-action="send-passport" title="ì—¬ê¶Œ ì¸ì¦ ìš”ì²­">
                  ğŸ›‚ ì—¬ê¶Œ
                </button>
                <button class="btn btn-success" data-id="${r.id}" data-action="send-payment" title="ê²°ì œ ìš”ì²­">
                  ğŸ’³ ê²°ì œ
                </button>
              ` : ''}
              ${['confirmed','completed','cancelled'].map(s => `
                <button class="btn btn-secondary" data-id="${r.id}" data-status="${s}">${s}</button>
              `).join('')}
            </td>
          </tr>
        `;
      }).join('');

      // wire buttons
      tbody.querySelectorAll('button[data-id]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const status = btn.getAttribute('data-status');
          const action = btn.getAttribute('data-action');
          const ok = await ensureAdmin();
          if (!ok) return alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');

          if (action === 'send-passport') {
            await sendPassportVerification(id);
          } else if (action === 'send-payment') {
            await sendPaymentRequest(id);
          } else if (status) {
            const { error } = await supabase.from('bookings').update({ status }).eq('id', id);
            if (error) alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
          }
        });
      });
    }

    async function sendPassportVerification(bookingId) {
      const booking = rows.find(r => r.id == bookingId);
      if (!booking || !booking.customer_id) {
        alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      if (!confirm('ì—¬ê¶Œ ì¸ì¦ ë§í¬ë¥¼ LINEìœ¼ë¡œ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const passportUrl = `${window.location.origin}/passport_verification.html?booking_id=${bookingId}`;

        const { data: { session } } = await supabase.auth.getSession();
        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-line-notification`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            userId: booking.customer_id,
            bookingId: bookingId,
            type: 'passport_verification',
            passportVerificationUrl: passportUrl
          })
        });

        const result = await response.json();
        if (result.success) {
          alert('âœ“ LINE ë©”ì‹œì§€ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
          alert('ë°œì†¡ ì‹¤íŒ¨: ' + result.error);
        }
      } catch (error) {
        console.error('Send error:', error);
        alert('ë°œì†¡ ì‹¤íŒ¨: ' + error.message);
      }
    }

    async function sendPaymentRequest(bookingId) {
      const booking = rows.find(r => r.id == bookingId);
      if (!booking || !booking.customer_id) {
        alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const amountStr = prompt('ê²°ì œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì›):', '40000');
      if (!amountStr) return;

      const amount = parseInt(amountStr);
      if (isNaN(amount) || amount <= 0) {
        alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      try {
        const { data: payment, error: paymentError } = await supabase
          .from('kg_inicis_payments')
          .insert({
            booking_id: bookingId,
            user_id: booking.customer_id,
            mate_id: booking.mate_id,
            amount: amount,
            currency: 'KRW',
            payment_status: 'pending',
            oid: `PUZZMI_${bookingId}_${Date.now()}`
          })
          .select()
          .single();

        if (paymentError) throw paymentError;

        const paymentUrl = `${window.location.origin}/kg_inicis_payment.html?payment_id=${payment.id}`;

        const { data: { session } } = await supabase.auth.getSession();
        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-line-notification`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            userId: booking.customer_id,
            bookingId: bookingId,
            type: 'payment_request',
            paymentUrl: paymentUrl,
            amount: amount
          })
        });

        const result = await response.json();

        await supabase
          .from('kg_inicis_payments')
          .update({
            payment_status: 'sent',
            line_message_sent: true,
            line_message_sent_at: new Date().toISOString(),
            payment_url: paymentUrl
          })
          .eq('id', payment.id);

        if (result.success) {
          alert(`âœ“ ê²°ì œ ìš”ì²­ì´ LINEìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nê¸ˆì•¡: ${amount.toLocaleString()}ì›`);
        } else {
          alert('ë°œì†¡ ì‹¤íŒ¨: ' + result.error);
        }
      } catch (error) {
        console.error('Payment request error:', error);
        alert('ë°œì†¡ ì‹¤íŒ¨: ' + error.message);
      }
    }

    async function load() {
      const { data, error } = await supabase
        .from('bookings')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(200);
      if (error) { console.error(error); return; }
      rows = data || [];
      render();
    }

    // Realtime: listen for new bookings
    const channel = supabase.channel('bookings:changes')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'bookings' }, payload => {
        rows.unshift(payload.new);
        render();
      })
      .subscribe();

    // filters
    statusFilter.addEventListener('change', render);
    refresh.addEventListener('click', () => load());
    search.addEventListener('input', render);

    // initial
    await loadMatesMap();
    await loadLineAccountsMap();
    await load();
  </script>
</body>
</html>
