<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUZZMI - 메이트 프로필 편집</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <script type="module" src="nav.js"></script>
  <style>
    body.bg-cream { background: var(--bg-cream); background-repeat:no-repeat; background-size:cover; }
    .wrap{ max-width:980px; margin:40px auto; }
    .grid{ display:grid; gap:16px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .card h2{ margin:0 0 8px; }
    .muted{ color:var(--text-secondary); }
    .help{ font-size:.9rem; color:var(--text-secondary); }
    .carousel{ position:relative; }
    .carousel .track{ display:flex; gap:8px; overflow-x:auto; scroll-snap-type:x mandatory; padding:6px; }
    .carousel .track::-webkit-scrollbar{ height:8px; }
    .carousel .track > img{ flex:0 0 auto; width:280px; height:200px; object-fit:cover; border-radius:12px; scroll-snap-align:start; background:#f5f5f5; }
    .carousel .nav{ position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,.5); color:#fff; border:none; width:36px; height:36px; border-radius:50%; cursor:pointer; }
    .carousel .prev{ left:6px; }
    .carousel .next{ right:6px; }
    figure.thumb{ width:140px; }
    figure.thumb img{ width:100%; height:110px; object-fit:cover; border-radius:8px; }
    figure.thumb figcaption{ font-size:.8rem; display:flex; flex-direction:column; gap:6px; margin-top:6px; }
    .btn-danger{ background:#e53935; color:#fff; }
    .btn-light{ background:#fff; border:1px solid #ddd; }
    .w-100{ width:100%; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#f5f5f5; border:1px solid #eee; font-size:.75rem; }
    .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 640px){ .two-col{ grid-template-columns:1fr; } }
  </style>
</head>
<body class="bg-cream">
  <div id="app-nav"></div>
  <main class="wrap">
    <section class="card">
      <h2>메이트 프로필 편집</h2>
      <p class="help">여러 장의 사진을 업로드하고, <b>대표사진</b>을 지정할 수 있습니다. 대표사진은 목록/프로필 썸네일의 첫 번째로 노출돼요.</p>

      <!-- 업로더 -->
      <div class="grid">
        <div class="field">
          <div class="label">프로필 사진 (여러 장 선택 가능)</div>
          <input id="photosInput" type="file" accept="image/*" multiple />
          <div id="uploadMsg" class="muted" style="margin-top:6px"></div>
        </div>

        <!-- 썸네일 & 삭제/대표설정 -->
        <div class="row" id="thumbs"></div>

        <!-- 캐러셀 미리보기 -->
        <div class="card" style="background:#fff;">
          <h3 style="margin-top:0">미리보기</h3>
          <div class="carousel">
            <button class="nav prev" aria-label="이전">‹</button>
            <div class="track" id="photoTrack"></div>
            <button class="nav next" aria-label="다음">›</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 계정 기본정보(profiles) -->
    <section class="card">
      <h3>계정 기본정보</h3>
      <form id="formAccount" class="grid">
        <div class="two-col">
          <div class="field">
            <div class="label">이름</div>
            <input id="fullName" class="input" placeholder="예: 김지은" />
          </div>
          <div class="field">
            <div class="label">나이</div>
            <input id="age" type="number" min="16" max="100" class="input" placeholder="예: 26"/>
          </div>
        </div>
        <div class="field" style="max-width:320px">
          <div class="label">성별</div>
          <select id="gender" class="input">
            <option value="">선택 안함</option>
            <option value="female">여성 (♀)</option>
            <option value="male">남성 (♂)</option>
            <option value="other">기타/비공개 (⚧)</option>
          </select>
        </div>

        <div class="row">
          <button class="btn btn-primary" type="submit">기본정보 저장</button>
          <div id="saveAccountMsg" class="muted"></div>
        </div>
      </form>
    </section>

    <!-- 활동 정보(mate_profiles) -->
    <section class="card">
      <h3>활동 정보</h3>
      <form id="formProfile" class="grid">
        <div class="field">
          <div class="label">소개 (bio)</div>
          <textarea id="bio" class="input" placeholder="함께 서울의 숨은 명소를 즐겨봐요!"></textarea>
        </div>
        <div class="field">
          <div class="label">시급</div>
          <input id="hourly" type="number" class="input" min="0" step="1000" placeholder="예: 40000"/>
          <div class="help">원화(₩) 기준. 프론트에서 통화표시는 자유롭게 변환해 표시할 수 있습니다.</div>
        </div>
        <div class="field">
          <div class="label">태그 (콤마로 구분)</div>
          <input id="tags" class="input" placeholder="맛집, 카페, 쇼핑"/>
        </div>
        <div class="field">
          <div class="label">활동 지역 (콤마로 구분)</div>
          <input id="areas" class="input" placeholder="홍대, 강남, 익선동"/>
        </div>

        <div class="row">
          <button class="btn btn-primary" type="submit">활동정보 저장</button>
          <div id="saveMsg" class="muted"></div>
        </div>
      </form>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(
      "https://eevvgbbokenpjnvtmztk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4"
    );

    // 엘리먼트
    const photosInput = document.getElementById('photosInput');
    const uploadMsg   = document.getElementById('uploadMsg');
    const thumbs      = document.getElementById('thumbs');
    const track       = document.getElementById('photoTrack');

    const formAccount = document.getElementById('formAccount');
    const fullNameEl  = document.getElementById('fullName');
    const ageEl       = document.getElementById('age');
    const genderEl    = document.getElementById('gender');
    const saveAccountMsg = document.getElementById('saveAccountMsg');

    const formProfile = document.getElementById('formProfile');
    const bioEl   = document.getElementById('bio');
    const hourlyEl= document.getElementById('hourly');
    const tagsEl  = document.getElementById('tags');
    const areasEl = document.getElementById('areas');
    const saveMsg = document.getElementById('saveMsg');

    const prevBtn = document.querySelector('.carousel .prev');
    const nextBtn = document.querySelector('.carousel .next');

    // 로그인 확인
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      const redir = encodeURIComponent('mate_edit.html');
      location.replace(`auth_combo.html?redirect=${redir}`);
      throw new Error('login required');
    }

    // helpers
    const keyToUrl = (key) => {
      const pure = key.startsWith('mates/') ? key.replace(/^mates\//,'') : key;
      return supabase.storage.from('mates').getPublicUrl(pure).data.publicUrl;
    };
    const orderKeys = (photos, primary) => {
      const arr = Array.isArray(photos) ? [...photos] : [];
      const out = [];
      if (primary) out.push(primary);
      for (const k of arr) if (!out.includes(k)) out.push(k);
      return out;
    };

    // 현재 데이터 로드
    async function loadAll() {
      // profiles
      const { data: prof } = await supabase
        .from('profiles')
        .select('id, full_name, age, gender')
        .eq('id', user.id)
        .maybeSingle();
      if (prof) {
        fullNameEl.value = prof.full_name ?? '';
        ageEl.value      = prof.age ?? '';
        genderEl.value   = (prof.gender ?? '').toLowerCase();
      }

      // mate_profiles
      const { data: mp } = await supabase
        .from('mate_profiles')
        .select('user_id, bio, hourly_rate, tags, areas, photos, primary_photo')
        .eq('user_id', user.id)
        .maybeSingle();

      if (!mp) {
        // 없으면 생성
        const { data: created } = await supabase
          .from('mate_profiles')
          .insert({ user_id: user.id, tags: [], areas: [], photos: [] })
          .select()
          .single();
        renderProfile(created);
      } else {
        renderProfile(mp);
      }
    }

    let profileRow = null;
    function renderProfile(p) {
      profileRow = p;
      bioEl.value    = p.bio ?? '';
      hourlyEl.value = p.hourly_rate ?? '';
      tagsEl.value   = Array.isArray(p.tags) ? p.tags.join(', ') : '';
      areasEl.value  = Array.isArray(p.areas) ? p.areas.join(', ') : '';
      renderThumbs(p.photos || [], p.primary_photo);
      renderCarousel(p.photos || [], p.primary_photo);
    }

    function renderThumbs(keys, primary) {
      const list = orderKeys(keys, primary);
      if (!list.length) { thumbs.innerHTML = ''; return; }

      thumbs.innerHTML = list.map(k => `
        <figure class="thumb">
          <img src="${keyToUrl(k)}" alt="사진"/>
          <figcaption>
            <span class="badge" style="${k===primary?'background:#ffe4e6;border-color:#ff9aa2;':''}">
              ${k===primary ? '대표 사진' : '일반 사진'}
            </span>
            <button type="button" class="btn btn-light" data-set-primary="${k}">대표로</button>
            <button type="button" class="btn btn-danger" data-remove="${k}">삭제</button>
          </figcaption>
        </figure>
      `).join('');

      // 대표 설정
      thumbs.querySelectorAll('[data-set-primary]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const key = btn.getAttribute('data-set-primary');
          const { error } = await supabase.from('mate_profiles')
            .update({ primary_photo: key })
            .eq('user_id', user.id);
          if (error) return alert('대표 지정 실패: ' + error.message);
          profileRow.primary_photo = key;
          renderProfile(profileRow);
        });
      });

      // 삭제
      thumbs.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const key = btn.getAttribute('data-remove');
          // 스토리지 삭제
          await supabase.storage.from('mates').remove([key]).catch(()=>{});
          // DB 배열 갱신
          let nextPhotos  = (profileRow.photos || []).filter(x => x !== key);
          let nextPrimary = profileRow.primary_photo;
          if (key === nextPrimary) nextPrimary = nextPhotos[0] || null;

          const { error } = await supabase.from('mate_profiles')
            .update({ photos: nextPhotos, primary_photo: nextPrimary })
            .eq('user_id', user.id);
          if (error) return alert('DB 반영 실패: ' + error.message);

          profileRow.photos = nextPhotos;
          profileRow.primary_photo = nextPrimary;
          renderProfile(profileRow);
        });
      });
    }

    function renderCarousel(keys, primary) {
      const list = orderKeys(keys, primary);
      if (!list.length) { track.innerHTML = '<div class="muted" style="padding:8px">등록된 사진이 없습니다.</div>'; return; }
      track.innerHTML = list.map(k => `<img src="${keyToUrl(k)}" alt="메이트 사진">`).join('');
    }

    prevBtn.addEventListener('click', () => track.scrollBy({ left: -300, behavior: 'smooth' }));
    nextBtn.addEventListener('click', () => track.scrollBy({ left:  300, behavior: 'smooth' }));

    // 업로드
    document.getElementById('photosInput').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      uploadMsg.textContent = '업로드 중…';

      const uploaded = [];
      for (const f of files) {
        if (!f.type.startsWith('image/')) continue;
        if (f.size > 8 * 1024 * 1024) { uploadMsg.textContent = '8MB 이하 이미지만 업로드 가능합니다.'; continue; }
        const ext = (f.name.split('.').pop() || 'jpg').toLowerCase();
        const key = `${user.id}/${crypto.randomUUID()}.${ext}`;
        const { error: upErr } = await supabase.storage.from('mates').upload(key, f, { upsert: false, contentType: f.type || 'image/jpeg' });
        if (upErr) { console.error(upErr); uploadMsg.textContent = '일부 파일 업로드 실패: ' + upErr.message; continue; }
        uploaded.push(key);
      }

      if (uploaded.length) {
        const nextPhotos = [...(profileRow.photos || []), ...uploaded];
        const nextPrimary = profileRow.primary_photo || uploaded[0];
        const { error: dbErr } = await supabase.from('mate_profiles')
          .update({ photos: nextPhotos, primary_photo: nextPrimary })
          .eq('user_id', user.id);
        if (dbErr) { uploadMsg.textContent = 'DB 반영 실패: ' + dbErr.message; }
        else {
          profileRow.photos = nextPhotos;
          profileRow.primary_photo = nextPrimary;
          uploadMsg.textContent = '업로드 완료!';
          renderProfile(profileRow);
        }
      }
      e.target.value = '';
    });

    // 계정 기본정보 저장 (profiles)
    formAccount.addEventListener('submit', async (e) => {
      e.preventDefault();
      saveAccountMsg.textContent = '';

      const payload = {
        id: user.id, // upsert 키
        full_name: fullNameEl.value || null,
        age: ageEl.value ? parseInt(ageEl.value, 10) : null,
        gender: (genderEl.value || '').toLowerCase() || null
      };

      const { error } = await supabase
        .from('profiles')
        .upsert(payload, { onConflict: 'id' });

      if (error) saveAccountMsg.textContent = '저장 실패: ' + error.message;
      else       saveAccountMsg.textContent = '저장되었습니다.';
    });

    // 활동정보 저장 (mate_profiles)
    formProfile.addEventListener('submit', async (e) => {
      e.preventDefault();
      const tags  = tagsEl.value.split(',').map(s => s.trim()).filter(Boolean);
      const areas = areasEl.value.split(',').map(s => s.trim()).filter(Boolean);
      const hourly= hourlyEl.value ? parseInt(hourlyEl.value, 10) : null;

      const { error } = await supabase.from('mate_profiles')
        .update({
          bio: bioEl.value || null,
          hourly_rate: isNaN(hourly) ? null : hourly,
          tags,
          areas
        })
        .eq('user_id', user.id);

      if (error) saveMsg.textContent = '저장 실패: ' + error.message;
      else       saveMsg.textContent = '저장되었습니다.';
    });

    // 초기 로드
    await loadAll();
  </script>
</body>
</html>
