<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>決済結果 - SeoulDays</title>
    <link rel="stylesheet" href="payment_samples/japan/style.css">
    <link rel="stylesheet" href="payment_samples/japan/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="wrap">
    <main class="col-8 cont" id="bill-01">
        <section class="mb-5">
            <div class="tit">
                <h2>日本決済</h2>
                <p>KGイニシス決済窓口を呼び出してCBT決済を提供するサービス</p>
            </div>
        </section>

        <section class="menu_cont mb-5">
            <div class="card">
                <div class="card_tit">
                    <h3>CBT決済結果</h3>
                </div>

                <div id="loading-container" class="mt-5 text-center">
                    <p>決済結果を確認中...</p>
                </div>

                <div id="result-container" class="mt-5" style="display: none;">
                    <form name="resultForm" id="resultForm" class="mt-5">
                        <div class="row g-3 justify-content-between" style="--bs-gutter-x:0rem;">

                            <label class="col-10 col-sm-2 gap-2 input param" style="border:none;">resultCode</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="resultCode"></span>
                            </label>

                            <label class="col-10 col-sm-2 input param" style="border:none;">errorCode</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="errorCode"></span>
                            </label>

                            <label class="col-10 col-sm-2 input param" style="border:none;">resultMsg</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="resultMsg"></span>
                            </label>

                            <label class="col-10 col-sm-2 input param" style="border:none;">tid</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="tid"></span>
                            </label>

                            <label class="col-10 col-sm-2 input param" style="border:none;">orderId</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="orderId"></span>
                            </label>

                            <label class="col-10 col-sm-2 input param" style="border:none;">applDate</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="applDate"></span>
                            </label>

                            <label class="col-10 col-sm-2 input param" style="border:none;">applTime</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="applTime"></span>
                            </label>

                            <label class="col-10 col-sm-2 input param" style="border:none;">paymethod</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="paymethod"></span>
                            </label>

                            <label class="col-10 col-sm-2 input param" style="border:none;">amount</label>
                            <label class="col-10 col-sm-9 input">
                                <span id="amount"></span>
                            </label>

                        </div>
                    </form>

                    <div id="success-message" style="display: none;" class="mt-4 p-4 bg-success text-white text-center rounded">
                        <h4>決済が正常に完了しました！</h4>
                        <p>ご利用ありがとうございます。</p>
                    </div>

                    <div id="failure-message" style="display: none;" class="mt-4 p-4 bg-danger text-white text-center rounded">
                        <h4>決済に失敗しました</h4>
                        <p>もう一度お試しください。</p>
                    </div>

                    <div class="mt-4 text-center">
                        <button onclick="goToHome()" class="btn_solid_pri col-6 mx-auto btn_lg">ホームに戻る</button>
                        <button onclick="goToMyBookings()" class="btn_solid_sec col-6 mx-auto btn_lg mt-3">予約リストを見る</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const supabaseUrl = 'https://eevvgbbokenpjnvtmztk.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4';
        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        async function processPaymentReturn() {
            const urlParams = new URLSearchParams(window.location.search);

            const resultCode = urlParams.get('resultCode');
            const errorCode = urlParams.get('errorCode');
            const resultMsg = urlParams.get('resultMsg');
            const orderID = urlParams.get('orderID');
            const mid = urlParams.get('mid');
            const sid = urlParams.get('sid');
            const paymethod = urlParams.get('paymethod');

            if (resultCode === 'OK') {
                try {
                    const response = await fetch('https://cbt.inicis.com/cbtapprove', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            mid: mid,
                            sid: sid
                        })
                    });

                    const approvalResult = await response.json();

                    const { data: paymentRequest, error: findError } = await supabase
                        .from('japan_payment_requests')
                        .select('*')
                        .eq('order_id', orderID)
                        .single();

                    if (findError || !paymentRequest) {
                        console.error('Payment request not found');
                        showFailure();
                        return;
                    }

                    const { error: resultError } = await supabase
                        .from('japan_payment_results')
                        .insert({
                            payment_request_id: paymentRequest.id,
                            tid: approvalResult.tid,
                            result_code: approvalResult.resultCode,
                            error_code: approvalResult.errorCode,
                            result_msg: approvalResult.resultMsg,
                            sid: sid,
                            paymethod: approvalResult.paymethod || paymethod,
                            appl_date: approvalResult.applDate,
                            appl_time: approvalResult.applTime,
                            appl_no: approvalResult.applNo,
                            pay_nm: approvalResult.payNm,
                            raw_response: approvalResult
                        });

                    if (resultError) {
                        console.error('Error saving payment result:', resultError);
                    }

                    const newStatus = approvalResult.resultCode === '00' ? 'completed' : 'failed';
                    await supabase
                        .from('japan_payment_requests')
                        .update({ status: newStatus, updated_at: new Date().toISOString() })
                        .eq('id', paymentRequest.id);

                    if (paymentRequest.booking_id && newStatus === 'completed') {
                        await supabase
                            .from('bookings')
                            .update({ payment_status: 'completed' })
                            .eq('id', paymentRequest.booking_id);
                    }

                    displayResult(approvalResult, paymentRequest.amount);

                    if (approvalResult.resultCode === '00') {
                        showSuccess();
                    } else {
                        showFailure();
                    }

                } catch (error) {
                    console.error('Error processing payment approval:', error);
                    showFailure();
                }

            } else {
                displayResult({
                    resultCode: resultCode,
                    errorCode: errorCode,
                    resultMsg: resultMsg,
                    orderID: orderID,
                    paymethod: paymethod
                }, null);
                showFailure();
            }

            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('result-container').style.display = 'block';
        }

        function displayResult(result, amount) {
            document.getElementById('resultCode').textContent = result.resultCode || '';
            document.getElementById('errorCode').textContent = result.errorCode || '';
            document.getElementById('resultMsg').textContent = result.resultMsg || '';
            document.getElementById('tid').textContent = result.tid || '';
            document.getElementById('orderId').textContent = result.orderID || '';
            document.getElementById('applDate').textContent = result.applDate || '';
            document.getElementById('applTime').textContent = result.applTime || '';
            document.getElementById('paymethod').textContent = result.paymethod || '';
            document.getElementById('amount').textContent = amount ? `¥${amount}` : '';
        }

        function showSuccess() {
            document.getElementById('success-message').style.display = 'block';
            document.getElementById('failure-message').style.display = 'none';
        }

        function showFailure() {
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('failure-message').style.display = 'block';
        }

        function goToHome() {
            window.location.href = '/index.html';
        }

        function goToMyBookings() {
            window.location.href = '/my_bookings.html';
        }

        window.onload = processPaymentReturn;
    </script>
</body>
</html>