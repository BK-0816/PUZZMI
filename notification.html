<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>알림함 - PUZZMI</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <script type="module" src="nav.js"></script>
  <style>
    body.bg-cream { 
      background: var(--bg-cream); 
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    /* 배경 장식 요소 */
    .decorative-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    
    .decorative-element {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.3;
      animation: float 8s ease-in-out infinite;
    }
    
    .decorative-element:nth-child(1) {
      width: 200px;
      height: 200px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      top: 10%;
      left: 5%;
      animation-delay: 0s;
    }
    
    .decorative-element:nth-child(2) {
      width: 150px;
      height: 150px;
      background: linear-gradient(45deg, #f093fb, #f5576c);
      top: 60%;
      right: 10%;
      animation-delay: 2s;
    }
    
    .decorative-element:nth-child(3) {
      width: 120px;
      height: 120px;
      background: linear-gradient(45deg, #4facfe, #00f2fe);
      bottom: 20%;
      left: 15%;
      animation-delay: 4s;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-20px) rotate(120deg); }
      66% { transform: translateY(10px) rotate(240deg); }
    }
    
    /* 메인 컨테이너 */
    .wrap { 
      max-width: 1000px; 
      margin: 40px auto; 
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }
    
    /* 페이지 헤더 */
    .page-header {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 28px;
      padding: 40px;
      margin-bottom: 32px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
      text-align: center;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
      animation: shimmer 3s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .page-header h2 {
      font-size: 2.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 30%, #f093fb 70%, #f5576c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 16px 0;
      letter-spacing: -0.02em;
      position: relative;
    }
    
    .page-header h2::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #f093fb 100%);
      border-radius: 2px;
    }
    
    .notification-counter {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(240, 147, 251, 0.1) 100%);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 20px;
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.1);
    }
    
    .notification-counter .icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
    }
    
    /* 툴바 */
    .toolbar { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 16px; 
      align-items: center; 
      margin-bottom: 32px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.06);
    }
    
    .toolbar .spacer { 
      flex: 1; 
    }
    
    /* 필터 버튼 */
    .pill { 
      border: 2px solid rgba(102, 126, 234, 0.2);
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      padding: 12px 24px; 
      border-radius: 20px; 
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }
    
    .pill::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s ease;
    }
    
    .pill:hover::before {
      left: 100%;
    }
    
    .pill:hover {
      border-color: rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .pill.active { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: #fff; 
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px) scale(1.05);
    }
    
    /* 모두 읽음 버튼 */
    .btn-mark-all {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 16px rgba(240, 147, 251, 0.3);
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
    }
    
    .btn-mark-all::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .btn-mark-all:hover::before {
      left: 100%;
    }
    
    .btn-mark-all:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 20px rgba(240, 147, 251, 0.4);
    }
    
    /* 알림 목록 */
    .list { 
      display: grid; 
      gap: 20px; 
    }
    
    /* 알림 아이템 */
    .nitem { 
      display: flex; 
      gap: 20px; 
      align-items: flex-start; 
      padding: 32px; 
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 24px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 12px 32px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
    }
    
    .nitem::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 40%, #f093fb 80%, #f5576c 100%);
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }
    
    .nitem:hover {
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.98) 100%);
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 20px 48px rgba(0,0,0,0.12), 0 8px 20px rgba(0,0,0,0.08);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    .nitem:hover::before {
      opacity: 1;
    }
    
    .nitem.unread {
      border-left: 5px solid #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(240, 147, 251, 0.03) 100%);
    }
    
    .nitem.unread::before {
      opacity: 1;
      height: 4px;
    }
    
    /* 읽지 않음 표시 점 */
    .dot { 
      width: 16px; 
      height: 16px; 
      border-radius: 50%; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin-top: 8px; 
      flex: 0 0 auto; 
      visibility: hidden;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      position: relative;
    }
    
    .dot::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }
    
    .nitem.unread .dot { 
      visibility: visible;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }
    
    /* 알림 콘텐츠 */
    .notification-content {
      flex: 1;
    }
    
    .title { 
      font-weight: 800; 
      font-size: 1.3rem;
      margin: 0 0 12px 0;
      color: var(--text-primary);
      line-height: 1.4;
      letter-spacing: -0.01em;
    }
    
    .nitem.unread .title {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .meta { 
      color: var(--text-secondary); 
      font-size: 0.95rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
    }
    
    .meta .type-badge {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      color: #667eea;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .body { 
      white-space: pre-wrap;
      line-height: 1.6;
      font-size: 1.05rem;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(240, 147, 251, 0.02) 100%);
      border-radius: 16px;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    /* 액션 버튼들 */
    .actions { 
      display: flex; 
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .link { 
      color: #667eea;
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
      font-size: 0.9rem;
      letter-spacing: 0.3px;
    }
    
    .link:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
    }
    
    .btn-read {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      color: var(--text-primary);
      border: 1px solid rgba(102, 126, 234, 0.2);
      padding: 8px 16px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(8px);
    }
    
    .btn-read:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
    }
    
    .read-status {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-style: italic;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.03) 100%);
      border-radius: 12px;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    /* 빈 상태 */
    .empty { 
      color: var(--text-secondary); 
      padding: 60px 40px; 
      text-align: center;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      backdrop-filter: blur(15px);
      border: 2px dashed rgba(102, 126, 234, 0.2);
      border-radius: 20px;
      font-size: 1.1rem;
      line-height: 1.6;
    }
    
    .empty::before {
      content: '📭';
      display: block;
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    
    /* 페이지네이션 */
    .pager { 
      display: flex; 
      justify-content: center; 
      gap: 16px; 
      margin-top: 32px;
    }
    
    .pager .pill {
      min-width: 120px;
      text-align: center;
    }
    
    .pager .pill:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .wrap { 
        margin: 20px auto; 
        padding: 0 16px; 
      }
      
      .page-header { 
        padding: 24px; 
        border-radius: 20px;
      }
      
      .page-header h2 { 
        font-size: 2.2rem; 
      }
      
      .toolbar { 
        flex-direction: column; 
        align-items: stretch;
        padding: 20px;
      }
      
      .toolbar .spacer { 
        display: none; 
      }
      
      .nitem { 
        padding: 24px; 
        flex-direction: column;
        gap: 16px;
      }
      
      .dot {
        align-self: flex-start;
        margin-top: 0;
      }
      
      .actions {
        justify-content: center;
      }
      
      .notification-counter {
        font-size: 1rem;
        padding: 10px 20px;
      }
    }
    
    /* 로딩 상태 */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }
    
    .loading::before {
      content: '';
      width: 24px;
      height: 24px;
      border: 3px solid rgba(102, 126, 234, 0.2);
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-cream">
  <!-- 배경 장식 요소 -->
  <div class="decorative-bg">
    <div class="decorative-element"></div>
    <div class="decorative-element"></div>
    <div class="decorative-element"></div>
  </div>

  <div id="app-nav"></div>

  <main class="wrap">
    <!-- 페이지 헤더 -->
    <section class="page-header">
      <h2>알림함</h2>
      <div class="notification-counter" id="counter">
        <div class="icon">🔔</div>
        <span>읽지 않은 알림 0개</span>
      </div>
    </section>

    <!-- 메인 콘텐츠 -->
    <section>
      <!-- 툴바 -->
      <div class="toolbar">
        <button class="pill active" data-filter="all">📋 전체 알림</button>
        <button class="pill" data-filter="unread">🔴 읽지 않음</button>
        <div class="spacer"></div>
        <button class="btn-mark-all" id="markAllRead">✅ 모두 읽음 처리</button>
      </div>

      <!-- 알림 목록 -->
      <div id="list" class="list"></div>
      
      <!-- 페이지네이션 -->
      <div class="pager">
        <button class="pill" id="prev">← 이전 페이지</button>
        <button class="pill" id="next">다음 페이지 →</button>
      </div>
    </section>
  </main>

  <script type="module">
    import { supabase } from './nav.js';

    const PAGE_SIZE = 15;
    let me = null;
    let page = 0;
    let filter = 'all'; // all | unread
    let sub = null;

    const listEl   = document.getElementById('list');
    const counter  = document.getElementById('counter');
    const prevBtn  = document.getElementById('prev');
    const nextBtn  = document.getElementById('next');
    const markAll  = document.getElementById('markAllRead');

    // 로그인 체크 (미로그인 → 로그인 페이지로)
    (async () => {
      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) {
        const redir = encodeURIComponent('notification.html');
        location.replace(`auth_combo.html?redirect=${redir}`);
        return;
      }
      me = user;

      bindEvents();
      await refreshCounter();
      await load();
      subscribeRealtime();
    })();

    function bindEvents(){
      // 필터 탭
      document.querySelectorAll('.pill[data-filter]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          document.querySelectorAll('.pill[data-filter]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          filter = btn.getAttribute('data-filter');
          page = 0;
          await load();
        });
      });

      // 페이지네이션
      prevBtn.addEventListener('click', async ()=>{
        if (page > 0) { page--; await load(); }
      });
      nextBtn.addEventListener('click', async ()=>{
        page++; await load();
      });

      // 모두 읽음
      markAll.addEventListener('click', async ()=>{
        const { error } = await supabase
          .from('notifications')
          .update({ read_at: new Date().toISOString() })
          .eq('user_id', me.id)
          .is('read_at', null);
        if (error) return alert('실패: ' + error.message);
        await refreshCounter();
        await load();
      });
    }

    function nItemHtml(row){
      const cls = row.read_at ? '' : 'unread';
      const when = new Date(row.created_at).toLocaleString('ko-KR');
      const typeKo = row.type === 'booking_declined' ? '예약 거절'
                    : row.type === 'booking_canceled' ? '예약 취소'
                    : row.type === 'booking_confirmed' ? '예약 확정'
                    : row.type === 'review_received' ? '리뷰 등록'
                    : row.type || '일반';
      const linkHtml = row.link ? `<a class="link" data-open="${encodeURIComponent(row.link)}">📋 자세히 보기</a>` : '';

      return `
        <div class="nitem ${cls}" data-id="${row.id}">
          <div class="dot"></div>
          <div class="notification-content">
            <div class="title">${row.title}</div>
            <div class="meta">
              <span class="type-badge">${typeKo}</span>
              <span>•</span>
              <span>📅 ${when}</span>
            </div>
            <div class="body">${(row.body||'').replace(/</g,'&lt;')}</div>
            <div class="actions">
              ${linkHtml}
              ${row.read_at ? '<span class="read-status">✅ 읽음 처리됨</span>' : '<button class="btn-read" data-mark-read>👁️ 읽음 처리</button>'}
            </div>
          </div>
        </div>
      `;
    }

    async function refreshCounter(){
      const { count } = await supabase
        .from('notifications')
        .select('id', { count:'exact', head:true })
        .eq('user_id', me.id)
        .is('read_at', null);
      
      const counterSpan = counter.querySelector('span');
      counterSpan.textContent = `읽지 않은 알림 ${count ?? 0}개`;
    }

    async function load(){
      listEl.innerHTML = '<div class="loading">알림을 불러오는 중...</div>';

      let q = supabase
        .from('notifications')
        .select('*')
        .eq('user_id', me.id)
        .order('created_at', { ascending:false })
        .range(page * PAGE_SIZE, page*PAGE_SIZE + PAGE_SIZE - 1);

      if (filter === 'unread') q = q.is('read_at', null);

      const { data, error } = await q;
      if (error) {
        console.error(error);
        listEl.innerHTML = '<div class="error">❌ 불러오기 실패: '+error.message+'</div>';
        return;
      }

      if (!data?.length){
        listEl.innerHTML = '<div class="empty">표시할 알림이 없습니다.<br>새로운 알림이 오면 여기에 표시됩니다.</div>';
      } else {
        listEl.innerHTML = data.map(nItemHtml).join('');
      }

      // 페이지네이션 버튼 상태
      prevBtn.disabled = page === 0;
      nextBtn.disabled = !data || data.length < PAGE_SIZE;

      // 카드 내 액션들 (읽음/링크)
      listEl.querySelectorAll('[data-mark-read]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const card = btn.closest('.nitem');
          const id = card.getAttribute('data-id');
          const { error } = await supabase.from('notifications').update({ read_at: new Date().toISOString() }).eq('id', id).eq('user_id', me.id);
          if (error) return alert('실패: ' + error.message);
          await refreshCounter();
          await load();
        });
      });

      listEl.querySelectorAll('[data-open]').forEach(a=>{
        a.addEventListener('click', async ()=>{
          const url = decodeURIComponent(a.getAttribute('data-open'));
          // 클릭 시 해당 알림을 읽음처리도 함께
          const card = a.closest('.nitem');
          const id = card.getAttribute('data-id');
          await supabase.from('notifications').update({ read_at: new Date().toISOString() }).eq('id', id).eq('user_id', me.id).catch(()=>{});
          window.location.href = url;
        });
      });
    }

    function subscribeRealtime(){
      if (sub) return;
      sub = supabase
        .channel('realtime:notifications:'+me.id)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'notifications',
          filter: `user_id=eq.${me.id}`
        }, async (_payload) => {
          await refreshCounter();
          // 첫 페이지를 보고 있을 때는 즉시 최신 반영
          if (page === 0) await load();
        })
        .subscribe();
    }
  </script>
</body>
</html>