<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUZZMI - Î©îÏù¥Ìä∏ ÌîÑÎ°úÌïÑ</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <script type="module" src="nav.js"></script>
  <style>
    body.bg-cream { background: var(--bg-cream); background-repeat:no-repeat; background-size:cover; }
    .wrap{ max-width:1200px; margin:40px auto; padding:0 20px; }
    .grid{ display:grid; gap:16px; }
    .card h2{ margin:0 0 16px; font-size:2.5rem; font-weight:800; color:var(--text-primary); letter-spacing:-0.02em; }
    .muted{ color:var(--text-secondary); }
    
    /* ÌîÑÎ°úÌïÑ Ìó§Îçî Í∞úÏÑ† */
    .profile-header {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 24px 48px rgba(0,0,0,0.12), 0 8px 16px rgba(0,0,0,0.08);
      border-radius: 24px;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .profile-header-content {
      position: relative;
      padding: 40px;
    }
    
    .rating-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 10;
    }
    
    .profile-header:hover {
      transform: translateY(-2px);
      box-shadow: 0 32px 64px rgba(0,0,0,0.15), 0 12px 24px rgba(0,0,0,0.1);
    }
    
    .profile-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      animation: shimmer 3s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    /* Ï∫êÎü¨ÏÖÄ Í∞úÏÑ† */
    .carousel{ 
      position:relative; 
      margin: 24px 0;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 12px 32px rgba(0,0,0,0.1);
    }
    .carousel .track{ 
      display:flex; gap:12px; overflow-x:auto; scroll-snap-type:x mandatory; 
      padding:16px; border-radius:20px; 
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.2) 100%);
      backdrop-filter: blur(8px);
    }
    .carousel .track::-webkit-scrollbar{ height:8px; }
    .carousel .track::-webkit-scrollbar-track{ 
      background:rgba(255,255,255,0.3); 
      border-radius:4px; 
      margin: 0 16px;
    }
    .carousel .track::-webkit-scrollbar-thumb{ 
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); 
      border-radius:4px; 
      transition: all 0.3s ease;
    }
    .carousel .track::-webkit-scrollbar-thumb:hover{ 
      background: linear-gradient(90deg, #5a6fd8 0%, #6a4190 100%); 
    }
    .carousel .track > img{ 
      flex:0 0 auto; width:380px; height:260px; object-fit:cover; 
      border-radius:20px; scroll-snap-align:start; background:#f8f9fa;
      box-shadow: 0 12px 32px rgba(0,0,0,0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 2px solid rgba(255,255,255,0.5);
    }
    .carousel .track > img:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 20px 48px rgba(0,0,0,0.2);
      border-color: rgba(255,255,255,0.8);
    }
    .carousel .nav{ 
      position:absolute; top:50%; transform:translateY(-50%); 
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); 
      color:var(--text-primary); 
      border:1px solid rgba(255,255,255,0.3); width:48px; height:48px; 
      border-radius:50%; cursor:pointer; font-size:18px; font-weight:bold;
      backdrop-filter: blur(12px); transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .carousel .nav:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-50%) scale(1.15);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.3);
    }
    .carousel .prev{ left:12px; }
    .carousel .next{ right:12px; }
    
    /* Î©îÌÉÄ Ï†ïÎ≥¥ Í∑∏Î¶¨Îìú Í∞úÏÑ† */
    .meta-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 32px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .meta-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    
    .meta-intro {
      width: 100%;
    }
    
    .meta-card {
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      padding: 20px 14px;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      min-height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
    }
    
    /* Í∞Å Ïπ¥ÎìúÎ≥Ñ Îã§Ï±ÑÎ°úÏö¥ ÏÉâÏÉÅ */
    .meta-card:nth-child(1) {
      background: linear-gradient(135deg, rgba(255, 182, 193, 0.8) 0%, rgba(255, 218, 185, 0.6) 100%);
    }
    
    .meta-card:nth-child(2) {
      background: linear-gradient(135deg, rgba(173, 216, 230, 0.8) 0%, rgba(176, 196, 222, 0.6) 100%);
    }
    
    .meta-card:nth-child(3) {
      background: linear-gradient(135deg, rgba(221, 160, 221, 0.8) 0%, rgba(238, 130, 238, 0.6) 100%);
    }
    
    .meta-card:nth-child(4) {
      background: linear-gradient(135deg, rgba(152, 251, 152, 0.8) 0%, rgba(144, 238, 144, 0.6) 100%);
    }
    
    .meta-card:nth-child(5) {
      background: linear-gradient(135deg, rgba(255, 218, 185, 0.8) 0%, rgba(255, 228, 196, 0.6) 100%);
    }
    
    .meta-card:nth-child(6) {
      background: linear-gradient(135deg, rgba(255, 192, 203, 0.8) 0%, rgba(255, 182, 193, 0.6) 100%);
    }
    
    .meta-card:nth-child(7) {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.8) 0%, rgba(255, 228, 181, 0.6) 100%);
    }
    
    /* Ïπ¥ÎìúÎ≥Ñ ÏïÑÏù¥ÏΩò Ï∂îÍ∞Ä */
    .meta-card::before {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background-size: contain;
      background-repeat: no-repeat;
      opacity: 0.6;
    }
    
    .meta-card:nth-child(1)::before {
      content: 'üí¨';
      font-size: 20px;
      width: auto;
      height: auto;
    }
    
    .meta-card:nth-child(2)::before {
      content: 'üë§';
      font-size: 16px;
      width: auto;
      height: auto;
    }
    
    .meta-card:nth-child(3)::before {
      content: 'üè∑Ô∏è';
      font-size: 16px;
      width: auto;
      height: auto;
    }
    
    .meta-card:nth-child(4)::before {
      content: 'üìç';
      font-size: 16px;
      width: auto;
      height: auto;
    }
    
    .meta-card:nth-child(5)::before {
      content: '‚≠ê';
      font-size: 16px;
      width: auto;
      height: auto;
    }
    
    .meta-card:nth-child(6)::before {
      content: 'üí¨';
      font-size: 16px;
      width: auto;
      height: auto;
    }
    
    .meta-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.15);
      transform: translateY(-4px) scale(1.02);
    }
    
    .meta-card strong {
      display: block;
     font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      text-align: center;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 16px);
    }
    
    .meta-card .value {
     font-size: 0.9rem;
      line-height: 1.5;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    /* Ïï°ÏÖò Î≤ÑÌäº Í∞úÏÑ† */
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .action-buttons {
      display: flex;
      gap: 20px;
      margin-top: 32px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .btn-enhanced {
      padding: 16px 32px;
      border-radius: 16px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-size: 1.1rem;
      letter-spacing: 0.5px;
    }
    
    .btn-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s ease;
    }
    
    .btn-enhanced:hover::before {
      left: 100%;
    }
    
    .btn-primary-enhanced {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      color: white;
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary-enhanced:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 16px 36px rgba(102, 126, 234, 0.5);
    }
    
    .btn-secondary-enhanced {
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.3);
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    
    .btn-secondary-enhanced:hover {
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.95) 100%);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 28px rgba(0,0,0,0.12);
    }
    
    /* Î≥ÑÏ†ê UI Í∞úÏÑ† */
    .pill{ padding:6px 10px; border:1px solid rgba(0,0,0,.1); border-radius:999px; background:#fff; cursor:pointer; }
    .pill.active{ 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color:#fff; border-color:transparent; 
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    
    .rating-pills {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      justify-content: center;
    }
    
    .rating-pill {
      padding: 12px 20px;
      border-radius: 24px;
      border: 2px solid rgba(255,255,255,0.3);
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .rating-pill:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .rating-pill.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px) scale(1.05);
    }
    
    /* Î¶¨Î∑∞ ÏÑπÏÖò Í∞úÏÑ† */
    .reviews { 
      margin-top: 32px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 28px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
    }
    
    .reviews::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 30%, #f093fb 60%, #f5576c 100%);
      animation: shimmer 4s ease-in-out infinite;
    }
    
    .reviews h3 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 32px 0;
      text-align: center;
      letter-spacing: -0.02em;
      position: relative;
    }
    
    .reviews h3::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #f093fb 100%);
      border-radius: 2px;
    }
    
    .reviews .item{ 
      padding: 32px; 
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: 24px;
      margin-bottom: 24px;
      transition: all 0.3s ease;
      box-shadow: 0 12px 32px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
    }
    
    .reviews .item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 40%, #f093fb 80%, #f5576c 100%);
      opacity: 0.8;
    }
    
    .reviews .item::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(102, 126, 234, 0.03) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .reviews .item:hover {
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.98) 100%);
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 20px 48px rgba(0,0,0,0.12), 0 8px 20px rgba(0,0,0,0.08);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    .reviews .item:hover::after {
      opacity: 1;
    }
    
    .reviews .meta{ 
      color:var(--text-secondary); 
      font-size: 1rem; 
      display:flex; 
      gap: 12px; 
      align-items:center;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(102, 126, 234, 0.1);
      position: relative;
    }
    
    .reviews .meta .author-name {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    .reviews .meta .rating-stars {
      background: linear-gradient(90deg, #ffd700 0%, #ffb347 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.2rem;
      letter-spacing: 2px;
    }
    
    .reviews .content {
      font-size: 1.05rem;
      line-height: 1.7;
      color: var(--text-primary);
      margin: 20px 0;
      position: relative;
      padding-left: 20px;
    }
    
    .reviews .content::before {
      content: '"';
      position: absolute;
      left: 0;
      top: -8px;
      font-size: 3rem;
      color: rgba(102, 126, 234, 0.2);
      font-family: serif;
      line-height: 1;
    }
    
    .reply {
      margin-top: 20px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.05) 100%);
      border-radius: 20px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      margin-left: 40px;
      margin-right: 20px;
      position: relative;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.1);
      backdrop-filter: blur(8px);
    }
    
    /* ÎãµÍ∏Ä ÌôîÏÇ¥Ìëú (ÎßêÌíçÏÑ† Ìö®Í≥º) */
    .reply::before {
      content: '';
      position: absolute;
      top: -12px;
      left: 30px;
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 12px solid rgba(102, 126, 234, 0.2);
    }
    
    .reply::after {
      content: '';
      position: absolute;
      top: -10px;
      left: 31px;
      width: 0;
      height: 0;
      border-left: 11px solid transparent;
      border-right: 11px solid transparent;
      border-bottom: 11px solid rgba(255, 255, 255, 0.95);
    }
    
    .reply .label{ 
      font-weight:700; 
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }
    
    .reply .label::before {
      content: '‚Ü≥';
      font-size: 1.4rem;
      color: #667eea;
      font-weight: 800;
      margin-right: 4px;
    }
    
    .reply .label::after {
      content: 'Î©îÏù¥Ìä∏ ÎãµÎ≥Ä';
      font-size: 0.85rem;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      margin-left: auto;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .reply .content {
      font-size: 1.05rem;
      line-height: 1.6;
      color: var(--text-primary);
      font-style: normal;
      padding-left: 0;
      background: rgba(255, 255, 255, 0.7);
      padding: 16px 20px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
      margin-top: 12px;
      position: relative;
    }
    
    .reply .content::before {
      content: '"';
      position: absolute;
      left: 8px;
      top: -4px;
      font-size: 2rem;
      color: rgba(102, 126, 234, 0.3);
      font-family: serif;
      line-height: 1;
    }
    
    /* Î¶¨Î∑∞ Ìèº Í∞úÏÑ† */
    .review-form-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 28px;
      padding: 40px;
      margin-bottom: 32px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .review-form-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 30%, #f093fb 60%, #f5576c 100%);
      animation: shimmer 3s ease-in-out infinite;
    }
    
    .review-form-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 32px 80px rgba(0,0,0,0.12), 0 12px 32px rgba(0,0,0,0.08);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    .review-form-card h4 {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      margin: 0 0 32px 0;
      letter-spacing: -0.01em;
      position: relative;
    }
    
    .review-form-card h4::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 2px;
      background: linear-gradient(90deg, #667eea 0%, #f093fb 100%);
      border-radius: 1px;
    }
    
    .form-field {
      margin-bottom: 28px;
    }
    
    .form-label {
      display: block;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 16px;
      font-size: 1.1rem;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .form-textarea {
      width: 100%;
      min-height: 160px;
      padding: 24px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      font-family: inherit;
      font-size: 1.1rem;
      line-height: 1.6;
      transition: all 0.3s ease;
      resize: vertical;
      backdrop-filter: blur(8px);
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.5);
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.98) 100%);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), inset 0 2px 12px rgba(0,0,0,0.06);
      transform: translateY(-2px);
    }
    
    .form-textarea::placeholder {
      color: rgba(102, 126, 234, 0.5);
      font-style: italic;
    }
    
    /* Î∞òÏùëÌòï Í∞úÏÑ† */
    @media (max-width: 768px) {
      .wrap { margin: 20px auto; padding: 0 16px; }
      .carousel .track > img { width: 300px; height: 220px; }
      .meta-row { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .action-buttons { flex-direction: column; }
      .btn-enhanced { width: 100%; justify-content: center; }
      .rating-pills { justify-content: center; }
      .card h2 { font-size: 2rem; }
      .profile-header { margin: 16px 0; }
      .meta-card { padding: 16px 12px; }
      .review-form-card { padding: 24px; }
    }
  </style>
</head>
<body class="bg-cream">
  <div id="app-nav"></div>
  <main class="wrap">
    <section class="card profile-header">
      <div class="profile-header-content">
        <div id="ratingBadge" class="rating-badge" style="display: none;">
          <span>‚≠ê</span>
          <span id="ratingValue">N/A</span>
        </div>
        <h2 id="mateName">Î©îÏù¥Ìä∏ ÌîÑÎ°úÌïÑ</h2>

        <!-- Ï†ÑÏ≤¥ ÏÇ¨ÏßÑ Ï∫êÎü¨ÏÖÄ -->
        <div class="carousel">
          <button class="nav prev" aria-label="Ïù¥Ï†Ñ">‚Äπ</button>
          <div class="track" id="photoTrack"></div>
          <button class="nav next" aria-label="Îã§Ïùå">‚Ä∫</button>
        </div>

        <div id="meta" class="meta-grid"></div>

        <div class="action-buttons">
          <a class="btn-enhanced btn-secondary-enhanced" id="backBtn">
            <i class="fas fa-arrow-left"></i>
            Î™©Î°ùÏúºÎ°ú
          </a>
          <a class="btn-enhanced btn-primary-enhanced" id="bookBtn">
            <i class="fas fa-calendar-check"></i>
            ÏòàÏïΩÌïòÍ∏∞
          </a>
        </div>
      </div>
    </section>

    <!-- Î¶¨Î∑∞ ÏòÅÏó≠ -->
    <section class="card reviews">
      <h3 style="margin:0 0 8px">Î¶¨Î∑∞</h3>

      <!-- ÏûëÏÑ± Ìèº (ÌïÑÏöîÌï† ÎïåÎßå Î≥¥Ïó¨Ïßê) -->
      <div id="reviewForm" class="review-form-card" style="display:none">
        <h4 style="margin:0 0 20px; color:var(--text-primary)">Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÍ∏∞</h4>
        <form class="grid">
          <div class="form-field">
            <label class="form-label">Î≥ÑÏ†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</label>
            <div id="ratingWrap" class="rating-pills">
              <button type="button" class="rating-pill" data-rate="5">‚≠ê 5Ï†ê (ÏµúÍ≥†ÏòàÏöî!)</button>
              <button type="button" class="rating-pill" data-rate="4">‚≠ê 4Ï†ê (Ï¢ãÏïÑÏöî)</button>
              <button type="button" class="rating-pill" data-rate="3">‚≠ê 3Ï†ê (Î≥¥ÌÜµ)</button>
              <button type="button" class="rating-pill" data-rate="2">‚≠ê 2Ï†ê (ÏïÑÏâ¨ÏõåÏöî)</button>
              <button type="button" class="rating-pill" data-rate="1">‚≠ê 1Ï†ê (Î≥ÑÎ°úÏòàÏöî)</button>
            <input type="hidden" id="rating" value="">
            </div>
          </div>
          <div class="form-field">
            <label class="form-label" for="reviewText">Î¶¨Î∑∞ ÎÇ¥Ïö©</label>
            <textarea class="form-textarea" id="reviewText" placeholder="Î©îÏù¥Ìä∏ÏôÄ Ìï®ÍªòÌïú Í≤ΩÌóòÏùÑ ÏûêÏÑ∏Ìûà Í≥µÏú†Ìï¥Ï£ºÏÑ∏Ïöî. Îã§Î•∏ Ïù¥Ïö©ÏûêÎì§ÏóêÍ≤å ÎèÑÏõÄÏù¥ ÎêòÎäî ÏÜîÏßÅÌïú ÌõÑÍ∏∞Î•º ÎÇ®Í≤®Ï£ºÏãúÎ©¥ Í∞êÏÇ¨ÌïòÍ≤†ÏäµÎãàÎã§." required></textarea>
          </div>
          <div class="row">
            <button class="btn-enhanced btn-primary-enhanced" type="submit">
              <i class="fas fa-star"></i>
              Î¶¨Î∑∞ Îì±Î°ùÌïòÍ∏∞
            </button>
          <div id="reviewResult"></div>
          </div>
        </form>
        </div>

      <!-- Î¶¨Î∑∞ Î™©Î°ù -->
      <div id="reviewsList" class="stack-16"></div>
    </section>
  </main>

  <script type="module">
    import { supabase } from "./nav.js";

    const params = new URLSearchParams(location.search);
    const mateId = params.get('mate_id');
    if (!mateId) {
      alert('mate_idÍ∞Ä ÏóÜÏäµÎãàÎã§.');
      history.back();
    }

    const backBtn = document.getElementById('backBtn');
    const bookBtn = document.getElementById('bookBtn');
    backBtn.href = './index.html#friends';
    bookBtn.href = `booking.html?mate_id=${encodeURIComponent(mateId)}`;

    function keyToUrl(key) {
      if (!key) return '';
      if (/^https?:\/\//i.test(key)) return key;
      const pure = key.startsWith('mates/') ? key.replace(/^mates\//,'') : key;
      return supabase.storage.from('mates').getPublicUrl(pure).data.publicUrl;
    }

    const track = document.getElementById('photoTrack');
    const mateName = document.getElementById('mateName');
    const meta = document.getElementById('meta');
    
    // Î©îÏù¥Ìä∏ Ïù¥Î¶Ñ Ï†ÄÏû• (Î¶¨Î∑∞ÏóêÏÑú ÏÇ¨Ïö©)
    let currentMateName = 'Î©îÏù¥Ìä∏';

    // Ïù¥Î©îÏùº ÎßàÏä§ÌÇπ Ìï®Ïàò
    function maskEmail(email) {
      if (!email || typeof email !== 'string') return 'ÏùµÎ™Ö';
      
      const atIndex = email.indexOf('@');
      if (atIndex === -1) return email; // @ ÏóÜÏúºÎ©¥ ÏõêÎ≥∏ Î∞òÌôò
      
      const localPart = email.substring(0, atIndex);
      const domain = email.substring(atIndex);
      
      if (localPart.length <= 2) {
        // ÎÑàÎ¨¥ ÏßßÏúºÎ©¥ Ï≤´ Í∏ÄÏûêÎßå Î≥¥Ïù¥Í≤å
        return localPart[0] + '*'.repeat(localPart.length - 1) + domain;
      } else if (localPart.length <= 4) {
        // 4Í∏ÄÏûê Ïù¥ÌïòÎ©¥ Ï≤´Í∏ÄÏûê + ÎßàÏßÄÎßâÍ∏ÄÏûêÎßå
        return localPart[0] + '*'.repeat(localPart.length - 2) + localPart[localPart.length - 1] + domain;
      } else {
        // 5Í∏ÄÏûê Ïù¥ÏÉÅÏù¥Î©¥ Ïïû 2Í∏ÄÏûê + Îí§ 2Í∏ÄÏûê
        const start = localPart.substring(0, 2);
        const end = localPart.substring(localPart.length - 2);
        const middle = '*'.repeat(localPart.length - 4);
        return start + middle + end + domain;
      }
    }

    // ========== ÌîÑÎ°úÌïÑ Î°úÎìú ==========
    const { data: mp, error: mpErr } = await supabase
      .from('mate_profiles')
      .select(`user_id, bio, hourly_rate, tags, areas, rating, photos, primary_photo, is_verified,
               profiles ( full_name, age, gender, languages )`)
      .eq('user_id', mateId)
      .maybeSingle();

    if (mpErr || !mp) {
      track.innerHTML = '<div class="muted" style="padding:8px">ÌîÑÎ°úÌïÑÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.</div>';
    } else {
      mateName.textContent = (mp.profiles?.full_name ?? 'Î©îÏù¥Ìä∏') + ' Îãò';
      currentMateName = mp.profiles?.full_name ?? 'Î©îÏù¥Ìä∏';

      const allKeys = Array.isArray(mp.photos) ? mp.photos : [];
      const keys = mp.primary_photo ? [mp.primary_photo, ...allKeys.filter(k => k !== mp.primary_photo)] : allKeys;
      if (!keys.length) {
        track.innerHTML = '<div class="muted" style="padding:8px">Îì±Î°ùÎêú ÏÇ¨ÏßÑÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
      } else {
        const urls = keys.map(keyToUrl);
        track.innerHTML = urls.map(u => `<img src="${u}" alt="Î©îÏù¥Ìä∏ ÏÇ¨ÏßÑ">`).join('');
      }

      const age = mp.profiles?.age ? `${mp.profiles.age}ÏÑ∏` : '';
      const gender = mp.profiles?.gender || '';
      const langs = Array.isArray(mp.profiles?.languages) ? mp.profiles.languages.join(', ') : '';
      const tags = (mp.tags || []).join(', ');
      const areas = (mp.areas || []).join(', ');
      const rating = mp.rating ?? 'N/A';

      // ÌèâÏ†ê Î∞∞ÏßÄ ÌëúÏãú
      const ratingBadge = document.getElementById('ratingBadge');
      const ratingValue = document.getElementById('ratingValue');
      if (rating !== 'N/A') {
        ratingValue.textContent = rating;
        ratingBadge.style.display = 'flex';
      }

      meta.innerHTML = `
        <div class="meta-row">
          <div class="meta-card">
            <strong>Í∏∞Î≥∏ Ï†ïÎ≥¥</strong>
            <div class="value">${[age, gender].filter(Boolean).join(' ‚Ä¢ ') || 'ÎØ∏Í∏∞Ïû¨'}</div>
          </div>
          <div class="meta-card">
            <strong>Ïñ∏Ïñ¥</strong>
            <div class="value">${langs || 'ÎØ∏Í∏∞Ïû¨'}</div>
          </div>
          <div class="meta-card">
            <strong>ÌÉúÍ∑∏</strong>
            <div class="value">${tags || 'ÏóÜÏùå'}</div>
          </div>
          <div class="meta-card">
            <strong>ÌôúÎèô ÏßÄÏó≠</strong>
            <div class="value">${areas || 'ÎØ∏Í∏∞Ïû¨'}</div>
          </div>
        </div>
        <div class="meta-intro">
          <div class="meta-card">
            <strong>ÏÜåÍ∞ú</strong>
            <div class="value">${mp.bio ?? 'ÏÜåÍ∞úÍ∞Ä ÏïÑÏßÅ ÏóÜÏäµÎãàÎã§.'}</div>
          </div>
        </div>
      `;
    }

    // Ï¢åÏö∞ Î≤ÑÌäº
    document.querySelector('.carousel .prev').addEventListener('click', ()=> track.scrollBy({ left: -320, behavior:'smooth' }));
    document.querySelector('.carousel .next').addEventListener('click', ()=> track.scrollBy({ left:  320, behavior:'smooth' }));

    // ========== Î¶¨Î∑∞ ==========

    const reviewsList = document.getElementById('reviewsList');
    const reviewForm = document.getElementById('reviewForm');
    const ratingWrap = document.getElementById('ratingWrap');
    // Î≥ÑÏ†ê UI
    ratingWrap?.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-rate]');
      if (!b) return;
      const v = Number(b.getAttribute('data-rate'));
      document.getElementById('rating').value = String(v);
      ratingWrap.querySelectorAll('.rating-pill').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    });

    const star = (n)=>'‚òÖ'.repeat(n||0) + '‚òÜ'.repeat(5-(n||0));

    async function loadReviews(){
      const { data: rows, error } = await supabase
        .from('reviews')
        .select('id, content, rating, created_at, author_id, author_name, mate_reply, replied_at')
        .eq('mate_id', mateId)
        .order('created_at', { ascending: false });

      if (error) {
        reviewsList.innerHTML = `<div class="error">${error.message}</div>`;
        return;
      }
      if (!rows?.length) {
        reviewsList.innerHTML = `<div class="muted">ÏïÑÏßÅ Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>`;
        return;
      }

      // ÎÇ¥Í∞Ä Î©îÏù¥Ìä∏Êú¨‰∫∫Ïù∏ÏßÄ
      const { data:{ user } } = await supabase.auth.getUser();
      const isMate = user?.id === mateId;

      reviewsList.innerHTML = rows.map(r => `
        <div class="item card">
          <div class="meta">
            <span class="author-name">${maskEmail(r.author_name || 'ÏùµÎ™Ö')}</span>
            <span>¬∑</span>
            <span>${new Date(r.created_at).toLocaleString('ko-KR')}</span>
            ${r.rating ? `<span>¬∑</span><span class="rating-stars">${star(r.rating)}</span>` : ''}
          </div>
          <div class="content">${(r.content||'').replace(/</g,'<')}</div>
          ${r.mate_reply ? `
            <div class="reply" style="margin-top:8px">
              <div class="label" style="margin-bottom:4px">${currentMateName} ÎãòÏùò ÎãµÎ≥Ä</div>
              <div class="content">${(r.mate_reply||'').replace(/</g,'<')}</div>
            </div>` : ''
          }
          ${isMate ? `
            <div class="reply" style="margin-top:8px">
              <div class="label" style="margin-bottom:4px">ÎãµÎ≥Ä ÏûëÏÑ±/ÏàòÏ†ï</div>
              <textarea class="input" id="reply_${r.id}" placeholder="ÏΩîÎ©òÌä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">${r.mate_reply ?? ''}</textarea>
              <button class="cta-btn" data-reply-save="${r.id}" style="margin-top:6px">ÎãµÎ≥Ä Ï†ÄÏû•</button>
            </div>
          `: ''}
        </div>
      `).join('');

      if (isMate) {
        reviewsList.querySelectorAll('[data-reply-save]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = Number(btn.getAttribute('data-reply-save'));
            const val = document.getElementById(`reply_${id}`).value;
            const { error } = await supabase.from('reviews').update({
              mate_reply: val, replied_at: new Date().toISOString()
            }).eq('id', id);
            if (error) alert('Ï†ÄÏû• Ïã§Ìå®: '+error.message);
            else alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
          });
        });
      }
    }

    // Î¶¨Î∑∞ Ìèº ÌëúÏãú Ï°∞Í±¥: Ïù¥ Î©îÏù¥Ìä∏Ïóê ÎåÄÌï¥ ÎÇ¥Í∞Ä ÏôÑÎ£åÎêú ÏòàÏïΩÏù¥ ÏûàÍ≥†, ÏïÑÏßÅ Î¶¨Î∑∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
    async function prepareReviewForm(){
      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) return; // ÎØ∏Î°úÍ∑∏Ïù∏

      // ÎÇ¥ ÏòàÏïΩ Ï§ë completedÎßå (ÏôÑÎ£åÎêú ÏòàÏïΩÏóêÎßå Î¶¨Î∑∞ ÏûëÏÑ± Í∞ÄÎä•)
      const { data: bks } = await supabase
        .from('bookings')
        .select('id')
        .eq('customer_id', user.id)
        .eq('mate_id', mateId)
        .eq('status', 'completed');

      if (!bks?.length) return;

      // Í∞Å ÏôÑÎ£åÎêú ÏòàÏïΩÏóê ÎåÄÌï¥ Î¶¨Î∑∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
      const bookingIds = bks.map(b => b.id);
      const { data: existingReviews } = await supabase
        .from('reviews')
        .select('booking_id')
        .in('booking_id', bookingIds);

      const reviewedBookings = new Set((existingReviews || []).map(r => r.booking_id));
      
      // Î¶¨Î∑∞Í∞Ä ÏóÜÎäî Ï≤´ Î≤àÏß∏ ÏôÑÎ£åÎêú ÏòàÏïΩÏùÑ Ï∞æÍ∏∞
      const availableBooking = bks.find(booking => !reviewedBookings.has(booking.id));
      
      if (availableBooking) {
        reviewForm.dataset.bookingId = String(availableBooking.id);
        reviewForm.style.display = '';
        
        // Ìèº Ï†úÎ™©Ïóê ÏòàÏïΩ Ï†ïÎ≥¥ ÌëúÏãú
        const formTitle = reviewForm.querySelector('h4');
        if (formTitle) {
          formTitle.textContent = `Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÍ∏∞ (ÏòàÏïΩ #${availableBooking.id})`;
        }
      }
    }

    // Îì±Î°ù
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const reviewResult = document.getElementById('reviewResult');
      const reviewText   = document.getElementById('reviewText');
      reviewResult.textContent = '';

      const txt = reviewText.value.trim();
      const ratingVal = Number(document.getElementById('rating').value || 0);
      if (!txt) return (reviewResult.innerHTML = `<div class="error">ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>`);
      if (!(ratingVal >= 1 && ratingVal <= 5)) {
        return (reviewResult.innerHTML = `<div class="error">Î≥ÑÏ†êÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>`);
      }

      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) {
        const redir = encodeURIComponent(location.pathname + location.search);
        return (location.href = `auth_combo.html?redirect=${redir}`);
      }

      let authorName = user.email || 'ÏùµÎ™Ö';
      const { data: prof } = await supabase.from('profiles').select('full_name').eq('id', user.id).maybeSingle();
      if (prof?.full_name) authorName = prof.full_name;
      // Ïù¥Î©îÏùºÏù∏ Í≤ΩÏö∞ÏóêÎßå ÎßàÏä§ÌÇπ, Ïã§Î™ÖÏù∏ Í≤ΩÏö∞ Í∑∏ÎåÄÎ°ú Ï†ÄÏû•
      // (ÌëúÏãúÌï† Îïå maskEmail Ìï®ÏàòÏóêÏÑú Ï≤òÎ¶¨)

      const bookingId = Number(document.getElementById('reviewForm').dataset.bookingId || '0');
      if (!bookingId) {
        reviewResult.innerHTML = `<div class="error">Î¶¨Î∑∞ Í∞ÄÎä•Ìïú ÏòàÏïΩÏù¥ ÏóÜÏäµÎãàÎã§.</div>`;
        return;
      }

      const { error } = await supabase.from('reviews').insert({
        booking_id: bookingId,
        mate_id: mateId,
        content: txt,
        rating: ratingVal,
        author_name: authorName,
        author_id: user.id
      });

      if (error) {
        if (error.message && error.message.includes('duplicate')) {
          reviewResult.innerHTML = `<div class="error">Ïù¥ÎØ∏ Ïù¥ ÏòàÏïΩÏóê ÎåÄÌïú Î¶¨Î∑∞Î•º ÏûëÏÑ±ÌïòÏÖ®ÏäµÎãàÎã§. Îã§Î•∏ ÏòàÏïΩÏù¥ ÏûàÎã§Î©¥ ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.</div>`;
        } else {
          reviewResult.innerHTML = `<div class="error">Îì±Î°ù Ïã§Ìå®: ${error.message}</div>`;
        }
      } else {
        reviewResult.innerHTML = `<div class="success">Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.</div>`;
        reviewText.value = '';
        document.getElementById('rating').value = '';
        ratingWrap?.querySelectorAll('.rating-pill').forEach(x=>x.classList.remove('active'));
        await loadReviews();
        // Î¶¨Î∑∞ ÏûëÏÑ± ÌõÑ Îã§Î•∏ ÏûëÏÑ± Í∞ÄÎä•Ìïú ÏòàÏïΩÏù¥ ÏûàÎäîÏßÄ Îã§Ïãú ÌôïÏù∏
        await prepareReviewForm();
      }
    });

    // Ï¥àÍ∏∞
    await loadReviews();
    await prepareReviewForm();

    // Î¶¨Î∑∞ Ìèº Ï†úÏ∂ú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    const reviewFormElement = document.querySelector('#reviewForm form');
    if (reviewFormElement) {
      reviewFormElement.addEventListener('submit', async (e) => {
        e.preventDefault();
        const reviewResult = document.getElementById('reviewResult');
        const reviewText = document.getElementById('reviewText');
        reviewResult.textContent = '';

        const txt = reviewText.value.trim();
        const ratingVal = Number(document.getElementById('rating').value || 0);
        if (!txt) return (reviewResult.innerHTML = `<div class="error">ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</div>`);
        if (!(ratingVal >= 1 && ratingVal <= 5)) {
          return (reviewResult.innerHTML = `<div class="error">Î≥ÑÏ†êÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</div>`);
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          const redir = encodeURIComponent(location.pathname + location.search);
          return (location.href = `auth_combo.html?redirect=${redir}`);
        }

        let authorName = user.email || 'ÏùµÎ™Ö';
        const { data: prof } = await supabase.from('profiles').select('full_name').eq('id', user.id).maybeSingle();
        if (prof?.full_name) authorName = prof.full_name;

        const bookingId = Number(document.getElementById('reviewForm').dataset.bookingId || '0');
        if (!bookingId) {
          reviewResult.innerHTML = `<div class="error">Î¶¨Î∑∞ Í∞ÄÎä•Ìïú ÏòàÏïΩÏù¥ ÏóÜÏäµÎãàÎã§.</div>`;
          return;
        }

        const { error } = await supabase.from('reviews').insert({
          booking_id: bookingId,
          mate_id: mateId,
          content: txt,
          rating: ratingVal,
          author_name: authorName,
          author_id: user.id
        });

        if (error) {
          if (error.message && error.message.includes('duplicate')) {
            reviewResult.innerHTML = `<div class="error">Ïù¥ÎØ∏ Ïù¥ ÏòàÏïΩÏóê ÎåÄÌïú Î¶¨Î∑∞Î•º ÏûëÏÑ±ÌïòÏÖ®ÏäµÎãàÎã§. Îã§Î•∏ ÏòàÏïΩÏù¥ ÏûàÎã§Î©¥ ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.</div>`;
          } else {
            reviewResult.innerHTML = `<div class="error">Îì±Î°ù Ïã§Ìå®: ${error.message}</div>`;
          }
        } else {
          reviewResult.innerHTML = `<div class="success">Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.</div>`;
          reviewText.value = '';
          document.getElementById('rating').value = '';
          ratingWrap?.querySelectorAll('.rating-pill').forEach(x => x.classList.remove('active'));
          await loadReviews();
          // Î¶¨Î∑∞ ÏûëÏÑ± ÌõÑ Îã§Î•∏ ÏûëÏÑ± Í∞ÄÎä•Ìïú ÏòàÏïΩÏù¥ ÏûàÎäîÏßÄ Îã§Ïãú ÌôïÏù∏
          await prepareReviewForm();
        }
      });
    }
  </script>
</body>
</html>