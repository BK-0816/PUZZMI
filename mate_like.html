<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUZZMI - 메이트 프로필</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <script type="module" src="nav.js"></script>
  <style>
    body.bg-cream { background: var(--bg-cream); background-repeat:no-repeat; background-size:cover; }
    .wrap{ max-width:980px; margin:40px auto; }
    .grid{ display:grid; gap:16px; }
    .card h2{ margin:0 0 8px; }
    .muted{ color:var(--text-secondary); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:#fff; border:1px solid #eee; }
    /* 캐러셀 */
    .carousel{ position:relative; margin:8px 0 12px; }
    .carousel .track{ display:flex; gap:8px; overflow-x:auto; scroll-snap-type:x mandatory; padding:6px; }
    .carousel .track::-webkit-scrollbar{ height:8px; }
    .carousel .track > img{ flex:0 0 auto; width:320px; height:220px; object-fit:cover; border-radius:12px; scroll-snap-align:start; background:#f5f5f5; }
    .carousel .nav{ position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,.5); color:#fff; border:none; width:36px; height:36px; border-radius:50%; cursor:pointer; }
    .carousel .prev{ left:6px; }
    .carousel .next{ right:6px; }
    /* 리뷰 */
    .reviews{ margin-top:18px; }
    .reviews .item + .item{ margin-top:10px; }
    .reviews .meta{ font-size:.9rem; color:var(--text-secondary); display:flex; gap:8px; flex-wrap:wrap; }
    .reviews .reply{ background:#fff; border:1px solid #eee; border-radius:10px; padding:10px; margin-top:8px; }
    .reviews textarea{ width:100%; min-height:110px; }
  </style>
</head>
<body class="bg-cream">
  <div id="app-nav"></div>

  <main class="wrap">
    <section class="card">
      <h2 id="mateName">메이트 프로필</h2>

      <div class="carousel">
        <button class="nav prev" aria-label="이전">‹</button>
        <div class="track" id="photoTrack"></div>
        <button class="nav next" aria-label="다음">›</button>
      </div>

      <div id="meta" class="grid" style="margin-top:12px"></div>

      <div class="row" style="margin-top:8px">
        <button class="cta-btn" id="backBtn">목록으로</button>
        <button class="cta-btn" id="bookBtn" data-requires-auth="true">예약하기</button>
        <button class="cta-btn" id="favBtn" data-requires-auth="true">찜하기</button>
        <div id="favMsg" class="muted" style="display:none">찜 완료</div>
      </div>
    </section>

    <!-- 리뷰 영역 -->
    <section class="card reviews">
      <h3>리뷰</h3>

      <!-- 고객 전용: 리뷰 작성 가능할 때만 보임 -->
      <form id="reviewForm" class="grid" style="display:none; margin-bottom:12px">
        <div class="field">
          <div class="label">리뷰 내용</div>
          <textarea class="input" id="reviewText" placeholder="이용 후기를 남겨주세요." required></textarea>
        </div>
        <div class="row">
          <button class="btn btn-primary" type="submit">리뷰 등록</button>
          <div id="reviewResult"></div>
        </div>
      </form>

      <!-- 목록 -->
      <div id="reviewsList"></div>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://eevvgbbokenpjnvtmztk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4"
    );

    const params = new URLSearchParams(location.search);
    const mateId = params.get('mate_id');
    if (!mateId) {
      alert('mate_id가 없습니다.');
      history.back();
    }

    // 엘리먼트
    const track      = document.getElementById('photoTrack');
    const mateNameEl = document.getElementById('mateName');
    const meta       = document.getElementById('meta');
    const backBtn    = document.getElementById('backBtn');
    const bookBtn    = document.getElementById('bookBtn');
    const favBtn     = document.getElementById('favBtn');
    const favMsg     = document.getElementById('favMsg');

    const reviewForm   = document.getElementById('reviewForm');
    const reviewText   = document.getElementById('reviewText');
    const reviewResult = document.getElementById('reviewResult');
    const reviewsList  = document.getElementById('reviewsList');

    // 링크 세팅
    backBtn.href = './index.html#friends';
    bookBtn.href = `booking.html?mate_id=${encodeURIComponent(mateId)}`;

    // 스토리지 키 → 공개 URL (mates/ 접두 실수 보정)
    function keyToUrl(key) {
      if (!key) return null;
      if (/^https?:\/\//i.test(key)) return key; // 이미 URL이면 그대로
      const pure = key.startsWith('mates/') ? key.replace(/^mates\//,'') : key;
      return supabase.storage.from('mates').getPublicUrl(pure).data.publicUrl;
    }

    // 로그인 가드
    document.addEventListener('click', async (e) => {
      const guarded = e.target.closest('[data-requires-auth="true"]');
      if (!guarded) return;
      const { data: { user } } = await supabase.auth.getUser();
      if (user) return;
      e.preventDefault();
      const redir = encodeURIComponent(guarded.getAttribute('href') || (location.pathname + location.search));
      location.href = `auth_combo.html?redirect=${redir}`;
    });

    // 찜하기
    favBtn.addEventListener('click', async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        const redir = encodeURIComponent(location.pathname + location.search);
        return (location.href = `auth_combo.html?redirect=${redir}`);
      }
      const { error } = await supabase
        .from('favorites')
        .upsert({ user_id: user.id, mate_id: mateId }, { onConflict: 'user_id,mate_id', ignoreDuplicates: true });
      if (error) return alert('찜하기 실패: ' + error.message);
      favBtn.disabled = true;
      favMsg.style.display = 'inline';
    });

    // 프로필 & 사진 로드 (photos + primary_photo 모두 사용)
    async function loadProfile() {
      const { data: row, error } = await supabase
        .from('mate_profiles')
        .select(`
          user_id, bio, hourly_rate, tags, areas, photos, primary_photo,
          profiles ( full_name, age, gender, languages )
        `)
        .eq('user_id', mateId)
        .maybeSingle();

      if (error || !row) {
        mateNameEl.textContent = '메이트';
        track.innerHTML = '<div class="muted" style="padding:8px">프로필을 불러오지 못했습니다.</div>';
        meta.innerHTML  = '';
        return;
      }

      // 이름
      mateNameEl.textContent = (row.profiles?.full_name ?? '메이트') + ' 님';

      // 사진 캐러셀: primary가 맨 앞, 나머지는 중복 제거 후 뒤에
      const keys = Array.isArray(row.photos) ? [...row.photos] : [];
      const list = [];
      if (row.primary_photo) list.push(row.primary_photo);
      for (const k of keys) if (!list.includes(k)) list.push(k);

      if (!list.length) {
        track.innerHTML = '<div class="muted" style="padding:8px">등록된 사진이 없습니다.</div>';
      } else {
        const urls = list.map(keyToUrl).filter(Boolean);
        track.innerHTML = urls.map(u => `<img src="${u}" alt="메이트 사진">`).join('');
      }

      // 기본 정보
      const age    = row.profiles?.age ? `${row.profiles.age}세` : '';
      const gender = row.profiles?.gender || '';
      const langs  = Array.isArray(row.profiles?.languages) ? row.profiles.languages.join(', ') : '';
      const priceJpy = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 }).format(4000);
      const tags  = (row.tags || []).map(s=>`<span class="pill">${s}</span>`).join(' ');
      const areas = (row.areas || []).map(s=>`<span class="pill">${s}</span>`).join(' ');

      meta.innerHTML = `
        <div><strong>소개</strong><br>${row.bio ?? '소개가 아직 없습니다.'}</div>
        <div><strong>기본 정보</strong><br>${[age, gender].filter(Boolean).join(' • ') || '미기재'}</div>
        <div><strong>언어</strong><br>${langs || '미기재'}</div>
        <div><strong>이용요금</strong><br>${priceJpy} / 시간</div>
        <div><strong>태그</strong><br>${tags || '없음'}</div>
        <div><strong>활동 지역</strong><br>${areas || '미기재'}</div>
      `;
    }

    // 리뷰 목록
    async function loadReviews() {
      const reviewsList = document.getElementById('reviewsList');
      reviewsList.innerHTML = '<div class="muted">불러오는 중…</div>';
      const { data: rows, error } = await supabase
        .from('reviews')
        .select('id, content, created_at, author_name, mate_reply, replied_at')
        .eq('mate_id', mateId)
        .order('created_at', { ascending: false });

      if (error) {
        reviewsList.innerHTML = `<div class="error">리뷰를 불러오지 못했습니다: ${error.message}</div>`;
        return;
      }
      if (!rows || rows.length === 0) {
        reviewsList.innerHTML = '<div class="muted">아직 리뷰가 없습니다.</div>';
        return;
      }

      const { data:{ user } } = await supabase.auth.getUser();
      const isMate = !!user && user.id === mateId;

      reviewsList.innerHTML = rows.map(r => `
        <div class="item card">
          <div class="meta">
            <span>${r.author_name ?? '고객'}</span>
            <span>·</span>
            <span>${new Date(r.created_at).toLocaleString('ko-KR')}</span>
          </div>
          <div style="white-space:pre-wrap; margin-top:6px">${r.content}</div>

          ${r.mate_reply ? `
            <div class="reply">
              <div class="label" style="margin-bottom:4px">메이트 코멘트</div>
              <div style="white-space:pre-wrap">${r.mate_reply}</div>
            </div>
          ` : ''}

          ${isMate ? `
            <div class="reply" style="margin-top:8px">
              <div class="label" style="margin-bottom:4px">코멘트 작성/수정</div>
              <textarea class="input" id="reply_${r.id}" placeholder="코멘트를 입력하세요...">${r.mate_reply ?? ''}</textarea>
              <button class="cta-btn" data-reply-save="${r.id}" style="margin-top:6px">코멘트 저장</button>
            </div>
          `: ''}
        </div>
      `).join('');
    }

    // 리뷰 작성 가능 여부 체크 & 폼 표시
    async function prepareReviewForm() {
      const reviewForm = document.getElementById('reviewForm');
      reviewForm.style.display = 'none';
      reviewForm.dataset.bookingId = '';

      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data: bks } = await supabase
        .from('bookings')
        .select('id')
        .eq('mate_id', mateId)
        .eq('customer_id', user.id)
        .in('status', ['completed','done'])
        .order('id', { ascending: false })
        .limit(5);

      if (!bks || bks.length === 0) return;

      for (const b of bks) {
        const { data: rv } = await supabase
          .from('reviews')
          .select('id')
          .eq('booking_id', b.id)
          .maybeSingle();
        if (!rv) {
          reviewForm.dataset.bookingId = String(b.id);
          reviewForm.style.display = 'grid';
          break;
        }
      }
    }

    // 리뷰 저장
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const reviewResult = document.getElementById('reviewResult');
      const reviewText   = document.getElementById('reviewText');
      reviewResult.textContent = '';
      const txt = reviewText.value.trim();
      if (!txt) return;

      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) {
        const redir = encodeURIComponent(location.pathname + location.search);
        return (location.href = `auth_combo.html?redirect=${redir}`);
      }

      let authorName = user.email?.split('@')[0] || '고객';
      const { data: prof } = await supabase.from('profiles')
        .select('full_name')
        .eq('id', user.id)
        .maybeSingle();
      if (prof?.full_name) authorName = prof.full_name;

      const bookingId = Number(document.getElementById('reviewForm').dataset.bookingId || '0');
      if (!bookingId) {
        reviewResult.innerHTML = `<div class="error">리뷰 가능한 예약이 없습니다.</div>`;
        return;
      }

      const { error } = await supabase.from('reviews').insert({
        booking_id: bookingId,
        mate_id: mateId,
        content: txt,
        author_name: authorName
      });

      if (error) {
        reviewResult.innerHTML = `<div class="error">등록 실패: ${error.message}</div>`;
      } else {
        reviewResult.innerHTML = `<div class="success">등록되었습니다.</div>`;
        reviewText.value = '';
        await loadReviews();
        document.getElementById('reviewForm').style.display = 'none';
      }
    });

    // 메이트 코멘트 저장(이벤트 위임)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-reply-save]');
      if (!btn) return;
      const id = btn.getAttribute('data-reply-save');
      const ta = document.getElementById(`reply_${id}`);
      const txt = (ta?.value ?? '').trim();

      const { data:{ user } } = await supabase.auth.getUser();
      if (!user || user.id !== mateId) return alert('권한이 없습니다.');

      const { error } = await supabase
        .from('reviews')
        .update({ mate_reply: txt, replied_at: new Date().toISOString() })
        .eq('id', id);

      if (error) alert('저장 실패: ' + error.message);
      else {
        const t = document.createElement('div');
        t.textContent = '저장되었습니다.';
        t.style.cssText='position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#222;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999;opacity:.95';
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 1400);
        await loadReviews();
      }
    });

    // 캐러셀 좌우
    const prevBtn = document.querySelector('.carousel .prev');
    const nextBtn = document.querySelector('.carousel .next');
    prevBtn.addEventListener('click', ()=> track.scrollBy({ left: -320, behavior:'smooth' }));
    nextBtn.addEventListener('click', ()=> track.scrollBy({ left:  320, behavior:'smooth' }));

    // 초기 로드
    await loadProfile();
    await loadReviews();
    await prepareReviewForm();
  </script>
</body>
</html>
