<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUZZMI - 메이트 프로필</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <script type="module" src="nav.js"></script>
  <style>
    body.bg-cream { background: var(--bg-cream); background-repeat:no-repeat; background-size:cover; }
    .wrap{ max-width:1200px; margin:40px auto; padding:0 20px; }
    .grid{ display:grid; gap:16px; }
    .card h2{ margin:0 0 12px; font-size:2rem; font-weight:800; color:var(--text-primary); }
    .muted{ color:var(--text-secondary); }
    
    /* 프로필 헤더 개선 */
    .profile-header {
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      border-radius: 24px;
      overflow: hidden;
      position: relative;
    }
    
    .profile-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--brand-gradient, linear-gradient(90deg, #667eea 0%, #764ba2 100%));
    }
    
    /* 캐러셀 개선 */
    .carousel{ position:relative; }
    .carousel .track{ 
      display:flex; gap:12px; overflow-x:auto; scroll-snap-type:x mandatory; 
      padding:12px; border-radius:16px; background:rgba(255,255,255,0.3);
    }
    .carousel .track::-webkit-scrollbar{ height:6px; }
    .carousel .track::-webkit-scrollbar-track{ background:rgba(255,255,255,0.2); border-radius:3px; }
    .carousel .track::-webkit-scrollbar-thumb{ background:var(--primary-color); border-radius:3px; }
    .carousel .track > img{ 
      flex:0 0 auto; width:360px; height:240px; object-fit:cover; 
      border-radius:16px; scroll-snap-align:start; background:#f5f5f5;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .carousel .track > img:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.18);
    }
    .carousel .nav{ 
      position:absolute; top:50%; transform:translateY(-50%); 
      background:rgba(255,255,255,0.9); color:var(--text-primary); 
      border:1px solid rgba(0,0,0,0.1); width:44px; height:44px; 
      border-radius:50%; cursor:pointer; font-size:18px; font-weight:bold;
      backdrop-filter: blur(10px); transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center;
    }
    .carousel .nav:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-50%) scale(1.1);
    }
    .carousel .prev{ left:6px; }
    .carousel .next{ right:6px; }
    
    /* 메타 정보 그리드 개선 */
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    
    .meta-card {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .meta-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--brand-gradient, linear-gradient(90deg, #667eea 0%, #764ba2 100%));
    }
    
    .meta-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.85);
    }
    
    .meta-card strong {
      display: block;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .meta-card .value {
      font-size: 1.1rem;
      line-height: 1.5;
      color: var(--text-primary);
    }
    
    /* 액션 버튼 개선 */
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .action-buttons {
      display: flex;
      gap: 16px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    .btn-enhanced {
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .btn-enhanced:hover::before {
      left: 100%;
    }
    
    .btn-primary-enhanced {
      background: var(--brand-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
      color: white;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary-enhanced {
      background: rgba(255,255,255,0.9);
      color: var(--text-primary);
      border: 1px solid rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .btn-secondary-enhanced:hover {
      background: rgba(255,255,255,1);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    /* 별점 UI 개선 */
    .pill{ padding:6px 10px; border:1px solid rgba(0,0,0,.1); border-radius:999px; background:#fff; cursor:pointer; }
    .pill.active{ 
      background: var(--brand-gradient, var(--primary-color)); 
      color:#fff; border-color:transparent; 
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .rating-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    
    .rating-pill {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid rgba(0,0,0,0.1);
      background: rgba(255,255,255,0.8);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .rating-pill:hover {
      border-color: var(--primary-color);
      background: rgba(255,255,255,1);
    }
    
    .rating-pill.active {
      background: var(--brand-gradient, var(--primary-color));
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    /* 리뷰 섹션 개선 */
    .reviews{ margin-top:18px }
    .reviews .item{ 
      padding: 24px; 
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 16px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    .reviews .item:hover {
      background: rgba(255,255,255,0.95);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .reviews .meta{ color:var(--text-secondary); font-size:.9rem; display:flex; gap:6px; align-items:center }
    .reply .label{ 
      font-weight:700; 
      color:var(--primary-color);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* 리뷰 폼 개선 */
    .review-form-card {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.08);
    }
    
    .form-field {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    
    .form-textarea {
      width: 100%;
      min-height: 120px;
      padding: 16px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.9);
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.5;
      transition: all 0.3s ease;
      resize: vertical;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* 반응형 개선 */
    @media (max-width: 768px) {
      .wrap { margin: 20px auto; padding: 0 16px; }
      .carousel .track > img { width: 280px; height: 200px; }
      .meta-grid { grid-template-columns: 1fr; gap: 16px; }
      .action-buttons { flex-direction: column; }
      .btn-enhanced { width: 100%; justify-content: center; }
      .rating-pills { justify-content: center; }
    }
  </style>
</head>
<body class="bg-cream">
  <div id="app-nav"></div>
  <main class="wrap">
    <section class="card profile-header">
      <h2 id="mateName">메이트 프로필</h2>

      <!-- 전체 사진 캐러셀 -->
      <div class="carousel">
        <button class="nav prev" aria-label="이전">‹</button>
        <div class="track" id="photoTrack"></div>
        <button class="nav next" aria-label="다음">›</button>
      </div>

      <div id="meta" class="meta-grid"></div>

      <div class="action-buttons">
        <a class="btn-enhanced btn-secondary-enhanced" id="backBtn">
          <i class="fas fa-arrow-left"></i>
          목록으로
        </a>
        <a class="btn-enhanced btn-primary-enhanced" id="bookBtn">
          <i class="fas fa-calendar-check"></i>
          예약하기
        </a>
      </div>
    </section>

    <!-- 리뷰 영역 -->
    <section class="card reviews">
      <h3 style="margin:0 0 8px">리뷰</h3>

      <!-- 작성 폼 (필요할 때만 보여짐) -->
      <div id="reviewForm" class="review-form-card" style="display:none">
        <h4 style="margin:0 0 20px; color:var(--text-primary)">리뷰 작성하기</h4>
        <form class="grid">
          <div class="form-field">
            <label class="form-label">별점을 선택해주세요</label>
            <div id="ratingWrap" class="rating-pills">
              <button type="button" class="rating-pill" data-rate="5">⭐ 5점 (최고예요!)</button>
              <button type="button" class="rating-pill" data-rate="4">⭐ 4점 (좋아요)</button>
              <button type="button" class="rating-pill" data-rate="3">⭐ 3점 (보통)</button>
              <button type="button" class="rating-pill" data-rate="2">⭐ 2점 (아쉬워요)</button>
              <button type="button" class="rating-pill" data-rate="1">⭐ 1점 (별로예요)</button>
            <input type="hidden" id="rating" value="">
            </div>
          </div>
          <div class="form-field">
            <label class="form-label" for="reviewText">리뷰 내용</label>
            <textarea class="form-textarea" id="reviewText" placeholder="메이트와 함께한 경험을 자세히 공유해주세요. 다른 이용자들에게 도움이 되는 솔직한 후기를 남겨주시면 감사하겠습니다." required></textarea>
          </div>
          <div class="row">
            <button class="btn-enhanced btn-primary-enhanced" type="submit">
              <i class="fas fa-star"></i>
              리뷰 등록하기
            </button>
          <div id="reviewResult"></div>
          </div>
        </form>
        </div>

      <!-- 리뷰 목록 -->
      <div id="reviewsList" class="stack-16"></div>
    </section>
  </main>

  <script type="module">
    import { supabase } from "./nav.js";

    const params = new URLSearchParams(location.search);
    const mateId = params.get('mate_id');
    if (!mateId) {
      alert('mate_id가 없습니다.');
      history.back();
    }

    const backBtn = document.getElementById('backBtn');
    const bookBtn = document.getElementById('bookBtn');
    backBtn.href = './index.html#friends';
    bookBtn.href = `booking.html?mate_id=${encodeURIComponent(mateId)}`;

    function keyToUrl(key) {
      if (!key) return '';
      if (/^https?:\/\//i.test(key)) return key;
      const pure = key.startsWith('mates/') ? key.replace(/^mates\//,'') : key;
      return supabase.storage.from('mates').getPublicUrl(pure).data.publicUrl;
    }

    const track = document.getElementById('photoTrack');
    const mateName = document.getElementById('mateName');
    const meta = document.getElementById('meta');

    // ========== 프로필 로드 ==========
    const { data: mp, error: mpErr } = await supabase
      .from('mate_profiles')
      .select(`user_id, bio, hourly_rate, tags, areas, rating, photos, primary_photo, is_verified,
               profiles ( full_name, age, gender, languages )`)
      .eq('user_id', mateId)
      .maybeSingle();

    if (mpErr || !mp) {
      track.innerHTML = '<div class="muted" style="padding:8px">프로필을 불러오지 못했습니다.</div>';
    } else {
      mateName.textContent = (mp.profiles?.full_name ?? '메이트') + ' 님';

      const allKeys = Array.isArray(mp.photos) ? mp.photos : [];
      const keys = mp.primary_photo ? [mp.primary_photo, ...allKeys.filter(k => k !== mp.primary_photo)] : allKeys;
      if (!keys.length) {
        track.innerHTML = '<div class="muted" style="padding:8px">등록된 사진이 없습니다.</div>';
      } else {
        const urls = keys.map(keyToUrl);
        track.innerHTML = urls.map(u => `<img src="${u}" alt="메이트 사진">`).join('');
      }

      const age = mp.profiles?.age ? `${mp.profiles.age}세` : '';
      const gender = mp.profiles?.gender || '';
      const langs = Array.isArray(mp.profiles?.languages) ? mp.profiles.languages.join(', ') : '';
      const price = mp.hourly_rate ? new Intl.NumberFormat('ko-KR').format(mp.hourly_rate) : '협의';
      const tags = (mp.tags || []).join(', ');
      const areas = (mp.areas || []).join(', ');
      const rating = mp.rating ?? 'N/A';

      meta.innerHTML = `
        <div class="meta-card">
          <strong>소개</strong>
          <div class="value">${mp.bio ?? '소개가 아직 없습니다.'}</div>
        </div>
        <div class="meta-card">
          <strong>기본 정보</strong>
          <div class="value">${[age, gender].filter(Boolean).join(' • ') || '미기재'}</div>
        </div>
        <div class="meta-card">
          <strong>언어</strong>
          <div class="value">${langs || '미기재'}</div>
        </div>
        <div class="meta-card">
          <strong>시급</strong>
          <div class="value">₩ ${price} / 시간</div>
        </div>
        <div class="meta-card">
          <strong>태그</strong>
          <div class="value">${tags || '없음'}</div>
        </div>
        <div class="meta-card">
          <strong>활동 지역</strong>
          <div class="value">${areas || '미기재'}</div>
        </div>
        <div class="meta-card">
          <strong>평점</strong>
          <div class="value">⭐ ${rating}</div>
        </div>
      `;
    }

    // 좌우 버튼
    document.querySelector('.carousel .prev').addEventListener('click', ()=> track.scrollBy({ left: -320, behavior:'smooth' }));
    document.querySelector('.carousel .next').addEventListener('click', ()=> track.scrollBy({ left:  320, behavior:'smooth' }));

    // ========== 리뷰 ==========

    const reviewsList = document.getElementById('reviewsList');
    const reviewForm = document.getElementById('reviewForm');
    const ratingWrap = document.getElementById('ratingWrap');

    // 별점 UI
    ratingWrap?.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-rate]');
      if (!b) return;
      const v = Number(b.getAttribute('data-rate'));
      document.getElementById('rating').value = String(v);
      ratingWrap.querySelectorAll('.rating-pill').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    });

    const star = (n)=>'★'.repeat(n||0) + '☆'.repeat(5-(n||0));

    async function loadReviews(){
      const { data: rows, error } = await supabase
        .from('reviews')
        .select('id, content, rating, created_at, author_id, author_name, mate_reply, replied_at')
        .eq('mate_id', mateId)
        .order('created_at', { ascending: false });

      if (error) {
        reviewsList.innerHTML = `<div class="error">${error.message}</div>`;
        return;
      }
      if (!rows?.length) {
        reviewsList.innerHTML = `<div class="muted">아직 리뷰가 없습니다.</div>`;
        return;
      }

      // 내가 메이트本人인지
      const { data:{ user } } = await supabase.auth.getUser();
      const isMate = user?.id === mateId;

      reviewsList.innerHTML = rows.map(r => `
        <div class="item card">
          <div class="meta">
            <span>${r.author_name ?? '고객'}</span>
            <span>·</span>
            <span>${new Date(r.created_at).toLocaleString('ko-KR')}</span>
            ${r.rating ? `<span>·</span><span>${star(r.rating)}</span>` : ''}
          </div>
          <div style="white-space:pre-wrap; margin-top:6px">${(r.content||'').replace(/</g,'&lt;')}</div>
          ${r.mate_reply ? `
            <div class="reply" style="margin-top:8px">
              <div class="label" style="margin-bottom:4px">메이트 코멘트</div>
              <div style="white-space:pre-wrap">${(r.mate_reply||'').replace(/</g,'&lt;')}</div>
            </div>` : ''
          }
          ${isMate ? `
            <div class="reply" style="margin-top:8px">
              <div class="label" style="margin-bottom:4px">코멘트 작성/수정</div>
              <textarea class="input" id="reply_${r.id}" placeholder="코멘트를 입력하세요...">${r.mate_reply ?? ''}</textarea>
              <button class="cta-btn" data-reply-save="${r.id}" style="margin-top:6px">코멘트 저장</button>
            </div>
          `: ''}
        </div>
      `).join('');

      if (isMate) {
        reviewsList.querySelectorAll('[data-reply-save]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = Number(btn.getAttribute('data-reply-save'));
            const val = document.getElementById(`reply_${id}`).value;
            const { error } = await supabase.from('reviews').update({
              mate_reply: val, replied_at: new Date().toISOString()
            }).eq('id', id);
            if (error) alert('저장 실패: '+error.message);
            else alert('저장되었습니다.');
          });
        });
      }
    }

    // 리뷰 폼 표시 조건: 이 메이트에 대해 내가 완료된 예약이 있고, 아직 리뷰가 없는 경우
    async function prepareReviewForm(){
      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) return; // 미로그인

      // 내 예약 중 completed
      const { data: bks } = await supabase
        .from('bookings')
        .select('id')
        .eq('customer_id', user.id)
        .eq('mate_id', mateId)
        .eq('status', 'completed');

      if (!bks?.length) return;

      const ids = bks.map(b=>b.id);
      const { data: rv } = await supabase
        .from('reviews')
        .select('booking_id')
        .in('booking_id', ids);

      const reviewed = new Set((rv||[]).map(r=>r.booking_id));
      const target = ids.find(id => !reviewed.has(id));
      if (target) {
        reviewForm.dataset.bookingId = String(target);
        reviewForm.style.display = '';
      }
    }

    // 등록
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const reviewResult = document.getElementById('reviewResult');
      const reviewText   = document.getElementById('reviewText');
      reviewResult.textContent = '';

      const txt = reviewText.value.trim();
      const ratingVal = Number(document.getElementById('rating').value || 0);
      if (!txt) return (reviewResult.innerHTML = `<div class="error">내용을 입력하세요.</div>`);
      if (!(ratingVal >= 1 && ratingVal <= 5)) {
        return (reviewResult.innerHTML = `<div class="error">별점을 선택하세요.</div>`);
      }

      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) {
        const redir = encodeURIComponent(location.pathname + location.search);
        return (location.href = `auth_combo.html?redirect=${redir}`);
      }

      let authorName = user.email?.split('@')[0] || '고객';
      const { data: prof } = await supabase.from('profiles').select('full_name').eq('id', user.id).maybeSingle();
      if (prof?.full_name) authorName = prof.full_name;

      const bookingId = Number(document.getElementById('reviewForm').dataset.bookingId || '0');
      if (!bookingId) {
        reviewResult.innerHTML = `<div class="error">리뷰 가능한 예약이 없습니다.</div>`;
        return;
      }

      const { error } = await supabase.from('reviews').insert({
        booking_id: bookingId,
        mate_id: mateId,
        content: txt,
        rating: ratingVal,
        author_name: authorName,
        author_id: user.id
      });

      if (error) {
        reviewResult.innerHTML = `<div class="error">등록 실패: ${error.message}</div>`;
      } else {
        reviewResult.innerHTML = `<div class="success">등록되었습니다.</div>`;
        reviewText.value = '';
        document.getElementById('rating').value = '';
        ratingWrap?.querySelectorAll('.rating-pill').forEach(x=>x.classList.remove('active'));
        await loadReviews();
        document.getElementById('reviewForm').style.display = 'none';
      }
    });

    // 초기
    await loadReviews();
    await prepareReviewForm();
  </script>
</body>
</html>
