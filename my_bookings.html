<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç§ã®äºˆç´„ãƒªã‚¹ãƒˆ - PUZZMI</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <script type="module" src="nav.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body.bg-cream { background: var(--bg-cream); background-repeat:no-repeat; background-size:cover; }
    
    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .page { 
      max-width: 1000px; 
      margin: 40px auto; 
      padding: 0 20px; 
    }
    
    /* í˜ì´ì§€ í—¤ë” */
    .page-header {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 30%, #f093fb 60%, #f5576c 100%);
      animation: shimmer 3s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .page-header h2 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 12px 0;
      letter-spacing: -0.02em;
      text-align: center;
    }
    
    .page-subtitle {
      text-align: center;
      color: var(--text-secondary);
      font-size: 1.1rem;
      line-height: 1.6;
      margin: 0;
    }
    
    /* ì˜ˆì•½ ì¹´ë“œ */
    .booking-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .booking-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 40%, #f093fb 80%, #f5576c 100%);
      opacity: 0.8;
    }
    
    .booking-card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 20px 48px rgba(0,0,0,0.12), 0 8px 20px rgba(0,0,0,0.08);
      border-color: rgba(102, 126, 234, 0.3);
    }
    
    /* ì˜ˆì•½ í—¤ë” */
    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .booking-info h3 {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 12px 0;
      letter-spacing: -0.01em;
    }
    
    .booking-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 500;
    }
    
    .meta-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    
    /* ìƒíƒœ ë°°ì§€ */
    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    
    .status-pending {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border-color: rgba(255, 193, 7, 0.3);
    }
    
    .status-confirmed {
      background: linear-gradient(135deg, #d1e7dd 0%, #a3e4d7 100%);
      color: #0f5132;
      border-color: rgba(25, 135, 84, 0.3);
    }
    
    .status-completed {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .status-cancelled {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
    }
    
    /* ì•¡ì…˜ ë²„íŠ¼ */
    .booking-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn-review {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
      letter-spacing: 0.3px;
    }
    
    .btn-review:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    /* ë¦¬ë·° í¼ */
    .review-form {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.03) 100%);
      border: 2px dashed rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      padding: 32px;
      margin-top: 24px;
      transition: all 0.3s ease;
    }
    
    .review-form.show {
      border-style: solid;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.05) 100%);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.1);
    }
    
    .review-form h4 {
      font-size: 1.3rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 24px 0;
      text-align: center;
    }
    
    /* ë³„ì  ì„ íƒ */
    .rating-section {
      margin-bottom: 24px;
    }
    
    .rating-label {
      display: block;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .rating-pills {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .rating-pill {
      padding: 12px 20px;
      border-radius: 24px;
      border: 2px solid rgba(255,255,255,0.3);
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .rating-pill:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .rating-pill.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transform: translateY(-2px) scale(1.05);
    }
    
    /* í…ìŠ¤íŠ¸ ì˜ì—­ */
    .review-textarea {
      width: 100%;
      min-height: 120px;
      padding: 20px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.92) 100%);
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.6;
      transition: all 0.3s ease;
      resize: vertical;
      backdrop-filter: blur(8px);
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .review-textarea:focus {
      outline: none;
      border-color: rgba(102, 126, 234, 0.5);
      background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.98) 100%);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), inset 0 2px 12px rgba(0,0,0,0.06);
      transform: translateY(-2px);
    }
    
    .review-textarea::placeholder {
      color: rgba(102, 126, 234, 0.5);
      font-style: italic;
    }
    
    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 40px;
      background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
      backdrop-filter: blur(15px);
      border: 2px dashed rgba(102, 126, 234, 0.2);
      border-radius: 20px;
      color: var(--text-secondary);
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }
    
    .empty-text {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .empty-subtext {
      font-size: 1rem;
      opacity: 0.8;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .page { padding: 0 16px; margin: 20px auto; }
      .page-header { padding: 24px; }
      .page-header h2 { font-size: 2rem; }
      .booking-card { padding: 24px; }
      .booking-header { flex-direction: column; gap: 16px; }
      .rating-pills { justify-content: flex-start; }
      .booking-actions { justify-content: center; }
    }
  </style>
</head>
<body class="bg-cream">
  <div id="app-nav"></div>
  <main class="page">
    <section class="page-header">
      <h2>ç§ã®äºˆç´„ãƒªã‚¹ãƒˆ</h2>
      <p class="page-subtitle">äºˆç´„ãƒªã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼</p>
    </section>
    <section>
      <div id="list" class="stack-16"></div>
    </section>
  </main>

  <script type="module">
    import { supabase } from './nav.js';

    const list = document.getElementById('list');

    function rowHtml(bk){
      const canReview = bk.status === 'completed' && !bk.has_review;
      const dt = `${bk.date} ${bk.start_time} (${bk.duration_hours}h)`;
      const statusClass = `status-${bk.status}`;
      const statusText = bk.status === 'pending' ? 'â³ å¾…æ©Ÿä¸­' :
                        bk.status === 'confirmed' ? 'âœ… äºˆç´„ç¢ºå®š' :
                        bk.status === 'completed' ? 'ğŸ‰ é€²è¡Œå®Œäº†' :
                        (bk.status === 'cancelled' || bk.status === 'canceled_by_mate') ? 'âŒ äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«' : bk.status;
      
      return `
        <div class="booking-card" data-id="${bk.id}">
          <div class="booking-header">
            <div class="booking-info">
              <h3>${dt}</h3>
              <div class="booking-meta">
                <div class="meta-item">
                  <div class="meta-icon">ğŸ‘¤</div>
                  <span>ãƒ¡ã‚¤ãƒˆ: ${bk.mate_name ?? bk.mate_id}</span>
                </div>
                ${bk.notes ? `
                <div class="meta-item">
                  <div class="meta-icon">ğŸ“</div>
                  <span>${(bk.notes||'').replace(/</g,'<')}</span>
                </div>
                ` : ''}
              </div>
            </div>
            <div class="booking-status">
              <div class="status-badge ${statusClass}">${statusText}</div>
            </div>
          </div>
          ${bk.payment_status === 'pending' && (bk.status === 'confirmed' || bk.status === 'pending') ? `
            <div class="booking-actions">
              <button class="btn-payment" onclick="goToPayment(${bk.id}, ${bk.total_amount || 0})" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; width: 100%; transition: all 0.3s ease;">
                ğŸ’³ æ±ºæ¸ˆã™ã‚‹ (Â¥${bk.total_amount || 0})
              </button>
            </div>
          ` : ''}
          ${canReview ? `
            <div class="booking-actions">
              <button class="btn-review" data-act="review">âœ¨ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã™ã‚‹</button>
            </div>
          ` : ''}
          <div class="review-form hidden" data-review="${bk.id}">
            <h4>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã™ã‚‹</h4>
            <div class="rating-section">
              <label class="rating-label">æ˜Ÿã‚’é¸æŠã—ã¦ãã ã•ã„</label>
              <div class="rating-pills">
                <button class="rating-pill" data-rate="5">â­ 5ç‚¹ æœ€é«˜ã§ã™ï¼</button>
                <button class="rating-pill" data-rate="4">â­ 4ç‚¹ ã„ã„ã§ã™ã­</button>
                <button class="rating-pill" data-rate="3">â­ 3ç‚¹ æ™®é€š</button>
                <button class="rating-pill" data-rate="2">â­ 2ç‚¹ æ®‹å¿µã§ã™</button>
                <button class="rating-pill" data-rate="1">â­ 1ç‚¹ ã‚¤ãƒã‚¤ãƒã§ã™</button>
                <input type="hidden" data-rating value="">
              </div>
            </div>
            <textarea class="review-textarea" data-text placeholder="ãƒ¡ã‚¤ãƒˆã¨ä¸€ç·’ã«ã—ãŸçµŒé¨“ã‚’è©³ã—ãå…±æœ‰ã—ã¦ãã ã•ã„ã€‚ ã©ã‚“ãªã¨ã“ã‚ã«è¡Œãã¾ã—ãŸã‹ï¼Ÿ ã©ã‚“ãªä¼šè©±ã‚’äº¤ã‚ã—ã¾ã—ãŸã‹ï¼Ÿ ä»–ã®åˆ©ç”¨è€…ã«å½¹ç«‹ã¤ç‡ç›´ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ®‹ã—ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚"></textarea>
            <div class="booking-actions" style="margin-top: 20px;">
              <button class="btn-review" data-save="${bk.id}">ğŸŒŸ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹</button>
            </div>
            <div class="muted" data-result></div>
          </div>
        </div>`;
    }

    async function load(){
      const { data:{ user } } = await supabase.auth.getUser();
      if(!user){ list.innerHTML='<div class="note">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</div>'; return; }

      // ë‚´ ì˜ˆì•½
      const { data, error } = await supabase
        .from('bookings')
        .select('id, mate_id, customer_id, date, start_time, duration_hours, status, notes, payment_status, total_amount, currency')
        .eq('customer_id', user.id)
        .order('created_at', { ascending:false });

      if (error){ list.innerHTML = `<div class="error">${error.message}</div>`; return; }
      if (!data?.length){ 
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“…</div>
            <div class="empty-text">ã¾ã äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <div class="empty-subtext">ãƒ¡ã‚¤ãƒˆã¨ä¸€ç·’ã«ç‰¹åˆ¥ãªçµŒé¨“ã‚’å§‹ã‚ã¦ã¿ã¦ãã ã•ã„ï¼</div>
          </div>
        `; 
        return; 
      }

      // ë©”ì´íŠ¸ ì´ë¦„ join
      const mateIds = [...new Set(data.map(d=>d.mate_id))];
      const { data: mates } = await supabase
        .from('mate_profiles')
        .select('user_id, profiles(full_name)')
        .in('user_id', mateIds);

      const mapMate = new Map((mates||[]).map(m=>[m.user_id, m.profiles?.full_name || null]));
      data.forEach(d => d.mate_name = mapMate.get(d.mate_id) || null);

      // ë¦¬ë·° ì¡´ì¬ ì—¬ë¶€
      const ids = data.map(d=>d.id);
      const { data: rv } = await supabase
        .from('reviews')
        .select('booking_id')
        .in('booking_id', ids);

      const setReviewed = new Set((rv||[]).map(r=>r.booking_id));
      data.forEach(d => d.has_review = setReviewed.has(d.id));

      list.innerHTML = data.map(rowHtml).join('');
    }

    // ë²„íŠ¼ ë™ì‘
    list.addEventListener('click', async (e)=>{
      // ë¦¬ë·° í¼ ì—´ê¸°
      const btn = e.target.closest('[data-act="review"]');
      if (btn) {
        const card = btn.closest('[data-id]');
        const form = card.querySelector(`[data-review="${card.dataset.id}"]`);
        form.classList.remove('hidden');
        form.classList.add('show');
        return;
      }

      // ë³„ì  ì„ íƒ
      const rateBtn = e.target.closest('[data-rate]');
      if (rateBtn) {
        const wrap = rateBtn.closest('[data-review]');
        wrap.querySelectorAll('.rating-pill').forEach(x=>x.classList.remove('active'));
        rateBtn.classList.add('active');
        wrap.querySelector('[data-rating]').value = rateBtn.getAttribute('data-rate');
        return;
      }

      // ë¦¬ë·° ì €ì¥
      const save = e.target.closest('[data-save]');
      if (save) {
        const id = Number(save.getAttribute('data-save'));
        const block = list.querySelector(`[data-review="${id}"]`);
        const rating = Number(block.querySelector('[data-rating]').value||0);
        const text = block.querySelector('[data-text]').value.trim();
        const result = block.querySelector('[data-result]');
        if (!(rating>=1 && rating<=5)) return result.textContent = 'æ˜Ÿã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        if (!text) return result.textContent = 'å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';

        // mate_id
        const { data: one, error: oneErr } = await supabase.from('bookings').select('mate_id').eq('id', id).maybeSingle();
        if (oneErr || !one) { result.textContent = 'ç…§ä¼šå¤±æ•—'; return; }

        const { data:{ user } } = await supabase.auth.getUser();
        const { error } = await supabase.from('reviews').insert({
          booking_id: id,
          mate_id: one.mate_id,
          rating,
          content: text,
          author_id: user?.id || null
        });

        if (error) {
          if (error.message && error.message.includes('duplicate')) {
            result.textContent = 'ã™ã§ã«ã“ã®äºˆç´„ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚';
          } else {
            result.textContent = 'ç™»éŒ²å¤±æ•—: ' + error.message;
          }
        } else {
          result.textContent = 'ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚';
        }
        if (!error) load();
      }
    });

    load();

    // í¬íŠ¸ì› ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
    window.goToPayment = function(bookingId, amount) {
      window.location.href = `payment_page.html?booking_id=${bookingId}&amount=${amount}`;
    };
  </script>
</body>
</html>