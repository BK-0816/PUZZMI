<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>메이트 대시보드 - PUZZMI</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="pages.css"/>
  <link rel="stylesheet" href="nav.css"/>
  <link rel="stylesheet" href="pages-theme.css"/>
  <script type="module" src="nav.js"></script>
  <style>
    .status-badge{padding:2px 8px;border-radius:999px;background:#eee;font-size:.85rem}
    .status-pending{background:#fff3cd}
    .status-confirmed{background:#d1e7dd}
    .status-declined{background:#f8d7da}
  </style>
</head>
<body class="bg-cream">
  <div id="app-nav"></div>
  <main class="page stack-16">
    <section class="card">
      <h2>예약 신청 알림</h2>
      <div id="list" class="stack-16"></div>
    </section>
  </main>

<script type="module">
import { supabase } from './nav.js';

const s = (v, fb = '') => (typeof v === 'string' ? v : (v == null ? fb : String(v)));


function rowHtml(r){
  const dt = `${r.date} ${r.start_time} (${r.duration_hours}h)`;
  const canAct = (r.status === 'pending');
  return `
    <div class="card" data-id="${r.id}">
      <div class="flex justify-between align-center">
        <div>
          <div style="font-weight:800">${dt}</div>
          <div class="muted">${r.customer_name} • ${r.customer_contact} • 상태: ${r.status}</div>
          <div class="muted">요청: ${(r.notes||'').replace(/</g,'&lt;')}</div>
        </div>
        <div class="flex gap-8">
          ${canAct ? `<button class="btn btn-secondary" data-act="confirm">확정</button>` : ''}
          ${canAct ? `<button class="btn btn-secondary" data-act="decline">거절</button>` : ''}
          <!-- 확정 후에도 취소 가능 -->
          ${r.status === 'confirmed' ? `<button class="btn btn-secondary" data-act="cancel">취소</button>` : ''}
        </div>
      </div>
    </div>`;
}

async function load(){
  const { data:{ user } } = await supabase.auth.getUser();
  const list = document.getElementById('list');
  if(!user){ list.innerHTML='<div class="note">로그인 필요</div>'; return; }

  const { data, error } = await supabase
    .from('bookings')
    .select('*')
    .eq('mate_id', user.id)
    .order('created_at', { ascending:false });

  if(error){ console.error(error); list.innerHTML='<div class="error">'+error.message+'</div>'; return; }
  if(!data?.length){ list.innerHTML='<div class="muted">예약 신청이 없습니다.</div>'; return; }

  list.innerHTML = data.map(rowHtml).join('');

  // 버튼 핸들러 (이벤트 위임)
  list.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.onclick = async () => {
      const card = btn.closest('[data-id]');
      const id   = Number(card.dataset.id);
      const act  = btn.dataset.act;

      // 1) 현재 예약 정보 조회 (고객 user_id 필요)
      const { data: rows, error: readErr } = await supabase
        .from('bookings')
        .select('id, mate_id, customer_id, customer_name, date, start_time, duration_hours, status')
        .eq('id', id).limit(1);
      if (readErr || !rows?.length) { return alert('조회 실패: '+(readErr?.message||'not found')); }
      const bk = rows[0];

      // 2) 상태/사유 입력 및 업데이트
      let newStatus = bk.status;
      let reason = '';

      if (act === 'confirm') {
        newStatus = 'confirmed';
      } else if (act === 'decline') {
        newStatus = 'declined';
        reason = prompt('거절 사유를 입력하세요 (고객에게 전달됩니다):') || '';
      } else if (act === 'cancel') {
        newStatus = 'canceled_by_mate';
        reason = prompt('취소 사유를 입력하세요 (고객에게 전달됩니다):') || '';
      }

      const patch = { status: newStatus };
      if (act === 'decline') patch.decline_reason = reason;
      if (act === 'cancel')  patch.cancel_reason  = reason;

      const { error: updErr } = await supabase.from('bookings').update(patch).eq('id', id);
      if (updErr) return alert('업데이트 실패: ' + updErr.message);

      // 3) 알림 생성 (수신자=고객, 발신자=메이트)
      const title = act === 'confirm'
        ? '예약이 확정되었습니다'
        : act === 'decline'
          ? '예약이 거절되었습니다'
          : '예약이 취소되었습니다';
      const when = `${bk.date} ${bk.start_time} (${bk.duration_hours}h)`;
      const body = act === 'confirm'
        ? `메이트가 예약을 확정했습니다.\n일정: ${when}`
        : `사유: ${reason || '사유 미기재'}\n일정: ${when}`;

      const link = `booking.html?booking_id=${bk.id}`;
      await createNotification({
        user_id: bk.customer_id,     // 고객에게
        title, body,
        type: act === 'confirm' ? 'booking_confirmed'
            : act === 'decline'  ? 'booking_declined'
            : 'booking_canceled',
        link
      });

      // 4) 화면 갱신
      await load();
    };
  });
}

async function createNotification({ user_id, title, body, type, link }) {
  const { data:{ user } } = await supabase.auth.getUser();
  if (!user) return;

  const payload = {
    user_id,
    sender_id: user.id,
    title: s(title, '알림'),
    body:  s(body,  s(title, '내용 없음')),
    type:  s(type,  'info'),
    link:  link ?? null, // link는 NULL 허용
  };

  const { error } = await supabase.from('notifications').insert(payload);
  if (error) console.error('notify error:', error, payload);
}

// 실시간 반영
const ch = supabase.channel('bookings:mate')
  .on('postgres_changes',{event:'*',schema:'public',table:'bookings'}, ()=>load())
  .subscribe();

load();
</script>


</body>
</html>
