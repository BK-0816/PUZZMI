<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PUZZMI - ê²°ì œí•˜ê¸°</title>
  <link rel="stylesheet" href="payment_page.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ’³ ê²°ì œí•˜ê¸°</h1>

    <div class="info-box">
      <div class="info-row">
        <span class="info-label">ì˜ˆì•½ë²ˆí˜¸</span>
        <span class="info-value" id="booking_id">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">ì„œë¹„ìŠ¤ëª…</span>
        <span class="info-value" id="goodname">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">ê²°ì œê¸ˆì•¡</span>
        <span class="info-value" style="color: #4a90d9; font-size: 1.3rem;" id="price">-</span>
      </div>
    </div>

    <button type="button" class="btn-pay" id="payBtn" disabled>
      ğŸ”’ ì•ˆì „ê²°ì œ ì‹¤í–‰
    </button>

    <div class="secure-badge">
      âœ… í¬íŠ¸ì› ì•ˆì „ê²°ì œ
    </div>

    <div id="loading" style="text-align:center; margin-top:20px;">
      <p>ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <div id="error-message" style="display:none; margin-top:20px; padding:20px; background:#fee; border-radius:12px; color:#c00; text-align:center;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
  <script>
    var SUPABASE_URL = 'https://eevvgbbokenpjnvtmztk.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4';
    var STORE_ID = 'store-79c6a0c1-e7e2-486c-aa42-914242b9ff69';
    var CHANNEL_KEY = 'channel-key-104b9122-a3c5-4206-bb92-1235cc021587';
    var WEBHOOK_URL = 'https://eevvgbbokenpjnvtmztk.supabase.co/functions/v1/portone-webhook';

    var db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    var bookingData = null;

    function getPaymentToken() {
      var params = new URLSearchParams(window.location.search);
      return params.get('token');
    }

    function showError(message) {
      var errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('payBtn').disabled = true;
    }

    function loadPaymentInfo() {
      var token = getPaymentToken();
      if (!token) {
        showError('ê²°ì œ ë§í¬ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      db
        .from('bookings')
        .select('*')
        .eq('payment_token', token)
        .maybeSingle()
        .then(function(result) {
          var data = result.data;
          var error = result.error;

          if (error) {
            showError('ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return;
          }
          if (!data) {
            showError('ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          bookingData = data;

          if (data.payment_status === 'paid') {
            showError('ì´ë¯¸ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            return;
          }

          var hours = data.duration_hours || 0;
          var amount = data.total_amount || 0;
          var amountStr = 'Â¥' + amount.toLocaleString('ja-JP');
          var orderName = 'PUZZMI ãƒ¡ã‚¤ãƒˆäºˆç´„ (' + hours + 'æ™‚é–“)';

          document.getElementById('booking_id').textContent = '#' + data.id;
          document.getElementById('goodname').textContent = orderName;
          document.getElementById('price').textContent = amountStr;
          document.getElementById('loading').style.display = 'none';
          document.getElementById('payBtn').disabled = false;
        });
    }

    document.getElementById('payBtn').addEventListener('click', function() {
      if (!bookingData) {
        alert('ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      var btn = document.getElementById('payBtn');
      btn.disabled = true;
      btn.textContent = 'ê²°ì œ ì²˜ë¦¬ ì¤‘...';

      var timestamp = Date.now();
      var random = Math.random().toString(36).substring(2, 9);
      var paymentId = 'PUZZMI_' + timestamp + '_' + random;

      var hours = bookingData.duration_hours || 0;
      var orderName = 'PUZZMI ãƒ¡ã‚¤ãƒˆäºˆç´„ (' + hours + 'æ™‚é–“)';

      var insertData = {
        booking_id: bookingData.id,
        user_id: null,
        imp_uid: paymentId,
        merchant_uid: paymentId,
        amount: bookingData.total_amount,
        currency: 'JPY',
        status: 'ready',
        pg_provider: 'portone_v2_inicis',
        pay_method: 'CARD'
      };

      db
        .from('portone_payments')
        .insert(insertData)
        .then(function(insertResult) {
          if (insertResult.error) {
            console.error('ê²°ì œ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', insertResult.error);
          }

          var baseUrl = window.location.href.split('?')[0];
          var redirectUrl = baseUrl.replace('payment_page.html', 'payment_complete.html');

          var paymentParams = {
            storeId: STORE_ID,
            channelKey: CHANNEL_KEY,
            paymentId: paymentId,
            orderName: orderName,
            totalAmount: bookingData.total_amount,
            currency: 'CURRENCY_JPY',
            payMethod: 'CARD',
            customer: {
              fullName: bookingData.customer_name || 'Guest',
              firstNameKana: 'ã‚²ã‚¹ãƒˆ',
              lastNameKana: 'ã‚²ã‚¹ãƒˆ',
              phoneNumber: bookingData.customer_contact || '08000000000',
              email: 'guest@puzzmi.com'
            },
            storeDetails: {
              storeName: 'ãƒ‘ã‚ºãƒŸ',
              storeNameShort: 'ãƒ‘ã‚ºãƒŸ',
              storeNameEn: 'PUZZMI',
              storeNameKana: 'ãƒ‘ã‚ºãƒŸ',
              contactName: 'PUZZMI Support',
              email: 'puzzmi0721@gmail.com',
              phoneNumber: '0312345678',
              openingHours: {
                open: '09:00',
                close: '23:00'
              }
            },
            customData: JSON.stringify({
              booking_id: bookingData.id,
              user_id: bookingData.customer_id,
              mate_id: bookingData.mate_id
            }),
            redirectUrl: redirectUrl,
            noticeUrls: [WEBHOOK_URL]
          };

          return PortOne.requestPayment(paymentParams);
        })
        .then(function(response) {
          if (!response) return;

          if (response.code != null) {
            alert('ê²°ì œ ì‹¤íŒ¨: ' + (response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            btn.disabled = false;
            btn.textContent = 'ğŸ”’ ì•ˆì „ê²°ì œ ì‹¤í–‰';
            return;
          }

          var paidPaymentId = response.paymentId;
          var redirectTarget = window.location.href.split('?')[0].replace('payment_page.html', 'payment_complete.html');

          db
            .from('portone_payments')
            .select('status')
            .eq('imp_uid', paidPaymentId)
            .maybeSingle()
            .then(function(checkResult) {
              if (checkResult.data && checkResult.data.status === 'paid') {
                window.location.href = redirectTarget + '?booking_id=' + bookingData.id;
                return;
              }

              var channel = db.channel('payment-status-' + paidPaymentId);
              channel
                .on('postgres_changes', {
                  event: 'UPDATE',
                  schema: 'public',
                  table: 'portone_payments',
                  filter: 'imp_uid=eq.' + paidPaymentId
                }, function(payload) {
                  if (payload.new.status === 'paid') {
                    channel.unsubscribe();
                    window.location.href = redirectTarget + '?booking_id=' + bookingData.id;
                  } else if (payload.new.status === 'failed') {
                    channel.unsubscribe();
                    alert('ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    btn.disabled = false;
                    btn.textContent = 'ğŸ”’ ì•ˆì „ê²°ì œ ì‹¤í–‰';
                  }
                })
                .subscribe();

              setTimeout(function() {
                channel.unsubscribe();
                window.location.href = redirectTarget + '?booking_id=' + bookingData.id;
              }, 30000);
            });
        })
        .catch(function(error) {
          console.error('Payment error:', error);
          alert(error.message || 'ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          btn.disabled = false;
          btn.textContent = 'ğŸ”’ ì•ˆì „ê²°ì œ ì‹¤í–‰';
        });
    });

    window.addEventListener('DOMContentLoaded', loadPaymentInfo);
  </script>
</body>
</html>
