<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PUZZMI - お支払い</title>
  <link rel="stylesheet" href="payment_page.css">
</head>
<body>
  <div class="container">
    <h1>お支払い</h1>

    <div class="info-box">
      <div class="info-row">
        <span class="info-label">予約番号</span>
        <span class="info-value" id="booking_id">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">サービス内容</span>
        <span class="info-value" id="goodname">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">お支払い金額</span>
        <span class="info-value" style="color: #4a90d9; font-size: 1.3rem;" id="price">-</span>
      </div>
    </div>

    <button type="button" class="btn-pay" id="payBtn" disabled>
      安全決済を実行
    </button>

    <div class="secure-badge">
      PortOne 安全決済
    </div>

    <div id="loading" style="text-align:center; margin-top:20px;">
      <p>決済情報を読み込み中...</p>
    </div>

    <div id="error-message" style="display:none; margin-top:20px; padding:20px; background:#fee; border-radius:12px; color:#c00; text-align:center;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
  <script>
    var SUPABASE_URL = 'https://eevvgbbokenpjnvtmztk.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVldnZnYmJva2VucGpudnRtenRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjI2OTgsImV4cCI6MjA3MzEzODY5OH0.aLoqYYeDW_0ZEwkr8c8IPFvXnEwQPZah1mQzwiyG2Y4';
    var STORE_ID = 'store-79c6a0c1-e7e2-486c-aa42-914242b9ff69';
    var CHANNEL_KEY = 'channel-key-104b9122-a3c5-4206-bb92-1235cc021587';
    var WEBHOOK_URL = 'https://eevvgbbokenpjnvtmztk.supabase.co/functions/v1/portone-webhook';

    var db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    var bookingData = null;

    function getPaymentToken() {
      var params = new URLSearchParams(window.location.search);
      return params.get('token');
    }

    function showError(message) {
      var errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('payBtn').disabled = true;
    }

    function loadPaymentInfo() {
      var token = getPaymentToken();
      if (!token) {
        showError('決済リンクが正しくありません。');
        return;
      }

      db
        .from('bookings')
        .select('*')
        .eq('payment_token', token)
        .maybeSingle()
        .then(function(result) {
          var data = result.data;
          var error = result.error;

          if (error) {
            showError('決済情報の読み込みに失敗しました。');
            return;
          }
          if (!data) {
            showError('決済情報が見つかりません。');
            return;
          }

          bookingData = data;

          if (data.payment_status === 'paid') {
            showError('この予約はすでにお支払い済みです。');
            return;
          }

          if (data.customer_id) {
            db.from('profiles')
              .select('email, phone_number')
              .eq('id', data.customer_id)
              .maybeSingle()
              .then(function(profileResult) {
                if (profileResult.data) {
                  bookingData._email = profileResult.data.email || '';
                  bookingData._phone = profileResult.data.phone_number || '';
                }
              });
          }

          var hours = data.duration_hours || 0;
          var amount = data.total_amount || 0;
          var amountStr = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 }).format(amount);
          var orderName = 'PUZZMIメイト予約 (' + hours + '時間)';

          document.getElementById('booking_id').textContent = '#' + data.id;
          document.getElementById('goodname').textContent = orderName;
          document.getElementById('price').textContent = amountStr;
          document.getElementById('loading').style.display = 'none';
          document.getElementById('payBtn').disabled = false;
        });
    }

    document.getElementById('payBtn').addEventListener('click', function() {
      if (!bookingData) {
        alert('決済情報が読み込まれていません。');
        return;
      }

      var btn = document.getElementById('payBtn');
      btn.disabled = true;
      btn.textContent = '決済処理中...';

      var timestamp = Date.now();
      var random = Math.random().toString(36).substring(2, 9);
      var paymentId = 'PUZZMI_' + timestamp + '_' + random;

      var hours = bookingData.duration_hours || 0;
      var orderName = 'PUZZMIメイト予約 (' + hours + '時間)';

      var insertData = {
        booking_id: bookingData.id,
        user_id: null,
        imp_uid: paymentId,
        merchant_uid: paymentId,
        amount: bookingData.total_amount,
        currency: 'JPY',
        status: 'ready',
        pg_provider: 'portone_v2_inicis',
        pay_method: 'CARD'
      };

      db
        .from('portone_payments')
        .insert(insertData)
        .then(function(insertResult) {
          if (insertResult.error) {
            console.error('決済情報の保存失敗:', insertResult.error);
          }

          var baseUrl = window.location.href.split('?')[0];
          var redirectUrl = baseUrl.replace('payment_page.html', 'payment_complete.html');

          var customerPhone = (bookingData.customer_contact || bookingData._phone || '08000000000').replace(/[^0-9]/g, '');

          var paymentParams = {
            storeId: STORE_ID,
            channelKey: CHANNEL_KEY,
            paymentId: paymentId,
            orderName: orderName,
            totalAmount: bookingData.total_amount,
            currency: 'CURRENCY_JPY',
            payMethod: 'CARD',
            customer: {
              fullName: bookingData.customer_name || 'guest',
              phoneNumber: customerPhone,
              email: bookingData._email || 'guest@puzzmi.com'
            },
            storeDetails: {
              storeName: 'パズミ',
              storeNameShort: 'パズミ',
              storeNameEn: 'PUZZMI',
              storeNameKana: 'パズミ',
              contactName: 'PUZZMI',
              email: 'puzzmi0721@gmail.com',
              phoneNumber: '0312345678',
              openingHours: { open: '09:00', close: '23:00' }
            },
            customData: JSON.stringify({
              booking_id: bookingData.id,
              user_id: bookingData.customer_id,
              mate_id: bookingData.mate_id
            }),
            redirectUrl: redirectUrl,
            noticeUrls: [WEBHOOK_URL]
          };

          return PortOne.requestPayment(paymentParams);
        })
        .then(function(response) {
          if (!response) return;

          if (response.code != null) {
            alert('決済失敗: ' + (response.message || '不明なエラー'));
            btn.disabled = false;
            btn.textContent = '安全決済を実行';
            return;
          }

          var paidPaymentId = response.paymentId;
          var redirectTarget = window.location.href.split('?')[0].replace('payment_page.html', 'payment_complete.html');

          db
            .from('portone_payments')
            .select('status')
            .eq('imp_uid', paidPaymentId)
            .maybeSingle()
            .then(function(checkResult) {
              if (checkResult.data && checkResult.data.status === 'paid') {
                window.location.href = redirectTarget + '?paymentId=' + paidPaymentId;
                return;
              }

              var channel = db.channel('payment-status-' + paidPaymentId);
              channel
                .on('postgres_changes', {
                  event: 'UPDATE',
                  schema: 'public',
                  table: 'portone_payments',
                  filter: 'imp_uid=eq.' + paidPaymentId
                }, function(payload) {
                  if (payload.new.status === 'paid') {
                    channel.unsubscribe();
                    window.location.href = redirectTarget + '?paymentId=' + paidPaymentId;
                  } else if (payload.new.status === 'failed') {
                    channel.unsubscribe();
                    alert('決済に失敗しました。');
                    btn.disabled = false;
                    btn.textContent = '安全決済を実行';
                  }
                })
                .subscribe();

              setTimeout(function() {
                channel.unsubscribe();
                window.location.href = redirectTarget + '?paymentId=' + paidPaymentId;
              }, 30000);
            });
        })
        .catch(function(error) {
          console.error('Payment error:', error);
          alert(error.message || '決済に失敗しました。');
          btn.disabled = false;
          btn.textContent = '安全決済を実行';
        });
    });

    window.addEventListener('DOMContentLoaded', loadPaymentInfo);
  </script>
</body>
</html>
