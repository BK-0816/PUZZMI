<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUZZMI - 서울 렌탈친구 서비스</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;800&family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="nav.css"/>
    <script type="module" src="nav.js"></script>
</head>

<!-- Supabase JS v2 (ESM) -->
<script type="module">
  // nav.js의 싱글톤 supabase 재사용
  import { supabase } from "./nav.js";

  // ===== 1) 로그인 버튼 UI =====
  const loginBtn = document.querySelector(".login-btn");
  async function refreshAuthUI() {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      loginBtn.textContent = "로그아웃";
      loginBtn.onclick = async () => { await supabase.auth.signOut(); location.reload(); };
    } else {
      loginBtn.textContent = "로그인";
      loginBtn.onclick = () => {
        const redir = encodeURIComponent(location.pathname + location.search);
        location.href = `auth_combo.html?redirect=${redir}`;
      };
    }
  }

  // ===== 2) 메이트 목록 (페이지네이션) =====
  const ONLY_VERIFIED = false;
  const PAGE_SIZE     = 8;
  let page = 0, isLoading = false, hasMore = true;

  const grid = document.querySelector(".friends-grid");
  const loadMoreBtn = document.getElementById("loadMore");

  function keyToUrl(key) {
    if (!key) return "";
    if (/^https?:\/\//i.test(key)) return key;
    const pure = key.startsWith("mates/") ? key.replace(/^mates\//,"") : key;
    return supabase.storage.from("mates").getPublicUrl(pure).data.publicUrl;
  }

  function genderIcon(gender) {
    const g = (gender || "").toString().trim().toLowerCase();
    if (["female","f","여","여자","woman","여성"].includes(g)) return "♀";
    if (["male","m","남","남자","man","남성"].includes(g))   return "♂";
    return "⚧";
  }

  function renderCard(row) {
    const name   = row.profiles?.full_name ?? "이름 비공개";
    const age    = row.profiles?.age ? `${row.profiles.age}세` : "";
    const gender = row.profiles?.gender ?? "";
    const langs  = Array.isArray(row.profiles?.languages) ? row.profiles.languages : [];
    const gIcon  = genderIcon(gender);

    const keys   = Array.isArray(row.photos) ? row.photos : [];
    const cover  = row.primary_photo || keys[0] || row.profiles?.avatar_url || "https://picsum.photos/seed/puzzmi/400/300";
    const img    = /^https?:\/\//i.test(cover) ? cover : keyToUrl(cover);

    const priceJpy = new Intl.NumberFormat("ja-JP", { style: "currency", currency: "JPY", maximumFractionDigits: 0 }).format(4000);
    const tagsTxt  = (row.tags ?? []).slice(0,3).join(", ") || "서울 투어";
    const subline  = [gIcon, age].filter(Boolean).join(" • ");

    const favCount = Number(row.favorites_count ?? 0);

    const card = document.createElement("div");
    card.className = "friend-card";
    card.innerHTML = `
      <div class="friend-image">
        <img src="${img}" alt="${name}">
        <div class="heart-badge" data-heart="${row.user_id}" style="position:absolute;right:8px;top:8px;background:#e0245e;color:#fff;border-radius:16px;padding:4px 8px;font-size:12px;display:flex;gap:6px;align-items:center;">
          <i class="fas fa-heart"></i><span class="count">${favCount}</span>
        </div>
      </div>
      <div class="friend-info">
        <h3 class="friend-name">${name}</h3>
        <p class="friend-age">${subline || "정보 미기재"}</p>
        <p class="friend-specialties">${tagsTxt}</p>
        <p class="friend-description">${row.bio ?? "함께 서울의 숨은 명소를 즐겨봐요!"}</p>
        <div class="friend-languages">
          ${langs.map(l => `<span class="language">${l}</span>`).join("")}
        </div>
        <div class="friend-price">
          <span class="price">${priceJpy}</span><span class="duration">/시간</span>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px;">
          <a class="btn btn-secondary" data-requires-auth="true" href="mate_like.html?mate_id=${row.user_id}">프로필 보기</a>
          <a class="cta-btn"          data-requires-auth="true" href="booking.html?mate_id=${row.user_id}">예약하기</a>
          <button class="btn btn-secondary" data-fav-mate="${row.user_id}">찜하기</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  }

  async function loadMates({ reset=false } = {}) {
    if (!grid || isLoading || (!hasMore && !reset)) return;
    if (reset) { page = 0; hasMore = true; grid.innerHTML = ""; }

    isLoading = true;
    const from = page * PAGE_SIZE;
    const to   = from + PAGE_SIZE - 1;

    let query = supabase
      .from("mate_profiles")
      .select(`
        user_id, bio, hourly_rate, tags, areas, is_verified, rating, photos, primary_photo,
        profiles:profiles ( id, full_name, age, gender, languages, avatar_url )
      `, { count: "exact" })
      .order("rating", { ascending: false })
      .range(from, to);

    if (ONLY_VERIFIED) query = query.eq("is_verified", true);

    const { data, error, count } = await query;

    if (error) {
      console.error("loadMates error:", error);
      if (!grid.innerHTML) {
        grid.innerHTML = `<p style="padding:16px">메이트를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.</p>`;
      }
      loadMoreBtn && (loadMoreBtn.style.display = "none");
      isLoading = false;
      return;
    }

    (data || []).forEach(renderCard);

    const fetched = (data || []).length;
    const total   = typeof count === "number" ? count : (from + fetched);
    hasMore = (from + fetched) < total;

    if (loadMoreBtn) loadMoreBtn.style.display = hasMore ? "inline-block" : "none";
    if (hasMore) page += 1;

    isLoading = false;
  }

  loadMoreBtn?.addEventListener("click", () => loadMates());

  // ===== 3) 인증 가드 & 찜하기 =====
  document.addEventListener("click", async (e) => {
    // 로그인 필요한 링크
    const link = e.target.closest('a[data-requires-auth="true"]');
    if (link) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        e.preventDefault();
        const redir = encodeURIComponent(link.getAttribute("href"));
        location.href = `auth_combo.html?redirect=${redir}`;
        return;
      }
    }

    // 찜하기 버튼
    const favBtn = e.target.closest("[data-fav-mate]");
    if (favBtn) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        const redir = encodeURIComponent(location.pathname + location.search);
        return (location.href = `auth_combo.html?redirect=${redir}`);
      }
      const mateId = favBtn.getAttribute("data-fav-mate");
      const { error } = await supabase
        .from("favorites")
        .upsert({ user_id: user.id, mate_id: mateId }, { onConflict: "user_id,mate_id" });
      if (error) {
        alert("찜하기 실패: " + error.message);
      } else {
        // 하트 배지 카운트 갱신
        const { count } = await supabase
          .from('favorites')
          .select('id', { count: 'exact', head: true })
          .eq('mate_id', mateId);

        const badge = document.querySelector(`[data-heart="${mateId}"] .count`);
        if (badge && typeof count === 'number') badge.textContent = count;

        favBtn.disabled = true;
        favBtn.textContent = '찜 완료';
      }
    }
  });

  // ===== 4) 메인 리뷰 섹션: 별점 높은 순 → 글자수 긴 순 로드 =====
  async function loadTopReviews(limit=6){
    const box = document.getElementById('reviews-dynamic');
    if (!box) return;
    box.innerHTML = '<div class="muted">불러오는 중…</div>';

    const { data: rows, error } = await supabase
      .from('reviews')
      .select('id, mate_id, author_name, content, rating, created_at')
      .order('rating', { ascending: false })
      .limit(100);

    if (error) { box.innerHTML = `<div class="error">${error.message}</div>`; return; }
    if (!rows?.length) { box.innerHTML = '<div class="muted">아직 리뷰가 없습니다.</div>'; return; }

    const top = rows
      .sort((a,b)=> (b.content?.length||0)-(a.content?.length||0))
      .slice(0, limit);

    const ids = [...new Set(top.map(r=>r.mate_id).filter(Boolean))];
    const { data: mates } = await supabase
      .from('mate_profiles')
      .select('user_id, primary_photo, profiles(full_name)')
      .in('user_id', ids);

    const map = new Map((mates||[]).map(m => [m.user_id, m]));
    const star = n => '★'.repeat(n||0)+'☆'.repeat(5-(n||0));

    box.innerHTML = top.map(r=>{
      const m = map.get(r.mate_id);
      const name = m?.profiles?.full_name || '메이트';
      const imgKey = m?.primary_photo;
      const imgUrl = imgKey ? (supabase.storage.from('mates').getPublicUrl(imgKey.replace(/^mates\//,'')).data.publicUrl) : 'https://picsum.photos/seed/puzzmi/200/140';
      return `
        <div class="review-card">
          <div class="review-header">
            <div class="reviewer-info">
              <img src="${imgUrl}" alt="${name}" class="reviewer-avatar">
              <div>
                <h4 class="reviewer-name">${name}</h4>
                <p class="reviewer-location">${star(r.rating)}</p>
              </div>
            </div>
          </div>
          <p class="review-text">${(r.content||'').replace(/</g,'&lt;')}</p>
          <p class="review-date">${new Date(r.created_at).toLocaleDateString('ko-KR')}</p>
        </div>`;
    }).join('');
  }

  // 초기 실행
  (async () => {
    await refreshAuthUI();
    await loadMates({ reset: true });
    loadTopReviews();   // ★ 리뷰 섹션 로드
  })();
</script>

<body>
    <header class="header">
        <nav class="nav">
            <div class="container">
               <div class="nav-brand">
                  <img src="puzzmi_original.png" alt="PUZZMI 로고" class="logo">
                  <span>PUZZMI</span>
                  <div id="app-nav"></div>
               </div>

                <ul class="nav-menu">
                    <li><a href="#home" data-key="nav-home">홈</a></li>
                    <li><a href="#about" data-key="nav-about">서비스 소개</a></li>
                    <li><a href="#how-it-works" data-key="nav-how">이용방법</a></li>
                    <li><a href="#friends" data-key="nav-friends">메이트 예약</a></li>
                    <li><a href="#reviews" data-key="nav-reviews">후기</a></li>
                    <li><a href="#contact" data-key="nav-contact">FAQ</a></li>
                </ul>

                <div class="nav-actions">
                    <div class="language-selector">
                        <button class="lang-btn active" data-lang="ko">한국어</button>
                        <button class="lang-btn" data-lang="ja">日本語</button>
                        <button class="lang-btn" data-lang="en">English</button>
                    </div>
                    <button class="login-btn">로그인</button>
                </div>

                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- HERO -->
    <section id="home" class="hero">
        <div class="hero-bg"></div>
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title" data-key="hero-title">잊을 수 없는 추억을<br>당신께 선물합니다</h1>
                <p class="hero-subtitle" data-key="hero-subtitle">현지 친구와 함께 맛집, 핫플레이스, 숨겨진 명소까지!<br>추억의 퍼즐을 맞춰가세요</p>
            </div>
        </div>
    </section>

    <!-- ABOUT / SAFETY (생략 없이 기존 그대로 두셔도 됩니다) -->

    <!-- FRIENDS (메이트 목록) -->
    <section id="friends" class="friends">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title" data-key="friends-title">우리 친구들을 만나보세요</h2>
          <p class="section-subtitle" data-key="friends-subtitle">좋아하는 것도, 맛집도, 최신 트렌드도 다 얘기할 수 있는 친구와 함께!</p>
        </div>

        <div class="friend-filters">
          <button class="filter-btn active" data-filter="all" data-key="filter-all">전체</button>
        </div>

        <div class="friends-grid"></div>
        <div class="friends-actions" style="text-align:center; margin-top:12px;">
          <button id="loadMore" class="cta-btn" style="display:none">더 보기</button>
        </div>
      </div>
    </section>

    <!-- HOW IT WORKS (기존 그대로) -->

    <!-- REVIEWS: 동적 박스만 둡니다 -->
    <section id="reviews" class="reviews">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title" data-key="reviews-title">추억의 퍼즐을 맞춰보세요</h2>
          <p class="section-subtitle" data-key="reviews-subtitle">PUZZMI와 함께한 여행객들의 진솔한 이야기</p>
        </div>
        <div id="reviews-dynamic" class="reviews-grid"></div>
      </div>
    </section>

    <!-- CONTACT / FOOTER (기존 그대로) -->

    <script src="script.js"></script>
    <div class="floating-actions" aria-label="빠른 실행 버튼">
      <a href="https://instagram.com/puzzmi_official" target="_blank" class="floating-btn insta" aria-label="Instagram">
        <i class="fab fa-instagram" aria-hidden="true"></i><span>Instagram</span>
      </a>
      <a href="https://lin.ee/NbNPSUz" target="_blank" class="floating-btn line" aria-label="LINE">
        <i class="fab fa-line" aria-hidden="true"></i><span>LINE</span>
      </a>
      <a href="https://x.com/puzzmi19889" target="_blank" class="floating-btn x" aria-label="X (Twitter)">
        <i class="fa-brands fa-x-twitter" aria-hidden="true"></i><span>X</span>
      </a>
      <a href="#contact" class="floating-btn book" aria-label="예약하기">
        <i class="fas fa-calendar-check" aria-hidden="true"></i><span>예약하기</span>
      </a>
    </div>
</body>
</html>