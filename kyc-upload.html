<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>일본 KYC 업로드</title>
</head>
<body>
  <main style="max-width:560px;margin:24px auto;font-family:system-ui">
    <h2>일본 본인확인 (사전 제출)</h2>
    <p>여권 사본은 <b>단기 보관</b> 후 대면 실물 확인 시 즉시 파기합니다.</p>

  <form id="kycForm">
    <label>이름(여권과 동일)
      <input id="fullName" required />
    </label><br/><br/>
    <label>생년월일
      <input id="birthDate" type="date" required />
    </label><br/><br/>
    <label>여권 사진 (선택 1~2장)
      <input id="passportPhotos" type="file" accept="image/*" capture="environment" multiple />
    </label><br/><br/>
    <button type="submit">제출</button>
  </form>

  <div id="result" style="margin-top:16px"></div>
  </main>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase (ESM) -->
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const LIFF_ID = 'YOUR_LIFF_ID';
  const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
  const SUPABASE_ANON = 'YOUR_ANON_KEY';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  const EDGE_SUBMIT = `${SUPABASE_URL}/functions/v1/kyc-submit`;

  const $ = (id)=>document.getElementById(id);
  const resEl = $('result');

  function fileName(userId){
    // 간단 랜덤 파일명
    const rand = Math.random().toString(36).slice(2,10);
    return `${userId}/${Date.now()}_${rand}.jpg`;
  }

  async function boot(){
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }

    // (선택) LINE 프로필
    const prof = await liff.getProfile().catch(()=>null);

    // 앱 로그인(필요 시) — 이미 로그인 흐름이 있다면 생략
    let { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      // 당신 앱의 로그인 페이지로 이동(또는 OTP/매직링크)
      // location.href = '/auth_combo.html?redirect=' + encodeURIComponent(location.href);
      alert('앱 로그인 후 이용해주세요.');
      return;
    }

    $('kycForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      resEl.textContent = '업로드 중...';

      // 1) 자기기입 정보
      const fullName = $('fullName').value.trim();
      const birthDate = $('birthDate').value;

      // 2) 파일 업로드(선택)
      const files = $('passportPhotos').files;
      const uploaded = [];
      for (const f of files) {
        const path = fileName(user.id);
        const { error } = await supabase.storage.from('kyc-temp').upload(path, f, {
          upsert: false, cacheControl: 'no-store'
        });
        if (error) { resEl.textContent = '업로드 실패: ' + error.message; return; }
        uploaded.push(path);
      }

      // 3) 서버에 접수(메타 저장 & 삭제 스케줄)
      const { data: { session } } = await supabase.auth.getSession();
      const r = await fetch(EDGE_SUBMIT, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'Authorization': `Bearer ${session.access_token}`
        },
        body: JSON.stringify({
          fullName, birthDate,
          files: uploaded,        // ['<user_id>/xxx.jpg', ...]
          source: 'liff'
        })
      });
      const json = await r.json();
      if (!r.ok || !json.success) {
        resEl.textContent = '제출 실패: ' + (json.error || r.statusText);
        return;
      }

      resEl.textContent = '제출 완료! 대면 시 실물 여권으로 최종 확인합니다.';
      // (선택) LIFF 닫기
      // if (liff.isInClient()) liff.closeWindow();
    });
  }
  boot();
  </script>
</body>
</html>
